MathJax.Hub.Config({extensions:["tex2jax.js"],jax:["input/TeX","output/CommonHTML","output/SVG"],tex2jax:{inlineMath:[["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],preview:"none",processEscapes:!0},TeX:{extensions:["mhchem.js","color.js","AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]},SVG:{scale:120,minScaleAdjust:60},messageStyle:"none",skipStartupTypeset:!0}),MathJax.Hub.Configured();var mainApp=angular.module("mainApp",["ngMessages","ngResource","ngSanitize","ngAnimate","monospaced.elastic","ui.bootstrap.datetimepicker","dndLists","ngFileUpload","ui.tinymce","infinite-scroll","ui.bootstrap","angular-svg-round-progressbar","FBAngular","angularjs-crypto","chart.js","720kb.socialshare","vcRecaptcha"]);mainApp.config(["$interpolateProvider","$locationProvider",function(e,t){e.startSymbol("<%"),e.endSymbol("%>"),t.html5Mode({enabled:!0,requireBase:!1}),moment.locale("vi")}]),mainApp.controller("accountCtrl",["$scope","$window","HeaderService",function(e,t,n){var a=this;a.logout=function(){n.logout(function(){t.location.href="/"},function(){t.location.href="/"})}}]),mainApp.controller("confirmCreateExamCtrl",["$scope","$uibModalInstance","vcRecaptchaService","requiredCaptcha",function(e,t,n,a){var i=this;i.requiredCaptcha=a,i.recaptchaResponse=null,i.widgetId=null,i.createReCaptcha=function(e){i.message="",i.widgetId=e},i.successReCaptcha=function(){i.message=""},i.resetReCaptcha=function(){i.message="",i.recaptchaResponse=null,n.reload(i.widgetId)},i.cancel=function(){t.close({success:!1})},i.agree=function(){return i.requiredCaptcha&&null==i.recaptchaResponse?void(i.message="Vui lòng xác nhận captcha"):void t.close({success:!0,recaptchaResponse:i.recaptchaResponse})}}]),mainApp.controller("welcomeCtrl",["$scope","$timeout","$window","$uibModal",function(e,t,n,a){var i=this;i.createIcon=!1,i.demoIcon=!1,i.loggedIn=!1,i.activated=!1,i.requiredCaptcha=!1,i.init=function(e){i.loggedIn=e.loggedIn,i.activated=e.activated,i.requiredCaptcha=e.requiredCaptcha},i.searchExam=function(e){if(e){var t=i.query;n.location.href="/search?q="+t}},i.createExam=function(){if(!i.loggedIn)return void(i.createMessage="Bạn chưa đăng nhập");if(!i.activated)return void(i.createMessage="Tài khoản chưa được kích hoạt");var e=a.open({animation:!0,templateUrl:"confirmCreateExamModal.html",controller:"confirmCreateExamCtrl",controllerAs:"confirmCreateExamVm",keyboard:!0,resolve:{requiredCaptcha:function(){return i.requiredCaptcha}}});e.result.then(function(e){e.success&&(i.createIcon=!0,i.requiredCaptcha?n.location.href="/u/exam/create?g-recaptcha-response="+e.recaptchaResponse:n.location.href="/u/exam/create")})},i.reset=function(e){e.$setPristine(),e.$setUntouched()}}]),mainApp.directive("animatedIfEnterCallback",["$animate",function(e){return{restrict:"A",scope:{animatedIfEnterCallback:"&"},link:function(t,n,a){t.animatedIfEnterCallback=t.animatedIfEnterCallback||function(){},e.on("enter",n,function(e,n){"close"==n&&t.animatedIfEnterCallback()})}}}]),mainApp.directive("birthdate",function(){return{require:"ngModel",link:function(e,t,n,a){e.$watchCollection(n.birthdate,function(e){if(!(angular.isUndefined(e)||angular.isUndefined(e.day)||angular.isUndefined(e.month)||angular.isUndefined(e.year))){var t=parseInt(e.day),n=parseInt(e.month)-1,i=parseInt(e.year),s=(new Date).getFullYear(),r=new Date(i,n,t);r.getFullYear()==i&&r.getMonth()==n&&r.getDate()==t&&i>1900&&i<=s?(a.$setValidity("birthdate",!0),a.$setViewValue(i+"-"+(n+1)+"-"+t)):a.$setValidity("birthdate",!1)}})}}}),mainApp.directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,n,a){a.$validators.compareTo=function(t){return t==e.otherModelValue}}}}),mainApp.directive("convertToNumber",function(){return{require:"ngModel",link:function(e,t,n,a){a.$parsers.push(function(e){return parseInt(e,10)}),a.$formatters.push(function(e){return""+e})}}}),mainApp.directive("editableEquation",function(){var e=[],t=-1,n={init:function(n){e[0]={content:n.innerHTML,selected:{start:n.innerHTML.length,end:n.innerHTML.length}},t=0},keyIsAvailable:function(e){var t=["0","1","2","3","4","5","6","7","8","9"],n=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],a=[";","=",",","-",".","/","`","[","\\","]","'","<",">","?",":",'"',"|","{","}","_","+","~","!","@","#","$","%","^","&","*","(",")"],i=t.indexOf(e.key)!=-1||" "==e.key||"Delete"==e.key||"Del"==e.key||"Backspace"==e.key||n.indexOf(e.key)!=-1||a.indexOf(e.key)!=-1;return i&&"Control"!=e.key&&"Alt"!=e.key||"Paste"==e.key},keyIsDelete:function(e){return"Backspace"==e.key||"Delete"==e.key||"Del"==e.key},saveSelection:function(e){function t(e,o){if(3==e.nodeType){if(s||e!=o.startContainer||(a=n+o.startOffset,s=!0),s&&e==o.endContainer)throw i=n+o.endOffset,r;n+=e.length}else for(var c=0,u=e.childNodes.length;c<u;++c)t(e.childNodes[c],o)}var n=0,a=0,i=0,s=!1,r={},o=rangy.getSelection();if(o.rangeCount)try{t(e,o.getRangeAt(0))}catch(c){if(c!=r)throw c}return{start:a,end:i}},restoreSelection:function(e,t){function n(e){if(3==e.nodeType){var o=a+e.length;if(!s&&t.start>=a&&t.start<=o&&(i.setStart(e,t.start-a),s=!0),s&&t.end>=a&&t.end<=o)throw i.setEnd(e,t.end-a),r;a=o}else for(var c=0,u=e.childNodes.length;c<u;++c)n(e.childNodes[c])}var a=0,i=rangy.createRange(),s=!1,r={};i.collapseToPoint(e,0);try{n(e)}catch(o){if(o!=r)throw o;rangy.getSelection().setSingleRange(i)}},formatText:function(a){var i=n.saveSelection(a),s={};s.content=a.innerHTML,a.innerHTML=a.innerHTML.replace(/<span[\s\S]*?>([\s\S]*?)<\/span>/g,"$1"),a.innerHTML=a.innerHTML.replace(/<font[\s\S]*?>([\s\S]*?)<\/font>/g,"$1"),a.innerHTML=a.innerHTML.replace(/<b>([\s\S]*?)<\/b>/g,"$1"),a.innerHTML=a.innerHTML.replace(/\\(?:[^a-zA-Z]|[a-zA-Z]+[*=']?)/g,function(e){return'<span class="cq-math-texCommand">'+e+"</span>"}),s.selected=i,t>50?e.shift():t++,e[t]=s,n.restoreSelection(a,i)},undoText:function(a){t>0&&(t--,a.innerHTML=e[t].content,n.restoreSelection(a,e[t].selected))},redoText:function(a){"undefined"!=typeof e[t+1]&&(t++,a.innerHTML=e[t].content,n.restoreSelection(a,e[t].selected))}};return{restrict:"A",require:"ngModel",scope:{equation:"="},link:function(a,i,s,r){function o(){var e=i.text();r.$setViewValue(e)}if(r){r.$render=function(){var e=r.$viewValue;e&&(i.html(e),n.init(i[0]))},i.on("blur",function(){a.$evalAsync(o)});var c=null,u=!1;i.on("keyup",function(s){n.keyIsAvailable(s)?(u=!1,n.formatText(i[0])):"Undo"==s.key?(u=!1,n.undoText(i[0])):"Redo"==s.key?(u=!1,n.redoText(i[0])):"Enter"==s.key?(u=!1,t++,e[t]={content:i[0].innerHTML,selected:c}):"ArrowLeft"!=s.key&&"ArrowUp"!=s.key&&"ArrowRight"!=s.key&&"ArrowDown"!=s.key&&"Left"!=s.key&&"Up"!=s.key&&"Right"!=s.key&&"Down"!=s.key||(c=n.saveSelection(i[0]),0==u&&(u=!0,t++,e[t]={content:i[0].innerHTML,selected:c})),n.keyIsDelete&&""==i.text()&&i.html(""),a.$evalAsync(o)}),i.on("change",function(e){n.formatText(i[0]),a.$evalAsync(o)}),r.$render()}}}}),mainApp.directive("editableGrade",function(){return{restrict:"A",require:"ngModel",scope:{grade:"="},link:function(e,t,n,a){function i(){var n,i=t.html();isNaN(i)?n=e.grade:(n=parseFloat(i),n=Math.round(100*n)/100,(n<0||n>=1e3)&&(n=e.grade)),a.$setViewValue(n),a.$render()}a&&(a.$render=function(){t.html(parseFloat(a.$viewValue))},t.on("blur",function(){e.$evalAsync(i)}),t.on("keydown",function(e){if("Enter"==e.key)return $(this).closest("li").find("input").first().focus(),void e.preventDefault();var t=["0","1","2","3","4","5","6","7","8","9"];"Backspace"!=e.key&&"Tab"!=e.key&&"Escape"!=e.key&&"End"!=e.key&&"Home"!=e.key&&"ArrowLeft"!=e.key&&"ArrowRight"!=e.key&&"Delete"!=e.key&&"."!=e.key&&"Esc"!=e.key&&"Left"!=e.key&&"Right"!=e.key&&"Del"!=e.key&&t.indexOf(e.key)==-1&&e.preventDefault()}),a.$render())}}}),mainApp.directive("editableTimer",function(){return{restrict:"A",require:"ngModel",scope:{timer:"="},link:function(e,t,n,a){function i(){var n=t.html(),i=/(\d{1,2}h)?(\d{1,3}')?(\d{1,3}")?/i,s=i.exec(n),r=0;null==s||s[0]!=s.input?r=e.timer:(angular.isDefined(s[1])&&(r+=3600*parseInt(s[1])),angular.isDefined(s[2])&&(r+=60*parseInt(s[2])),angular.isDefined(s[3])&&(angular.isDefined(s[1])&&angular.isUndefined(s[2])?r=e.timer:r+=parseInt(s[3]))),a.$setViewValue(r),a.$render()}a&&(a.$render=function(){var e=parseInt(a.$viewValue);if(isNaN(e))return void t.html("");var n=Math.floor(e/3600),i=e%3600,s=Math.floor(i/60),r=i%60,o="";n>0&&(o+=n+"h"),(s>0||n>0&&r>0)&&(o+=s+"'"),(r>0||0==n&&0==s)&&(o+=r+'"'),t.html(o)},t.on("blur",function(){e.$evalAsync(i)}),t.on("keydown",function(e){if("Enter"==e.key)return $(this).closest("li").find("input").first().focus(),void e.preventDefault();var t=["0","1","2","3","4","5","6","7","8","9"];"Backspace"!=e.key&&"Tab"!=e.key&&"Escape"!=e.key&&"End"!=e.key&&"Home"!=e.key&&"ArrowLeft"!=e.key&&"ArrowRight"!=e.key&&"Delete"!=e.key&&"h"!=e.key&&"'"!=e.key&&'"'!=e.key&&"Esc"!=e.key&&"Left"!=e.key&&"Right"!=e.key&&"Del"!=e.key&&t.indexOf(e.key)==-1&&e.preventDefault()}),a.$render())}}}),mainApp.directive("flippy",function(){return{restrict:"E",scope:{flip:"=",flipBack:"=",duration:"@",timingFunction:"@"},link:function(e,t,n){function a(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];(!e&&!o.flipped||e&&o.flipped)&&setTimeout(function(){t.toggleClass("flipped"),o.flipped=!o.flipped},0)}function i(){a()}function s(){a(!0)}const r="custom:",o={flipped:!1},c={duration:400,timingFunction:"ease-in-out"};angular.forEach(["duration","timingFunction"],function(t){c[t]=e.item?e.item:c[t]}),angular.forEach({flip:i,flipBack:s},function(n,a){angular.forEach(e[a],function(a){a.indexOf(r)===-1?angular.element(t)[0].addEventListener(a,n):e.$on(a.substr(r.length),n)})}),angular.forEach(["flippy-front","flippy-back"],function(e){const n=t.find(e);1==n.length&&angular.forEach(["","-ms-","-webkit-"],function(e){angular.element(n[0]).css(e+"transition","all "+c.duration/1e3+"s "+c.timingFunction)})})}}}),mainApp.directive("gradeDistribution",function(){return{restrict:"A",link:function(e,t,n){t.on("contextmenu",function(e){e.preventDefault()})}}}),mainApp.directive("keypressEvents",["$document","$rootScope",function(e,t){return{restrict:"A",link:function(n,a,i){e.bind("keydown",function(e){t.$broadcast("keydown",e)}),e.bind("keyup",function(e){t.$broadcast("keyup",e)})}}}]),mainApp.directive("linkDisabled",function(){return{restrict:"A",scope:{linkDisabled:"=linkDisabled"},link:function(e,t,n){t.bind("click",function(t){e.linkDisabled&&t.preventDefault()})}}}),mainApp.directive("mathjaxBind",function(){return{restrict:"A",controller:["$scope","$element","$attrs",function(e,t,n){e.$watch(n.mathjaxBind,function(n){var a=e.mathtypeVm.blockDisplay?"'math/tex; mode=display'":"'math/tex'",i=angular.element("<script type="+a+" >").html(void 0==n?"":n);t.html(""),t.append(i),MathJax.Hub.Queue(["Reprocess",MathJax.Hub,t[0]])})}]}}),mainApp.factory("ngClipboard",["$compile","$rootScope","$document",function(e,t,n){return{toClipboard:function(a){var i=angular.element('<span id="ngClipboardCopyId">'+a+"</span>"),s=n.find("body").eq(0);s.append(e(i)(t));var r=angular.element(document.getElementById("ngClipboardCopyId")),o=document.createRange();o.selectNode(r[0]),window.getSelection().removeAllRanges(),window.getSelection().addRange(o);document.execCommand("copy");window.getSelection().removeAllRanges(),i.remove()}}}]).directive("ngCopyable",function(){function e(e,t,n){t.bind("click",function(){var e=document.createRange();e.selectNode(t[0]),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),window.getSelection().removeAllRanges()})}return{restrict:"A",link:e}}),mainApp.directive("ngRepeatFinished",["$timeout",function(e){return{restrict:"A",link:function(t,n,a){t.$last&&e(function(){t.$eval(a.ngRepeatFinished)},0)}}}]),mainApp.directive("onlyDigits",function(){return{restrict:"A",require:"ngModel",scope:!0,link:function(e,t,n,a){a.$parsers.push(function(e){if(angular.isUndefined(e)||null==e)return null;"number"==typeof e&&(e=e.toString());var t=e.replace(/[^0-9]/g,"").replace(/^0+/g,"");return t!=e&&(""==t&&(t="0"),a.$setViewValue(parseInt(t)),a.$render()),parseInt(t)}),t.bind("keydown",function(e){var t=["0","1","2","3","4","5","6","7","8","9"];"Backspace"!=e.key&&"Tab"!=e.key&&"ArrowLeft"!=e.key&&"ArrowRight"!=e.key&&"Delete"!=e.key&&"Home"!=e.key&&"End"!=e.key&&"Left"!=e.key&&"Right"!=e.key&&t.indexOf(e.key)==-1&&e.preventDefault()})}}}),mainApp.filter("parseDate",function(){return function(e){return null==e?"":moment(e,"YYYY-MM-DD H:m:s").toDate()}}),mainApp.directive("preventSpace",function(){return{restrict:"A",scope:!0,link:function(e,t,n){t.on("keydown",function(e){" "==e.key&&e.preventDefault()})}}}),mainApp.directive("processMathjax",["$timeout",function(e){return{restrict:"A",link:function(t,n,a){t.$last&&e(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub])},0)}}}]),mainApp.directive("refreshMathjax",["$timeout",function(e){return{restrict:"A",link:function(t,n,a){e(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){a.refreshMathjax&&t.$eval(a.refreshMathjax)})})}}}]),mainApp.directive("scrollDrag",function(){return{restrict:"A",scope:!0,link:function(e,t,n){t.on("drag",function(t){e.detailVm.stopScroll=!0,t.originalEvent.clientY<150&&(e.detailVm.stopScroll=!1,a(-1)),t.originalEvent.clientY>$(window).height()-150&&(e.detailVm.stopScroll=!1,a(1))}),t.on("dragend",function(t){e.detailVm.stopScroll=!0});var a=function(t){var n=$(window).scrollTop();$(window).scrollTop(n+t),e.detailVm.stopScroll||setTimeout(function(){a(t)},20)}}}}),mainApp.directive("selectOnClick",["$window",function(e){return{restrict:"A",link:function(t,n,a){n.on("click",function(){e.getSelection().toString()||this.setSelectionRange(0,this.value.length)})}}}]),mainApp.directive("starRating",function(){return{scope:{rating:"=",maxRating:"@",readOnly:"@",size:"@",click:"&",mouseHover:"&",mouseLeave:"&"},restrict:"AE",template:"<div class='d-inline-block' style='cursor:pointer;'                     ng-repeat='idx in maxRatings track by $index'>                     <div ng-click='isolatedClick($index + 1)'                     ng-mouseenter='isolatedMouseHover($index + 1)'                     ng-mouseleave='isolatedMouseLeave($index + 1)'>                        <i class='fa fa-star-o' ng-class='<%size%>' ng-if='(hoverValue + rating) <= $index' aria-hidden='true'></i>                        <i class='fa fa-star' ng-class='<%size%>' ng-if='(hoverValue + rating) > $index' aria-hidden='true'></i>                    </div>            </div>",compile:function(e,t){(!t.maxRating||Number(t.maxRating)<=0)&&(t.maxRating="5")},controller:["$scope","$element","$attrs",function(e,t,n){e.maxRatings=[];for(var a=1;a<=e.maxRating;a++)e.maxRatings.push({});e.hoverValue=0,e.beginHover=!0,e.isolatedClick=function(t){"true"!=e.readOnly&&(e.rating=t,e.reserveRating=t,e.hoverValue=0,e.click({param:t}))},e.isolatedMouseHover=function(t){"true"!=e.readOnly&&(e.beginHover&&(e.reserveRating=e.rating,e.beginHover=!1),e.rating=0,e.hoverValue=t,e.mouseHover({param:t}))},e.isolatedMouseLeave=function(t){"true"!=e.readOnly&&(e.beginHover=!0,e.rating=e.reserveRating,e.hoverValue=0,e.mouseLeave({param:t}))}}]}}),mainApp.directive("tooltip",function(){return{restrict:"A",scope:!0,link:function(e,t,n){$(t).hover(function(){$(this).tooltip("dispose"),$(this).tooltip("show")},function(){$(this).tooltip("dispose"),$(this).tooltip("hide")}),t.bind("$destroy",function(){$(this).tooltip("dispose")})}}}),mainApp.filter("currency",["$filter",function(e){return function(e){return e=parseFloat(e),e=e%1===0?e.toFixed(0):e.toFixed(2),e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}}]),mainApp.filter("html",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),mainApp.directive("preventEnter",function(){return{restrict:"A",scope:!0,link:function(e,t,n){t.on("keydown",function(e){"Enter"==e.key&&e.preventDefault()})}}}),mainApp.filter("characters",function(){return function(e,t,n){if(isNaN(t))return e;if(t<=0)return"";if(e&&e.length>t){if(e=e.substring(0,t),n)for(;" "===e.charAt(e.length-1);)e=e.substr(0,e.length-1);else{var a=e.lastIndexOf(" ");a!==-1&&(e=e.substr(0,a))}return e+"…"}return e}}),mainApp.filter("splitcharacters",function(){return function(e,t){if(isNaN(t))return e;if(t<=0)return"";if(e&&e.length>t){var n=e.substring(0,t/2),a=e.substring(e.length-t/2,e.length);return n+"..."+a}return e}}),mainApp.filter("words",function(){return function(e,t){if(isNaN(t))return e;if(t<=0)return"";if(e){var n=e.split(/\s+/);n.length>t&&(e=n.slice(0,t).join(" ")+"…")}return e}}),mainApp.factory("AnswerService",["$resource",function(e){return e("/u/exam/:examId/question/:questionId/answer/:answerId",{examId:"@examId",questionId:"@questionId",answerId:"@answerId"},{update:{method:"PUT"},updatePosition:{method:"PUT",url:"/u/exam/:examId/question/:questionId/answer/position",params:{examId:"@examId",questionId:"@questionId"}},updateCorrectAnswer:{method:"PUT",url:"/u/exam/:examId/question/:questionId/answer/:answerId/correct",params:{examId:"@examId",questionId:"@questionId",answerId:"@answerId"}}})}]),mainApp.factory("CertificateService",["$resource",function(e){return e("/u/exam/:id/dashboard",{id:"@id"},{print:{method:"GET",url:"/u/exam/:id/dashboard/certificate-print",params:{id:"@id"}}})}]),mainApp.factory("CoinService",["$resource",function(e){return e("/u/coin",null,{verifyPassword:{method:"POST",url:"/u/coin/withdraw/verify/password"},verifyCode:{method:"POST",url:"/u/coin/withdraw/verify/code"},withdraw:{method:"POST",url:"/u/coin/withdraw/do"},cancelWithdraw:{method:"POST",url:"/u/coin/withdraw/cancel"},loadTransactions:{method:"GET",url:"/u/coin/transaction-history?start=:start&end=:end&page=:page",params:{start:"@start",end:"@end",page:"@page"},cancellable:!0},loadVoucherList:{method:"GET",url:"/u/coin/voucher/list",cancellable:!0},verifyPasswordVoucher:{method:"POST",url:"/u/coin/voucher/verify/password"},verifyCodeWithCreateVoucher:{method:"POST",url:"/u/coin/voucher/verify/code/create"},activateVoucher:{method:"POST",url:"/u/coin/voucher/activate"},doAtmBankPayment:{method:"POST",url:"/u/coin/topup/atm-banking"},doIBankPayment:{method:"POST",url:"/u/coin/topup/internet-banking"},doCreditCardPayment:{method:"POST",url:"/u/coin/topup/credit-card"},doScratchcardPayment:{method:"POST",url:"/u/coin/topup/scratchcard"}})}]),mainApp.factory("CommentService",["$resource",function(e){return e("/u/comment",null,{send:{method:"POST",url:"/u/comment"}})}]),mainApp.factory("DashboardService",["$resource",function(e){return e("/u/exam/:id/dashboard",{id:"@id"},{loadQuestion:{method:"GET",url:"/u/exam/:id/dashboard/questions",params:{id:"@id"}},loadLeaderBoard:{method:"GET",url:"/u/exam/:id/dashboard/leader-board/load",params:{id:"@id"},cancellable:!0},loadMoreStudent:{method:"GET",url:"/u/exam/:id/dashboard/leader-board/more?page=:page",params:{id:"@id",page:"@page"}},helpExamAgain:{method:"GET",url:"/u/exam/:examId/help/:type",params:{examId:"@examId",type:"@type"},cancellable:!0},prepareAnswer:{method:"GET",url:"/u/exam/:id/dashboard/prepare-answers",params:{id:"@id"}},synchronizeExam:{method:"GET",url:"/u/exam/:id/dashboard/synchronize-exam",params:{id:"@id"}}})}]),mainApp.service("displayHtmlService",["$sce",function(e){this.renderHtml=function(t){return null==t?"":e.trustAsHtml(t)}}]),mainApp.factory("ExamService",["$resource",function(e){return e("/u/exam/:id",{id:"@id"},{update:{method:"PUT"},getSettings:{method:"GET",url:"/u/exam/:id/settings",params:{id:"@id"}},tryToDoExam:{method:"GET",url:"/u/exam/:id/try",params:{id:"@id"}}})}]),mainApp.factory("HeaderService",["$resource",function(e){return e("/",null,{logout:{method:"POST",url:"/logout"}})}]),mainApp.factory("HomeService",["$resource",function(e){return e("/u/home/0",null,{loadCreation:{method:"GET",url:"/u/home/creation/load?page=:page",params:{page:"@page"},cancellable:!0},searchCreation:{method:"GET",url:"/u/home/creation/search?query=:query&type=:type&page=:page",params:{query:"@query",type:"@type",page:"@page"},cancellable:!0},loadAction:{method:"GET",url:"/u/home/action/load?page=:page",params:{page:"@page"},cancellable:!0},searchAction:{method:"GET",url:"/u/home/action/search?query=:query&type=:type&page=:page",params:{query:"@query",type:"@type",page:"@page"},cancellable:!0},loadExamsInMonth:{method:"GET",url:"/u/home/exams/:month/:year",params:{month:"@month",year:"@year"},cancellable:!0},deleteExam:{method:"POST",url:"/u/home/exam/:id/delete",params:{id:"@id"}}})}]),mainApp.factory("ImageService",["$resource",function(e){return e("/u/image/exam/:examId",{examId:"@examId"},{update:{method:"PUT"}})}]),mainApp.factory("InformationService",["$resource",function(e){return e("/exam/:id/information",{id:"@id"},{socialCount:{method:"GET",url:"/exam/:id/information/social-counts",params:{id:"@id"},cancellable:!0},rating:{method:"GET",url:"/u/exam/:id/dashboard/rating",params:{id:"@id"},cancellable:!0},updateVotePoint:{method:"PUT",url:"/u/exam/:id/dashboard/vote-point",params:{id:"@id"}},updateComment:{method:"PUT",url:"/u/exam/:id/dashboard/info",params:{id:"@id"}},loadSameCreatorExam:{method:"GET",url:"/exam/:id/information/same-creator/:creatorId?page=:page",params:{id:"@id",creatorId:"@creatorId",page:"@page"},cancellable:!0},loadSimilarExam:{method:"GET",url:"/exam/:id/information/similar-exam?q=:q",params:{id:"@id",q:"@q"},cancellable:!0},access:{method:"POST",url:"/u/exam/:id/dashboard/access",params:{id:"@id"}},requestVerification:{method:"POST",url:"/u/exam/:id/dashboard/verification",params:{id:"@id"}},verifyCode:{method:"POST",url:"/u/exam/:id/dashboard/verify-code",params:{id:"@id"}}})}]),mainApp.factory("LeaderBoardService",["$resource",function(e){return e("/u/exam/:id/dashboard",{id:"@id"},{loadLeaderBoard:{method:"GET",url:"/u/exam/:id/dashboard/leader-board/load",params:{id:"@id"},cancellable:!0},loadMoreStudent:{method:"GET",url:"/u/exam/:id/dashboard/leader-board/more?page=:page",params:{id:"@id",page:"@page"},cancellable:!0}})}]),mainApp.factory("PasswordService",["$resource",function(e){return e("/password/change",null,{})}]),mainApp.factory("PrintingService",["$resource",function(e){return e("/u/exam/:id/printing",{id:"@id"},{update:{method:"PUT"},pay:{method:"GET",url:"/u/exam/:id/printing/pay",params:{id:"@id"}},getSettings:{method:"GET",url:"/u/exam/:id/printing/settings",params:{id:"@id"}},exportPdf:{method:"GET",url:"/u/exam/:id/printing/export-pdf",params:{id:"@id"}},printPDF:{method:"GET",headers:{accept:"application/pdf"},responseType:"arraybuffer",cache:!0,transformResponse:function(e,t){var n;e&&(n=new Blob([e],{type:"application/pdf"}));var a,i="filename.pdf",s=t("content-disposition");return s&&(a=s.split(";")[1].trim().split("=")[1],i=a.replace(/"/g,"")),a={blob:n,fileName:i},{response:a}},url:"/u/exam/:id/print-pdf",params:{id:"@id"}}})}]),mainApp.factory("ProfileService",["$resource",function(e){return e("/u/profile/edit",null,{vote:{method:"POST",url:"/profile/vote/:userId",params:{userId:"@userId"}},verifyPassword:{method:"POST",url:"/u/profile/verify/password"},verifyCode:{method:"POST",url:"/u/profile/verify/code"},sendActivateEmail:{method:"POST",url:"/u/profile/activate/email"},activate:{method:"GET",url:"/activate/email?e=:e&code=:code&ajax=true",params:{e:"@e",code:"@code"}}})}]),mainApp.factory("QuestionService",["$resource",function(e){return e("/u/exam/:examId/section/:sectionId/question/:questionId",{examId:"@examId",sectionId:"@sectionId",questionId:"@questionId"},{update:{method:"PUT"},updatePosition:{method:"PUT",url:"/u/exam/:examId/section/:sectionId/question/position",params:{examId:"@examId",sectionId:"@sectionId"}},updateType:{method:"PUT",url:"/u/exam/:examId/section/:sectionId/question/:questionId/type",params:{examId:"@examId",sectionId:"@sectionId",questionId:"@questionId"}}})}]),mainApp.factory("RegisterService",["$resource",function(e){return e("/",null,{verifyEmail:{method:"POST",url:"/verifyEmail"},register:{method:"POST",url:"/register"}})}]),mainApp.factory("RunService",["$resource",function(e){return e("/u/exam/:examId/run/question/:questionId",{examId:"@examId",questionId:"@questionId"},{getTime:{method:"GET",url:"http://www.timeapi.org/utc/now"},updateAnswers:{method:"PUT",url:"/u/exam/:examId/run/question/:questionId/update-answers",params:{examId:"@examId",questionId:"@questionId"}},helpQuestion:{method:"GET",url:"/u/exam/:examId/run/question/:questionId/help/:type",params:{examId:"@examId",questionId:"@questionId",type:"@type"},cancellable:!0},closeQuestion:{method:"POST",url:"/u/exam/:examId/run/question/:questionId/close",params:{examId:"@examId",questionId:"@questionId"}},getQuestionsStatus:{method:"GET",url:"/u/exam/:examId/run/questions-status",params:{examId:"@examId"}},preLoadQuestion:{method:"GET",url:"/u/exam/:examId/run/question/:questionId/pre-load",params:{examId:"@examId",questionId:"@questionId"},cancellable:!0},decryptQuestion:{method:"POST",url:"/u/exam/:examId/run/question/:questionId/decrypt",params:{examId:"@examId",questionId:"@questionId"}},loadQuestion:{method:"GET",url:"/u/exam/:examId/run/question/:questionId/load",params:{examId:"@examId",questionId:"@questionId"},cancellable:!0},loadAllQuestion:{method:"GET",url:"/u/exam/:examId/run/question/:beginOrder/load-all",params:{examId:"@examId",beginOrder:"@beginOrder"},cancellable:!0},finishExam:{method:"PUT",url:"/u/exam/:examId/run/question/finish-exam",params:{examId:"@examId"}}})}]),mainApp.factory("SearchService",["$resource",function(e){return e("/search",null,{})}]),mainApp.factory("SectionService",["$resource",function(e){return e("/u/exam/:examId/section/:sectionId",{examId:"@examId",sectionId:"@sectionId"},{get:{method:"GET",headers:{"Cache-Control":"no-cache"},cache:!1},update:{method:"PUT"},updatePosition:{method:"PUT",url:"/u/exam/:examId/section/position",params:{examId:"@examId"}}})}]),mainApp.factory("StatisticService",["$resource",function(e){return e("/u/exam/:examId/statistic",{examId:"@examId"},{loadExamContent:{method:"GET",url:"/u/exam/:examId/statistic/exam-content",params:{examId:"@examId"},cancellable:!0},loadUsersData:{method:"GET",url:"/u/exam/:examId/statistic/users-data?page=:page",params:{examId:"@examId",page:"@page"},cancellable:!0},analysis:{method:"GET",url:"/u/exam/:examId/statistic/analysis",params:{examId:"@examId"}},updateMark:{method:"POST",url:"/u/exam/:examId/statistic/update-mark",params:{examId:"@examId"}},exportStatistics:{method:"POST",url:"/u/exam/:examId/statistic/export",params:{examId:"@examId"},cancellable:!0},loadUserDetail:{method:"GET",url:"/u/exam/:examId/statistic/detail/:userId",params:{examId:"@examId",userId:"@userId"},cancellable:!0},deleteUserExam:{method:"POST",url:"/u/exam/:examId/statistic/delete/:userId",params:{examId:"@examId",userId:"@userId"}},refreshUserExam:{method:"POST",url:"/u/exam/:examId/statistic/refresh/:userId",params:{examId:"@examId",userId:"@userId"}},terminateUserExam:{method:"POST",url:"/u/exam/:examId/statistic/terminate/:userId",params:{examId:"@examId",userId:"@userId"}},deleteAllUserExam:{method:"POST",url:"/u/exam/:examId/statistic/delete-all",params:{examId:"@examId"}}})}]),mainApp.controller("loginCtrl",["$scope",function(e){var t=this;t.init=function(e){t.email=e.email}}]),mainApp.controller("passwordChangeCtrl",["$scope","$timeout","$window","PasswordService",function(e,t,n,a){var i=this;i.message="",i.successMessage="",i.changing=!1,i.init=function(e){i.email=e.email},i.changePassword=function(e){if(e){i.changing=!0,i.message="Đang thực hiện cập nhật lại mật khẩu...";var s={email:i.email,currentPassword:i.currentPassword,password:i.password,password_confirmation:i.password_confirmation};a.save({},s,function(e){e.success?(i.message="",i.successMessage="Mật khẩu đã được cập nhật thành công. Hệ thống đang quay lại trang chủ...",t(function(){n.location.href="/"},3e3)):(i.message=e.message,i.changing=!1)},function(e){i.message="Vui lòng kiểm tra lại thông tin đã nhập...",i.changing=!1})}}}]),mainApp.controller("passwordEmailCtrl",["$scope",function(e){var t=this;t.sending=!1,t.submitEmail=function(e){e&&(t.sending=!0)}}]),mainApp.controller("passwordResetCtrl",["$scope",function(e){var t=this;t.resetting=!1,t.resetPassword=function(e){e&&(t.resetting=!0)}}]),mainApp.controller("registerCtrl",["$scope","$window","RegisterService",function(e,t,n){var a=this;a.birth={},a.months=["Tháng 1","Tháng 2","Tháng 3","Tháng 4","Tháng 5","Tháng 6","Tháng 7","Tháng 8","Tháng 9","Tháng 10","Tháng 11","Tháng 12"],a.showPass=!1,a.showPassStyle={},a.displayPassword=function(e){var t=angular.element(document.querySelector(".cq-password-input"));e?(a.showPassStyle={"background-color":"lightgrey"},t.attr("type","text")):(a.showPassStyle={},t.attr("type","password"))},a.clearEmailError=function(){e.registerForm.email.$setValidity("required",!0),e.registerForm.email.$setValidity("email",!0),e.registerForm.email.$setValidity("maxlength",!0),e.registerForm.email.$setValidity("conflict",!0)},a.verifyEmail=function(t){if(!(angular.isDefined(t.required)||angular.isDefined(t.email)||angular.isDefined(t.maxlength))){var i=new n;i.email=a.email,e.registerForm.email.$setValidity("conflict",!0),i.$verifyEmail(function(t){e.registerForm.email.$setValidity("conflict",!t.exist)},function(e){})}},a.clearPasswordError=function(){e.registerForm.password.$setValidity("required",!0),e.registerForm.password.$setValidity("minlength",!0),e.registerForm.password.$setValidity("maxlength",!0)},a.submitting=!1,a.registerSubmit=function(e){if(e){var i=new n;i.firstname=a.firstname,i.lastname=a.lastname,i.email=a.email,i.password=a.password,i.dateOfBirth=a.birth.year+"-"+a.birth.month+"-"+a.birth.day,i.agree=a.agree,a.submitting=!0,i.$register(function(e){e.success?t.location.href=e.redirect:a.message=e.message,a.submitting=!1},function(e){a.message="Không đăng kí được",a.submitting=!1})}}}]),mainApp.controller("coinManagerCtrl",["$scope","$timeout","$location","$window","$uibModal","CoinService",function(e,t,n,a,i,s){var r=this;r.init=function(e){switch(n.hash()){case"introduction":r.viewTab="introduction";break;case"topup":r.viewTab="topup";break;case"withdraw":r.viewTab="withdraw";break;case"history":r.viewTab="history";break;case"voucher_new":r.viewTab="voucher_new";break;case"voucher_use":r.viewTab="voucher_use";break;default:r.viewTab="introduction"}r.identifyTopUpIconSize(),r.email=e.email,r.isWithdrawing=e.isWithdrawing,r.createdAt=e.createdAt,r.coinDelta=e.coinDelta,r.withdrawBank=e.withdrawBank,r.withdrawBankId=e.withdrawBankId,r.paymentMethod="atm-banking",r.coin=e.coin,r.withdrawCoin=50,r.startHistory=moment().startOf("month").toDate(),r.endHistory=moment().toDate(),t(r.loadTransactionHistory),r.voucherPrice=10,r.voucherAmount=0,r.voucherMax=Math.floor(r.coin/r.voucherPrice),r.voucherSum=r.voucherAmount*r.voucherPrice,r.voucherRemainCoin=r.coin-r.voucherSum,t(r.loadVoucherList),r.exchangeCoinRate=angular.isUndefined(e.exchangeCoinRate)?1e3:e.exchangeCoinRate,r.atmBankingValue=2e4,r.selectedAtmBank=null,r.changeAtmBankingValue(),r.internetBankingValue=2e4,r.selectedInternetBank=null,r.changeInternetBankingValue(),r.creditCardValue=2e4,r.selectedCreditCard=null,r.changeCreditCardValue(),r.scratchcardValue=2e4,r.selectedScratchcard=null,r.scratchcardFee=null,r.changeScratchcardValue()},r.changeTab=function(e){r.viewTab=e,n.hash(e)},r.submitWithdraw=function(e){if(e){var t=i.open({animation:!0,templateUrl:"withdrawPasswordModal.html",controller:"withdrawPasswordCtrl",controllerAs:"withdrawPasswordVm",keyboard:!1,backdrop:"static"});t.result.then(function(e){if(e){var t=i.open({animation:!0,templateUrl:"withdrawCodeModal.html",controller:"withdrawCodeCtrl",controllerAs:"withdrawCodeVm",keyboard:!1,backdrop:"static"});t.result.then(function(e){if(e.success){var t=i.open({animation:!0,templateUrl:"withdrawTransactionModal.html",
controller:"withdrawTransactionCtrl",controllerAs:"withdrawTransactionVm",keyboard:!1,backdrop:"static",resolve:{transactionData:function(){var t={};return t.withdrawCoin=r.withdrawCoin,t.withdrawBank=r.withdrawBank,t.withdrawBankId=r.withdrawBankId,t.withdrawCode=e.code,t}}});t.result.then(function(e){e.success&&(r.isWithdrawing=!0,r.createdAt=new Date,r.coinDelta=r.withdrawCoin,r.coin=e.coin)})}})}})}},r.cancelWithdrawTransaction=function(){var e=i.open({animation:!0,templateUrl:"withdrawCancelModal.html",controller:"withdrawCancelCtrl",controllerAs:"withdrawCancelVm",keyboard:!0});e.result.then(function(e){e.success&&(r.isWithdrawing=!1,r.coin=e.coin)})},r.loadingTransactionHistory=!1,r.transactions=[],r.startHistory=null,r.endHistory=null,r.page=0,r.isLastPage=!1,r.filter="all",r.transactionService=null,r.loadTransactionHistory=function(){if(!r.loadingTransactionHistory&&null!=r.startHistory&&null!=r.endHistory){var e=new Date(r.endHistory.getTime());if(e.setDate(e.getDate()+1),r.startHistory>r.endHistory)return;var t={start:r.convertDateToString(r.startHistory),end:r.convertDateToString(e),page:r.page+1};0==r.page&&(r.transactions=[],r.isLastPage=!1),r.loadingTransactionHistory=!0,r.transactionService=s.loadTransactions(t,function(e){e.success&&(r.page++,0==e.result.length?r.isLastPage=!0:r.transactions.push.apply(r.transactions,e.result)),r.loadingTransactionHistory=!1},function(e){r.loadingTransactionHistory=!1})}},r.convertDateToString=function(e){var t=e.getDate(),n=e.getMonth()+1,a=e.getFullYear();return t<10&&(t="0"+t),n<10&&(n="0"+n),a+"-"+n+"-"+t},r.updateResult=function(){r.transactionService.$cancelRequest(),r.page=0,r.loadTransactionHistory()},r.loadMoreResult=function(){r.isLastPage||r.loadingTransactionHistory||r.loadTransactionHistory()},r.checkDisplay=function(e){var t=!0;switch(r.filter){case"pay":0!=e&&(t=!1);break;case"receive":1!=e&&(t=!1);break;case"topup":2!=e&&(t=!1);break;case"withdraw":3!=e&&(t=!1);break;default:t=!0}return t},r.voucherListService=null,r.loadingVoucherList=!1,r.voucherList=[],r.loadVoucherList=function(){r.loadingVoucherList=!0,r.voucherListService=s.loadVoucherList({},function(e){e.success&&(r.voucherList=e.voucherList),r.loadingVoucherList=!1},function(e){r.loadingVoucherList=!1})},r.modifyVoucherMax=function(){r.voucherMax=Math.floor(r.coin/r.voucherPrice),r.voucherSum=angular.isDefined(r.voucherAmount)&&angular.isDefined(r.voucherPrice)?Math.max(0,r.voucherAmount*r.voucherPrice):0,r.voucherRemainCoin=r.coin-r.voucherSum},r.modifyVoucherAmount=function(){r.voucherSum=angular.isDefined(r.voucherAmount)&&angular.isDefined(r.voucherPrice)?Math.max(0,r.voucherAmount*r.voucherPrice):0,r.voucherRemainCoin=r.coin-r.voucherSum},r.createVoucherMessage="",r.creatingVoucherList=!1,r.createVoucher=function(e){if(r.createVoucherMessage="",e&&r.voucherSum>0&&!r.creatingVoucherList){var t=i.open({animation:!0,templateUrl:"voucherPasswordModal.html",controller:"voucherPasswordCtrl",controllerAs:"voucherPasswordVm",keyboard:!1,backdrop:"static"});t.result.then(function(e){if(e){var t=i.open({animation:!0,templateUrl:"voucherCodeModal.html",controller:"voucherCodeCtrl",controllerAs:"voucherCodeVm",keyboard:!1,backdrop:"static",resolve:{voucherInfo:function(){return{price:r.voucherPrice,amount:r.voucherAmount}}}});t.result.then(function(e){e.success&&(r.voucherList=e.newVoucherList,r.coin=e.newCoin,r.createVoucherMessage="Đã tạo các voucher thành công.")})}})}},r.activateVoucherMessage="",r.activatingVoucher=!1,r.activateVoucher=function(t){t&&!r.activatingVoucher&&(r.activatingVoucher=!0,r.activateVoucherMessage="",s.activateVoucher({},{email:r.email,serial:r.voucherSerial},function(t){t.success?(r.coin=t.newCoin,r.voucherSerial="",e.useVoucherForm.$setPristine(),e.useVoucherForm.$setUntouched(),r.activateVoucherMessage="Đã nạp thành công. Số xu mới của bạn là "+r.coin):r.activateVoucherMessage=t.message,r.activatingVoucher=!1},function(e){r.activatingVoucher=!1,r.activateVoucherMessage="Không thể kích hoạt voucher."}))},r.changeAtmBankingValue=function(){null==r.atmBankingValue?r.atmBankingExchange=0:r.atmBankingExchange=Math.floor((r.atmBankingValue-(1760+.011*r.atmBankingValue))/r.exchangeCoinRate)},r.processingAtmBanking=!1,r.processAtmBanking=function(e){e&&(r.processingAtmBanking=!0,r.processAtmBankingMessage="",s.doAtmBankPayment({},{email:r.email,amount:r.atmBankingValue,bank:r.selectedAtmBank},function(e){e.success?a.location.href=e.checkout_url:r.processAtmBankingMessage=e.message,r.processingAtmBanking=!1},function(e){r.processAtmBankingMessage="Không thể kết nối được với server",r.processingAtmBanking=!1}))},r.changeInternetBankingValue=function(){null==r.internetBankingValue?r.internetBankingExchange=0:r.internetBankingExchange=Math.floor((r.internetBankingValue-(1760+.011*r.internetBankingValue))/r.exchangeCoinRate)},r.processingInternetBanking=!1,r.processInternetBanking=function(e){e&&(r.processingInternetBanking=!0,r.processInternetBankingMessage="",s.doIBankPayment({},{email:r.email,amount:r.internetBankingValue,bank:r.selectedInternetBank},function(e){e.success?a.location.href=e.checkout_url:r.processInternetBankingMessage=e.message,r.processingInternetBanking=!1},function(e){r.processInternetBankingMessage="Không thể kết nối được với server",r.processingInternetBanking=!1}))},r.changeCreditCardValue=function(){null==r.creditCardValue?r.creditCardExchange=0:r.creditCardExchange=Math.floor((r.creditCardValue-(5500+.03*r.creditCardValue))/r.exchangeCoinRate)},r.processingCreditCard=!1,r.processCreditCard=function(e){e&&(r.processingCreditCard=!0,r.processCreditCardMessage="",s.doCreditCardPayment({},{email:r.email,amount:r.creditCardValue,bank:r.selectedCreditCard},function(e){e.success?a.location.href=e.checkout_url:r.processCreditCardMessage=e.message,r.processingCreditCard=!1},function(e){r.processCreditCardMessage="Không thể kết nối được với server",r.processingCreditCard=!1}))},r.changeSelectedScratchcard=function(){if(null!=r.selectedScratchcard){switch(r.selectedScratchcard){case"viettel":r.scratchcardFee=20;break;case"vms":r.scratchcardFee=20;break;case"vnp":r.scratchcardFee=20;break;case"gate":r.scratchcardFee=18;break;default:r.scratchcardFee=null}r.changeScratchcardValue()}},r.changeScratchcardValue=function(){null==r.scratchcardValue||null==r.scratchcardFee?r.scratchcardExchange=0:r.scratchcardExchange=Math.floor((r.scratchcardValue-r.scratchcardFee/100*r.scratchcardValue)/r.exchangeCoinRate)},r.processingScratchcard=!1,r.processScratchcard=function(e){e&&(r.processingScratchcard=!0,r.processScratchcardMessage="",s.doScratchcardPayment({},{email:r.email,amount:r.scratchcardValue,typeCard:r.selectedScratchcard,pin:r.scratchcardPin,serial:r.scratchcardSerial},function(e){if(e.success){var t=i.open({animation:!0,templateUrl:"scratchcardModal.html",controller:"scratchcardCtrl",controllerAs:"scratchcardVm",keyboard:!1,backdrop:"static",resolve:{scratchcardData:function(){return e.data}}});t.result.then(function(){a.location.reload()})}else r.processScratchcardMessage=e.message;r.processingScratchcard=!1},function(e){r.processScratchcardMessage="Không thể kết nối được với server",r.processingScratchcard=!1}))},r.myWindow=angular.element(a),r.myWindow.on("resize",function(){r.identifyTopUpIconSize(),e.$digest()}),r.identifyTopUpIconSize=function(){r.fa5x=r.fa4x=r.fa3x=r.fa2x=r.faLg=!1;var e=r.myWindow.width();e>1150?r.fa5x=!0:e<=1150&&e>880?r.fa4x=!0:e<=880&&e>526?r.fa3x=!0:e<=526&&e>350?r.fa2x=!0:r.faLg=!0},e.$on("$locationChangeSuccess",function(e,t,n){t!=n&&t.split("#")[0]!=n.split("#")[0]&&(null!=r.transactionService&&r.transactionService.$cancelRequest(),null!=r.voucherListService&&r.voucherListService.$cancelRequest())})}]),mainApp.controller("scratchcardCtrl",["$scope","$uibModalInstance","scratchcardData",function(e,t,n){var a=this;a.scratchcardData=n,a.close=function(){t.close()}}]),mainApp.controller("voucherCodeCtrl",["$scope","$uibModalInstance","CoinService","voucherInfo",function(e,t,n,a){var i=this;i.code="",i.statusMessage="",i.processing=!1,i.cancel=function(){t.close({success:!1})},i.finish=function(){return""==i.code||16!=i.code.length?void(i.statusMessage="Mã không hợp lệ"):(i.processing=!0,i.statusMessage="Hệ thống đang kiểm tra mã và tạo voucher...",void n.verifyCodeWithCreateVoucher({},{code:i.code,price:a.price,amount:a.amount},function(e){e.success?t.close({success:!0,newVoucherList:e.newVoucherList,newCoin:e.newCoin}):i.statusMessage=e.message,i.processing=!1},function(e){i.statusMessage="Không thực hiện được.",i.processing=!1}))}}]),mainApp.controller("voucherPasswordCtrl",["$scope","$uibModalInstance","CoinService",function(e,t,n){var a=this;a.password="",a.statusMessage="",a.processing=!1,a.cancel=function(){t.close(!1)},a.finish=function(){return""==a.password||a.password.length<8||a.password.length>255?void(a.statusMessage="Mật khẩu không hợp lệ"):(a.processing=!0,a.statusMessage="Hệ thống đang xử lý, vui lòng đợi trong giây lát...",void n.verifyPasswordVoucher({},{password:a.password},function(e){e.success?t.close(!0):a.statusMessage="Mật khẩu không khớp.",a.processing=!1},function(e){a.statusMessage="Lỗi kiểm tra mật khẩu.",a.processing=!1}))}}]),mainApp.controller("withdrawCancelCtrl",["$scope","$uibModalInstance","CoinService",function(e,t,n){var a=this;a.statusMessage="",a.processing=!1,a.cancel=function(){t.close({success:!1,coin:0})},a.finish=function(){a.processing=!0,a.statusMessage="Hệ thống đang hủy giao dịch ...",n.cancelWithdraw({},{confirmed:!0},function(e){e.success?t.close({success:!0,coin:e.coin}):a.statusMessage="Lỗi không hủy được giao dịch.",a.processing=!1},function(e){a.statusMessage="Lỗi kết nối server.",a.processing=!1})}}]),mainApp.controller("withdrawCodeCtrl",["$scope","$uibModalInstance","CoinService",function(e,t,n){var a=this;a.code="",a.statusMessage="",a.processing=!1,a.cancel=function(){t.close({success:!1,code:a.code})},a.finish=function(){return""==a.code||16!=a.code.length?void(a.statusMessage="Mã không hợp lệ"):(a.processing=!0,a.statusMessage="Hệ thống đang kiểm tra mã...",void n.verifyCode({},{code:a.code},function(e){e.success?t.close({success:!0,code:a.code}):a.statusMessage="Mã không khớp.",a.processing=!1},function(e){a.statusMessage="Lỗi kiểm tra mã.",a.processing=!1}))}}]),mainApp.controller("withdrawPasswordCtrl",["$scope","$uibModalInstance","CoinService",function(e,t,n){var a=this;a.password="",a.statusMessage="",a.processing=!1,a.cancel=function(){t.close(!1)},a.finish=function(){return""==a.password||a.password.length<8||a.password.length>255?void(a.statusMessage="Mật khẩu không hợp lệ"):(a.processing=!0,a.statusMessage="Hệ thống đang xử lý, vui lòng đợi trong giây lát...",void n.verifyPassword({},{password:a.password},function(e){e.success?t.close(!0):a.statusMessage="Mật khẩu không khớp.",a.processing=!1},function(e){a.statusMessage="Lỗi kiểm tra mật khẩu.",a.processing=!1}))}}]),mainApp.controller("withdrawTransactionCtrl",["$scope","$uibModalInstance","CoinService","transactionData",function(e,t,n,a){var i=this;i.withdrawCoin=a.withdrawCoin,i.withdrawBank=a.withdrawBank,i.withdrawBankId=a.withdrawBankId,i.withdrawCode=a.withdrawCode,i.value="",i.statusMessage="",i.processing=!1,i.cancel=function(){t.close({success:!1,coin:0})},i.finish=function(){i.processing=!0,i.statusMessage="Đang hoàn thành giao dịch...";var e={};e.withdrawCoin=i.withdrawCoin,e.withdrawBank=i.withdrawBank,e.withdrawBankId=i.withdrawBankId,e.withdrawCode=i.withdrawCode,n.withdraw({},e,function(e){e.success?t.close({success:!0,coin:e.coin}):i.statusMessage="Lỗi thực hiện giao dịch.",i.processing=!1},function(e){i.statusMessage="Lỗi thực hiện giao dịch.",i.processing=!1})}}]),mainApp.controller("commentCtrl",["$scope","$timeout","CommentService",function(e,t,n){var a=this;a.userComment="",a.message="",a.changing=!1,a.focusEditor=function(){a.changing=!0,a.message=""},a.sending=!1,a.sendComment=function(e){a.changing=!1,e&&(a.sending=!0,n.send({},{comment:a.userComment},function(e){a.sending=!1,e.success?(a.message="Phản hồi đã được ghi nhận.",a.userComment="",a.changing=!0):a.message=e.message},function(e){a.sending=!1,a.message="Không lưu được"}))}}]),mainApp.controller("searchCtrl",["$scope","$timeout","$location","$window","SearchService",function(e,t,n,a,i){var s=this;s.query=null,s.result=null,s.loading=!1,s.init=function(e,n){s.query=angular.isDefined(e)?e.trim():"",s.currentPage=angular.isDefined(n)?n:0,t(s.searchExams)},s.redirectToSearchPage=function(){s.query=s.query.trim(),0!==s.query.length&&(a.location.href="/search?q="+s.query)},s.searchExams=function(e){if(s.query=s.query.trim(),0!==s.query.length&&!s.loading){e&&(s.currentPage=0),0==s.currentPage?n.path("/search").search({q:s.query}):n.path("/search").search({q:s.query,page:s.currentPage});var t=new i;t.q=s.query,0!=s.currentPage&&(t.page=s.currentPage),s.loading=!0,t.$save(function(e){s.result=e.result,s.currentPage=e.result.current_page,s.prevLink="/"+e.result.prev_page_url,s.nextLink="/"+e.result.next_page_url,s.numPage=e.result.last_page,s.displaySearchPagination(),a.scrollTo(0,0),s.loading=!1},function(e){s.loading=!1})}},s.pages={},s.pages.previous="",s.pages.next="",s.currentPage=0,s.numPage=0,s.prevLink="",s.nextLink="",s.pages.viewFrame=[],s.displaySearchPagination=function(){s.identifyNumberItemPerPage();var e=s.numberItemPerPage/2,t=s.currentPage>e?s.currentPage-e:1,n=Math.min(t+parseInt(s.numberItemPerPage),s.numPage),a=Math.max(n-parseInt(s.numberItemPerPage)+1,1);s.pages.viewFrame=[];for(var i=a;i<=n;i++){var r={};r.index=i,r.link="/search?q="+s.query+"&page="+r.index,s.pages.viewFrame.push(r)}s.pages.previous=s.currentPage>1?s.prevLink:"",s.pages.next=s.currentPage<s.numPage?s.nextLink:""},s.numberItemPerPage=0,s.identifyNumberItemPerPage=function(){var e=s.myWindow.width();e>880?s.numberItemPerPage=10:e<=880&&e>526?s.numberItemPerPage=8:e<=526&&e>350?s.numberItemPerPage=4:s.numberItemPerPage=2},s.myWindow=angular.element(a),s.myWindow.on("resize",function(){s.displaySearchPagination(),e.$digest()}),s.goPrevious=function(){angular.isUndefined(s.currentPage)||s.currentPage<=1||(s.currentPage--,s.searchExams(!1))},s.goTo=function(e){s.currentPage!=e&&(s.currentPage=e,s.searchExams(!1))},s.goNext=function(){angular.isUndefined(s.currentPage)||s.currentPage>=s.numPage||(0==s.currentPage&&(s.currentPage=1),s.currentPage++,s.searchExams(!1))}}]),mainApp.controller("shortcutKeyCtrl",["$scope","$uibModalInstance",function(e,t){var n=this;n.close=function(){t.close()}}]),mainApp.controller("deleteExamCtrl",["$scope","$uibModalInstance","HomeService","exam",function(e,t,n,a){var i=this;i.examId=a.id,i.type=a.type,i.message="",i.close=function(){i.deletingExam||t.close(!1)},i.changePassword=function(){i.message=""},i.deletingExam=!1,i["delete"]=function(){i.deletingExam=!0,n.deleteExam({id:i.examId},{type:i.type},function(e){e.success?t.close(!0):i.message=e.message,i.deletingExam=!1},function(e){i.deletingExam=!1})}}]),mainApp.controller("messageCtrl",["$scope","$uibModalInstance","data",function(e,t,n){var a=this;a.message=n.message,a.close=function(){t.close()}}]),mainApp.controller("shareExamCtrl",["$scope","$uibModalInstance","exam","ngClipboard",function(e,t,n,a){var i=this;i.examId=n.id,i.examLink="https://toithi.com/exam/"+n.id+"/information",i.message="",i.close=function(){t.close()},i.copyToClipboard=function(){a.toClipboard(i.examLink),i.message="Liên kết đã sao chép vào clipboard"}}]),mainApp.controller("userHomeCtrl",["$scope","$window","$timeout","$uibModal","HomeService",function(e,t,n,a,i){var s=this;s.query="",s.searchExam=function(){s.query=s.query.trim(),0!==s.query.length&&(t.location.href="/search?q="+s.query)},s.yearView=!1,s.currentDay=-1,s.currentMonth=-1,s.currentYear=-1,s.currentView="",s.normalCreationView=!0,s.searchCreationView=!1,s.normalActionView=!0,s.searchActionView=!1,s.examDeleteMonth=0,s.init=function(e){s.examDeleteMonth=e.examDeleteMonth;var t=new Date;s.currentDay=t.getDate(),s.currentMonth=t.getMonth()+1,s.currentYear=t.getFullYear(),s.selectedMonth=s.currentMonth,s.selectedYear=s.currentYear,s.createMonthView(),s.currentView="creations",n(s.loadCreation,0,!0,1),n(s.loadAction,0,!0,1),s.normalCreationView=!0,s.searchCreationView=!1,s.normalActionView=!0,s.searchActionView=!1,n(s.loadExamsInMonth,0,!0,s.currentMonth,s.currentYear)},s.loadCreationService=null,s.loadingCreation=!1,s.creations=[],s.creationViewFrame=[],s.creationPages=null,s.currentCreationPage=1,s.previousCreationPage=!1,s.nextCreationPage=!1,s.lastCreationPage=0,s.totalCreation=0,s.loadCreation=function(e){angular.isDefined(s.creations[e])?(s.creationViewFrame=s.creations[e],s.fromCreation=20*(e-1)+1,s.toCreation=e<s.lastCreationPage?20*e:s.totalCreation,s.currentCreationPage=e,s.previousCreationPage=e>1,s.nextCreationPage=e<s.lastCreationPage):(s.loadingCreation=!0,s.loadCreationService=i.loadCreation({page:e},function(e){if(e.success){if(null==s.creationPages){s.creationPages=[];for(var t=0;t<e.result.last_page;t++)s.creationPages.push(t+1)}s.lastCreationPage=e.result.last_page,s.totalCreation=e.result.total,s.fromCreation=e.result.from,s.toCreation=e.result.to,s.currentCreationPage=e.result.current_page,s.previousCreationPage=null!=e.result.prev_page_url,s.nextCreationPage=null!=e.result.next_page_url,s.creations[s.currentCreationPage]=e.result.data,s.creationViewFrame=s.creations[s.currentCreationPage]}s.loadingCreation=!1},function(e){s.loadingCreation=!1}))},s.goToCreationPage=function(e){e>=1&&e<=s.lastCreationPage&&e!=s.currentCreationPage&&s.loadCreation(e)},s.goToPreviousCreationPage=function(){s.currentCreationPage>1&&s.loadCreation(s.currentCreationPage-1)},s.goToNextCreationPage=function(){s.currentCreationPage<s.lastCreationPage&&s.loadCreation(s.currentCreationPage+1)},s.displayNormalCreationView=function(){s.normalCreationView=!0,s.searchCreationView=!1,s.currentCreationPage=1,s.loadCreation(s.currentCreationPage),s.creationQuery=""},s.creationSearchType="code",s.searchingCreation=!1,s.searchCreationService=null,s.searchCreationPages=null,s.creationQuery="",s.searchCreation=function(){return 0==s.creationQuery.length?void s.displayNormalCreationView():void(s.creationQuery.length<1||s.creationQuery.length>255||(s.normalCreationView=!1,s.searchCreationView=!0,s.searchCreationPages=null,s.searchCreations=[],s.loadSearchCreation(1)))},s.searchCreations=[],s.searchCreationPages=null,s.currentSearchCreationPage=1,s.previousSearchCreationPage=!1,s.nextSearchCreationPage=!1,s.lastSearchCreationPage=0,s.totalSearchCreation=0,s.loadSearchCreation=function(e){angular.isDefined(s.searchCreations[e])?(s.creationViewFrame=s.searchCreations[e],s.currentSearchCreationPage=e,s.previousSearchCreationPage=e>1,s.nextSearchCreationPage=e<s.lastSearchCreationPage):(s.searchingCreation=!0,s.searchCreationService=i.searchCreation({query:s.creationQuery,type:s.creationSearchType,page:e},function(e){if(e.success){if(null==s.searchCreationPages){s.searchCreationPages=[];for(var t=0;t<e.result.last_page;t++)s.searchCreationPages.push(t+1)}s.lastSearchCreationPage=e.result.last_page,s.totalSearchCreation=e.result.total,s.currentSearchCreationPage=e.result.current_page,s.previousSearchCreationPage=null!=e.result.prev_page_url,s.nextSearchCreationPage=null!=e.result.next_page_url,s.searchCreations[s.currentSearchCreationPage]=e.result.data,s.creationViewFrame=s.searchCreations[s.currentSearchCreationPage]}s.searchingCreation=!1},function(e){s.searchingCreation=!1}))},s.goToSearchCreationPage=function(e){e>=1&&e<=s.lastSearchCreationPage&&e!=s.currentSearchCreationPage&&s.loadSearchCreation(e)},s.goToPreviousSearchCreationPage=function(){s.currentSearchCreationPage>1&&s.loadSearchCreation(s.currentSearchCreationPage-1)},s.goToNextSearchCreationPage=function(){s.currentSearchCreationPage<s.lastSearchCreationPage&&s.loadSearchCreation(s.currentSearchCreationPage+1)},s.loadActionService=null,s.loadingAction=!1,s.actions=[],s.actionViewFrame=[],s.actionPages=null,s.currentActionPage=1,s.previousActionPage=!1,s.nextActionPage=!1,s.lastActionPage=0,s.totalAction=0,s.loadAction=function(e){angular.isDefined(s.actions[e])?(s.actionViewFrame=s.actions[e],s.fromAction=20*(e-1)+1,s.toAction=e<s.lastActionPage?20*e:s.totalAction,s.currentActionPage=e,s.previousActionPage=e>1,s.nextActionPage=e<s.lastActionPage):(s.loadingAction=!0,s.loadActionService=i.loadAction({page:e},function(e){if(e.success){if(null==s.actionPages){s.actionPages=[];for(var t=0;t<e.result.last_page;t++)s.actionPages.push(t+1);s.lastActionPage=e.result.last_page,s.totalAction=e.result.total}s.fromAction=e.result.from,s.toAction=e.result.to,s.currentActionPage=e.result.current_page,s.previousActionPage=null!=e.result.prev_page_url,s.nextActionPage=null!=e.result.next_page_url,s.actions[s.currentActionPage]=e.result.data,s.actionViewFrame=s.actions[s.currentActionPage],s.totalAction>s.totalCreation&&(s.currentView="actions")}s.loadingAction=!1},function(e){s.loadingAction=!1}))},s.goToActionPage=function(e){e>=1&&e<=s.lastActionPage&&e!=s.currentActionPage&&s.loadAction(e)},s.goToPreviousActionPage=function(){s.currentActionPage>1&&s.loadCreation(s.currentActionPage-1)},s.goToNextActionPage=function(){s.currentActionPage<s.lastActionPage&&s.loadAction(s.currentActionPage+1)},s.displayNormalActionView=function(){s.normalActionView=!0,s.searchActionView=!1,s.currentActionPage=1,s.loadAction(s.currentActionPage),s.actionQuery=""},s.actionSearchType="code",s.searchingAction=!1,s.searchActionService=null,s.searchActionPages=null,s.actionQuery="",s.searchAction=function(){return 0==s.actionQuery.length?void s.displayNormalActionView():void(s.actionQuery.length<1||s.actionQuery.length>255||(s.normalActionView=!1,s.searchActionView=!0,s.searchActionPages=null,s.searchActions=[],s.loadSearchAction(1)))},s.searchActions=[],s.searchActionPages=null,s.currentSearchActionPage=1,s.previousSearchActionPage=!1,s.nextSearchActionPage=!1,s.lastSearchActionPage=0,s.totalSearchAction=0,s.loadSearchAction=function(e){angular.isDefined(s.searchActions[e])?(s.actionViewFrame=s.searchActions[e],s.currentSearchActionPage=e,s.previousSearchActionPage=e>1,s.nextSearchActionPage=e<s.lastSearchActionPage):(s.searchingAction=!0,s.searchActionService=i.searchAction({query:s.actionQuery,type:s.actionSearchType,page:e},function(e){if(e.success){if(null==s.searchActionPages){s.searchActionPages=[];for(var t=0;t<e.result.last_page;t++)s.searchActionPages.push(t+1);s.lastSearchActionPage=e.result.last_page,s.totalSearchAction=e.result.total}s.currentSearchActionPage=e.result.current_page,s.previousSearchActionPage=null!=e.result.prev_page_url,s.nextSearchActionPage=null!=e.result.next_page_url,s.searchActions[s.currentSearchActionPage]=e.result.data,s.actionViewFrame=s.searchActions[s.currentSearchActionPage]}s.searchingAction=!1},function(e){s.searchingAction=!1}))},s.goToSearchActionPage=function(e){e>=1&&e<=s.lastSearchActionPage&&e!=s.currentSearchActionPage&&s.loadSearchAction(e)},s.goToPreviousSearchActionPage=function(){s.currentSearchActionPage>1&&s.loadSearchAction(s.currentSearchActionPage-1)},s.goToNextSearchActionPage=function(){s.currentSearchActionPage<s.lastSearchActionPage&&s.loadSearchAction(s.currentSearchActionPage+1)},s.showCertificate=function(e){e.pivot.finished?t.location.href="/u/exam/"+e.id+"/dashboard/certificate":a.open({animation:!0,templateUrl:"messageModal.html",controller:"messageCtrl",controllerAs:"messageVm",keyboard:!0,resolve:{data:function(){return{message:"Bài thi chưa được hoàn thành."}}}})},s.loadingInMonth=!1,s.loadExamsInMonthService=null,s.examsInMonth={},s.loadExamsInMonth=function(e,t){angular.isDefined(s.examsInMonth[e+"-"+t])?(s.createMonthView(),s.createEventView()):(s.eventsInMonthView=[],s.loadingInMonth=!0,s.loadExamsInMonthService=i.loadExamsInMonth({month:e,year:t},function(n){if(n.success){var a=e+"-"+t;if(angular.isDefined(s.examsInMonth[a]))return;s.examsInMonth[a]={};for(var i=n.result.creations.length,r=0;r<i;r++){var o=n.result.creations[r],c={id:o.id,code:o.code,title:o.title,start:o.start,end:o.end,number_players:o.number_players},u=moment(o.start,"YYYY-MM-DD H:m:s").date();angular.isUndefined(s.examsInMonth[a][u])&&(s.examsInMonth[a][u]={creations:[]}),angular.isUndefined(s.examsInMonth[a][u].creations)&&(s.examsInMonth[a][u].creations=[]),s.examsInMonth[a][u].creations.push(c)}var l=n.result.actions.length;for(r=0;r<l;r++){var d=n.result.actions[r],m={id:d.id,code:d.code,title:d.title,pivot:{begin_time:d.pivot.begin_time,finished:d.pivot.finished,score:d.pivot.score,consumed_time:d.pivot.consumed_time,number_correct:d.pivot.number_correct}},g=moment(d.pivot.begin_time,"YYYY-MM-DD H:m:s").date();angular.isUndefined(s.examsInMonth[a][g])&&(s.examsInMonth[a][g]={actions:[]}),angular.isUndefined(s.examsInMonth[a][g].actions)&&(s.examsInMonth[a][g].actions=[]),s.examsInMonth[a][g].actions.push(m)}s.createMonthView(),s.createEventView()}s.loadingInMonth=!1},function(e){s.loadingInMonth=!1}))},s.selectedDay=-1,s.selectedMonth=-1,s.selectedYear=-1,s.changeMonth=function(e){s.selectedMonth=e,s.yearView=!1,s.createMonthView(),s.loadExamsInMonth(s.selectedMonth,s.selectedYear)},s.monthRows=[],s.eventsInMonth=[],s.createMonthView=function(){s.monthRows=[],s.eventsInMonth=[];for(var e=new Date(s.selectedYear,s.selectedMonth-1,1),t=new Date(s.selectedYear,s.selectedMonth,0),n=e.getDay(),a=t.getDay(),i=t.getDate(),r=n+i+(6-a),o=s.selectedMonth+"-"+s.selectedYear,c=1,u=[],l=0;l<r;l++){var d={id:l+1,value:"",existCreation:!1,existAction:!1};if(l>=n&&c<=i){d.value=c,d.existCreation=angular.isDefined(s.examsInMonth[o])&&angular.isDefined(s.examsInMonth[o][c])&&angular.isDefined(s.examsInMonth[o][c].creations),d.existAction=angular.isDefined(s.examsInMonth[o])&&angular.isDefined(s.examsInMonth[o][c])&&angular.isDefined(s.examsInMonth[o][c].actions);var m;if(d.existCreation)for(var g=s.examsInMonth[o][c].creations.length,h=0;h<g;h++)m=s.examsInMonth[o][c].creations[h],m.day=c,m.date=moment(m.start,"YYYY-MM-DD H:m:s").toDate(),m.type="creation",s.eventsInMonth.push(m);if(d.existAction)for(var p=s.examsInMonth[o][c].actions.length,f=0;f<p;f++)m=s.examsInMonth[o][c].actions[f],m.day=c,m.date=moment(m.pivot.begin_time,"YYYY-MM-DD H:m:s").toDate(),m.type="action",s.eventsInMonth.push(m);c++}0!=l&&l%7==0&&(s.monthRows.push(u),u=[]),u.push(d)}s.monthRows.push(u),s.eventsInMonth.sort(function(e,t){return e.date>t.date?-1:e.date<t.date?1:0})},s.changeCalendarView=function(){s.yearView=!0},s.goCalendarPrevious=function(){s.yearView?s.selectedYear>2e3&&s.selectedYear--:s.selectedMonth>1?s.changeMonth(s.selectedMonth-1):s.selectedYear>2e3&&(s.selectedYear--,s.changeMonth(12))},s.goCalendarNext=function(){s.yearView?s.selectedYear<2100&&s.selectedYear++:s.selectedMonth<12?s.changeMonth(s.selectedMonth+1):s.selectedYear<2100&&(s.selectedYear++,s.changeMonth(1))},s.checkCurrentDay=function(e){return s.currentDay==e&&s.selectedMonth==s.currentMonth&&s.selectedYear==s.currentYear},s.checkCurrentMonth=function(e){return s.currentMonth==e&&s.selectedYear==s.currentYear},s.eventsInMonthView=[],s.eventsInMonthPage=0,s.lastEventsInMonthPage=0,s.createEventView=function(){s.eventsInMonthPage=0,s.lastEventsInMonthPage=Math.floor((s.eventsInMonth.length-1)/5),s.eventsInMonthView=s.eventsInMonth.slice(5*s.eventsInMonthPage,5*(s.eventsInMonthPage+1))},s.nextEventView=function(){s.eventsInMonthPage!=s.lastEventsInMonthPage&&(s.eventsInMonthPage++,s.eventsInMonthView=s.eventsInMonth.slice(5*s.eventsInMonthPage,5*(s.eventsInMonthPage+1)))},s.previousEventView=function(){0!=s.eventsInMonthPage&&(s.eventsInMonthPage--,s.eventsInMonthView=s.eventsInMonth.slice(5*s.eventsInMonthPage,5*(s.eventsInMonthPage+1)))},s.showEvent=function(e){"creation"==e.type?(s.normalCreationView=!1,s.searchCreationView=!1,s.creationViewFrame=[],s.creationViewFrame.push(e),s.currentView="creations"):(s.normalActionView=!1,s.searchActionView=!1,s.actionViewFrame=[],s.actionViewFrame.push(e),s.currentView="actions"),t.scrollTo(0,0)},s.showEventsInDay=function(e){if(""!=e.value){s.normalCreationView=!1,s.searchCreationView=!1,s.normalActionView=!1,s.searchActionView=!1;var n=s.selectedMonth+"-"+s.selectedYear,a=e.value;e.existCreation&&(s.creationViewFrame=s.examsInMonth[n][a].creations,s.currentView="creations"),e.existAction&&(s.actionViewFrame=s.examsInMonth[n][a].actions,s.currentView="actions"),t.scrollTo(0,0)}},s.changeTab=function(e){s.currentView=e},s.shareExam=function(e){a.open({animation:!0,templateUrl:"shareExamModal.html",controller:"shareExamCtrl",controllerAs:"shareExamVm",keyboard:!0,resolve:{exam:function(){return{id:e}}}})},s.deleteCreation=function(e){var t=a.open({animation:!0,templateUrl:"deleteExamModal.html",controller:"deleteExamCtrl",controllerAs:"deleteExamVm",keyboard:!1,backdrop:"static",resolve:{exam:function(){return{id:e,type:"creation"}}}});t.result.then(function(t){if(t){var n,a,r,o=s.creations.length;for(n=1;n<o;n++)if(angular.isDefined(s.creations[n])){for(r=s.creations[n].length,a=0;a<r;a++)if(s.creations[n][a].id==e){s.creations[n].splice(a,1),s.totalCreation--;break}if(a!=r){angular.isDefined(s.creations[n+1])?(s.creations[n].push(s.creations[n+1][0]),s.normalCreationView&&(s.creationViewFrame=s.creations[n])):s.loadCreationService=i.loadCreation({page:n},function(e){if(e.success){if(e.result.last_page!=s.lastCreationPage){s.creationPages=[];for(var t=0;t<e.result.last_page;t++)s.creationPages.push(t+1)}s.lastCreationPage=e.result.last_page,s.totalCreation=e.result.total,e.result.current_page<=e.result.last_page?(s.fromCreation=e.result.from,s.toCreation=e.result.to,s.currentCreationPage=e.result.current_page,s.previousCreationPage=null!=e.result.prev_page_url,s.nextCreationPage=null!=e.result.next_page_url,s.creations[s.currentCreationPage]=e.result.data,s.normalCreationView&&(s.creationViewFrame=s.creations[s.currentCreationPage])):(s.creations.splice(e.result.current_page,1),angular.isDefined(s.creations[e.result.last_page])?(s.fromCreation=20*(e.result.last_page-1)+1,s.toCreation=s.totalCreation,s.currentCreationPage=e.result.last_page,s.previousCreationPage=null!=e.result.prev_page_url,s.nextCreationPage=!1,s.normalCreationView&&(s.creationViewFrame=s.creations[s.currentCreationPage])):s.loadCreation(e.result.last_page))}},function(e){}),s.creations.splice(n+1,o-n+1);break}}if(s.searchCreationView)for(o=s.searchCreations.length,n=1;n<o;n++)if(angular.isDefined(s.searchCreations[n])){for(r=s.searchCreations[n].length,a=0;a<r;a++)if(s.searchCreations[n][a].id==e){s.searchCreations[n].splice(a,1);break}if(a!=r){angular.isDefined(s.searchCreations[n+1])?(s.searchCreations[n].push(s.searchCreations[n+1][0]),s.creationViewFrame=s.searchCreations[n]):s.searchCreationService=i.searchCreation({query:s.creationQuery,type:s.creationSearchType,page:n},function(e){if(e.success){if(e.result.last_page!=s.lastSearchCreationPage){s.searchCreationPages=[];for(var t=0;t<e.result.last_page;t++)s.searchCreationPages.push(t+1)}s.lastSearchCreationPage=e.result.last_page,s.totalSearchCreation=e.result.total,e.result.current_page<=e.result.last_page?(s.currentSearchCreationPage=e.result.current_page,s.previousSearchCreationPage=null!=e.result.prev_page_url,s.nextSearchCreationPage=null!=e.result.next_page_url,s.searchCreations[s.currentSearchCreationPage]=e.result.data,s.creationViewFrame=s.searchCreations[s.currentSearchCreationPage]):(s.searchCreations.splice(e.result.current_page,1),angular.isDefined(s.creations[e.result.last_page])?(s.currentSearchCreationPage=e.result.last_page,s.previousSearchCreationPage=null!=e.result.prev_page_url,s.nextSearchCreationPage=!1,s.creationViewFrame=s.searchCreations[s.currentSearchCreationPage]):s.loadSearchCreation(e.result.last_page))}},function(e){}),s.searchCreations.splice(n+1,o-n+1);break}}for(var c in s.examsInMonth)if(s.examsInMonth.hasOwnProperty(c)){var u=s.examsInMonth[c];for(var l in u)if(u.hasOwnProperty(l)&&angular.isDefined(u[l].creations))for(r=u[l].creations.length,
n=0;n<r;n++)if(u[l].creations[n].id==e){s.examsInMonth[c][l].creations.splice(n,1),0==s.examsInMonth[c][l].creations.length&&delete s.examsInMonth[c][l].creations;break}}s.createMonthView(),s.createEventView()}})},s.deleteAction=function(e){var t=moment(e.pivot.begin_time,"YYYY-MM-DD H:m:s"),n=moment().diff(t,"months",!0);if(n>=s.examDeleteMonth){var r=e.id,o=a.open({animation:!0,templateUrl:"deleteExamModal.html",controller:"deleteExamCtrl",controllerAs:"deleteExamVm",keyboard:!1,backdrop:"static",resolve:{exam:function(){return{id:r,type:"action"}}}});o.result.then(function(e){if(e){var t,n,a,o=s.actions.length;for(t=1;t<o;t++)if(angular.isDefined(s.actions[t])){for(a=s.actions[t].length,n=0;n<a;n++)if(s.actions[t][n].id==r){s.actions[t].splice(n,1),s.totalAction--;break}if(n!=a){angular.isDefined(s.actions[t+1])?(s.actions[t].push(s.actions[t+1][0]),s.normalActionView&&(s.actionViewFrame=s.actions[t])):s.loadActionService=i.loadAction({page:t},function(e){if(e.success){if(e.result.last_page!=s.lastActionPage){s.actionPages=[];for(var t=0;t<e.result.last_page;t++)s.actionPages.push(t+1)}s.lastActionPage=e.result.last_page,s.totalAction=e.result.total,e.result.current_page<=e.result.last_page?(s.fromAction=e.result.from,s.toAction=e.result.to,s.currentActionPage=e.result.current_page,s.previousActionPage=null!=e.result.prev_page_url,s.nextActionPage=null!=e.result.next_page_url,s.actions[s.currentActionPage]=e.result.data,s.normalActionView&&(s.actionViewFrame=s.actions[s.currentActionPage])):(s.actions.splice(e.result.current_page,1),angular.isDefined(s.actions[e.result.last_page])?(s.fromAction=20*(e.result.last_page-1)+1,s.toAction=s.totalAction,s.currentActionPage=e.result.last_page,s.previousActionPage=null!=e.result.prev_page_url,s.nextActionPage=!1,s.normalActionView&&(s.actionViewFrame=s.actions[s.currentActionPage])):s.loadAction(e.result.last_page))}},function(e){}),s.actions.splice(t+1,o-t+1);break}}if(s.searchActionView)for(o=s.searchActions.length,t=1;t<o;t++)if(angular.isDefined(s.searchActions[t])){for(a=s.searchActions[t].length,n=0;n<a;n++)if(s.searchActions[t][n].id==r){s.searchActions[t].splice(n,1);break}if(n!=a){angular.isDefined(s.searchActions[t+1])?(s.searchActions[t].push(s.searchActions[t+1][0]),s.actionViewFrame=s.searchActions[t]):s.searchActionService=i.searchAction({query:s.actionQuery,type:s.actionSearchType,page:t},function(e){if(e.success){if(e.result.last_page!=s.lastSearchActionPage){s.searchActionPages=[];for(var t=0;t<e.result.last_page;t++)s.searchActionPages.push(t+1)}s.lastSearchActionPage=e.result.last_page,s.totalSearchAction=e.result.total,e.result.current_page<=e.result.last_page?(s.currentSearchActionPage=e.result.current_page,s.previousSearchActionPage=null!=e.result.prev_page_url,s.nextSearchActionPage=null!=e.result.next_page_url,s.searchActions[s.currentSearchActionPage]=e.result.data,s.actionViewFrame=s.searchActions[s.currentSearchActionPage]):(s.searchActions.splice(e.result.current_page,1),angular.isDefined(s.actions[e.result.last_page])?(s.currentSearchActionPage=e.result.last_page,s.previousSearchActionPage=null!=e.result.prev_page_url,s.nextSearchActionPage=!1,s.actionViewFrame=s.searchActions[s.currentSearchActionPage]):s.loadSearchAction(e.result.last_page))}},function(e){}),s.searchActions.splice(t+1,o-t+1);break}}for(var c in s.examsInMonth)if(s.examsInMonth.hasOwnProperty(c)){var u=s.examsInMonth[c];for(var l in u)if(u.hasOwnProperty(l)&&angular.isDefined(u[l].actions))for(a=u[l].actions.length,t=0;t<a;t++)if(u[l].actions[t].id==r){s.examsInMonth[c][l].actions.splice(t,1),0==s.examsInMonth[c][l].actions.length&&delete s.examsInMonth[c][l].actions;break}}s.createMonthView(),s.createEventView()}})}else a.open({animation:!0,templateUrl:"messageModal.html",controller:"messageCtrl",controllerAs:"messageVm",keyboard:!0,resolve:{data:function(){return{message:"Bài làm chỉ được xóa sau "+s.examDeleteMonth+" tháng."}}}})},e.$on("$locationChangeSuccess",function(e,t,n){t.split("#")[0]!=n.split("#")[0]&&(null!=s.loadCreationService&&s.loadCreationService.$cancelRequest(),null!=s.searchCreationService&&s.searchCreationService.$cancelRequest(),null!=s.loadActionService&&s.loadActionService.$cancelRequest(),null!=s.searchActionService&&s.searchActionService.$cancelRequest(),null!=s.loadExamsInMonthService&&s.loadExamsInMonthService.$cancelRequest())})}]),mainApp.controller("examImageUploadCtrl",["$scope","$timeout","Upload",function(e,t,n){var a=this;a.uploadMessage="",a.imageUrl=null,a.init=function(e){a.examId=e.examId},a.uploading=!1,a.progressImageUpload=0,a.upload=function(e){e&&!e.$error?(a.progressImageUpload=0,a.uploadMessage="File đang gửi đi...",a.uploading=!0,n.upload({url:"/u/image/exam/"+a.examId,data:{image:e}}).then(function(e){a.imageUrl="/image/"+e.data.imageName,a.uploadMessage="File đã gửi thành công.",a.progressImageUpload=95,t(function(){a.uploading=!1,a.uploadMessage="",a.progressImageUpload=100},2e3)},function(e){a.uploading=!1,t(function(){a.uploadMessage="Gặp lỗi trong quá trình gửi, vui lòng thử lại."},3e3)},function(e){a.progressImageUpload=parseInt(90*e.loaded/e.total)})):e&&e.$error&&(a.uploadMessage="File bị lỗi hoặc file không đúng định dạng.")},a.insertImage=function(){null!=a.imageUrl&&top.tinymce.activeEditor.windowManager.getParams().oninsert(a.imageUrl),top.tinymce.activeEditor.windowManager.close()},a.cancel=function(){top.tinymce.activeEditor.windowManager.close()}}]),mainApp.controller("mathtypeCtrl",["$scope","$sce","$document",function(e,t,n){MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"CommonHTML"]),n.on("keydown",function(e){"Escape"!=e.key&&"Esc"!=e.key||top.tinymce.activeEditor.windowManager.close()});var a=this;a.equation="",a.blockDisplay=!1,a.mathEditorElm=$("#mathEditor"),a.mathEditorElm.focus(),a.insertEquation=function(e){var t,n=rangy.getSelection();if(n.rangeCount){t=n.getRangeAt(0);var i=t.commonAncestorContainer,s=$(i).closest("#mathEditor");0==s.length&&(a.mathEditorElm.focus(),n=rangy.getSelection(),n.selectAllChildren(a.mathEditorElm[0]),n.collapseToEnd(),t=n.getRangeAt(0));var r=document.createTextNode(e+" ");t.deleteContents(),t.insertNode(r),t.setStart(r,r.length),t.setEnd(r,r.length),n.removeAllRanges(),n.addRange(t),a.mathEditorElm.change()}},a.symbolGroupList=[{id:"1",name:"Kí hiệu cơ bản",symbolArr:[{code:"&plusmn;",tex:"\\pm"},{code:"&times;",tex:"\\times"},{code:"&divide;",tex:"\\div"},{code:"&ne;",tex:"\\neq"},{code:"&sim;",tex:"\\sim"},{code:"&asymp;",tex:"\\approx"},{code:"&equiv;",tex:"\\equiv"},{code:"&#x221D;",tex:"\\propto"},{code:"&infin;",tex:"\\infty"},{code:"&ge;",tex:"\\geq"},{code:"&le;",tex:"\\leq"},{code:"&forall;",tex:"\\forall"},{code:"&exist;",tex:"\\exists"},{code:"&#x2204;",tex:"\\nexists"},{code:"&isin;",tex:"\\in"},{code:"&ni;",tex:"\\ni"},{code:"&notin;",tex:"\\notin"},{code:"&cup;",tex:"\\cup"},{code:"&cap;",tex:"\\cap"},{code:"&sub;",tex:"\\subset"},{code:"&sup;",tex:"\\supset"},{code:"&nsub;",tex:"\\not\\subset"},{code:"&empty;",tex:"\\emptyset"},{code:"&#x2190;",tex:"\\rightarrow"},{code:"&#x2191;",tex:"\\uparrow"},{code:"&#x2192;",tex:"\\leftarrow"},{code:"&#x2193;",tex:"\\downarrow"},{code:"&#x2194;",tex:"\\leftrightarrow"},{code:"&#x21D0;",tex:"\\Rightarrow"},{code:"&#x21D2;",tex:"\\Leftarrow"},{code:"&#x21D4;",tex:"\\Leftrightarrow"},{code:"&#x226B;",tex:"\\gg"},{code:"&#x226A;",tex:"\\ll"},{code:"&#x03B1;",tex:"\\alpha"},{code:"&#x03B2;",tex:"\\beta"},{code:"&#x03B3;",tex:"\\gamma"},{code:"&#x03B4;",tex:"\\delta"},{code:"&#x03B5;",tex:"\\varepsilon"},{code:"&#x03B8;",tex:"\\theta"},{code:"&#x03D1;",tex:"\\vartheta"},{code:"&#x00B5;",tex:"\\mu"},{code:"&#x03C0;",tex:"\\pi"},{code:"&#x03C6;",tex:"\\varphi"},{code:"&#x03C9;",tex:"\\omega"},{code:"&#x03C3;",tex:"\\sigma"},{code:"&#x03C1;",tex:"\\rho"},{code:"&#x03F5;",tex:"\\epsilon"},{code:"&#x03BE;",tex:"\\xi"},{code:"&#x2126;",tex:"\\Omega"},{code:"&#x03A6;",tex:"\\Phi"},{code:"&#x03A3;",tex:"\\Sigma"},{code:"&#x0394;",tex:"\\Delta"},{code:"&#x0398;",tex:"\\Theta"},{code:"&#x03A0;",tex:"\\Pi"},{code:"&#x0393;",tex:"\\Gamma"},{code:"&#x039B;",tex:"\\Lambda"},{code:"&#x22EF;",tex:"\\cdots"},{code:"&#x22EE;",tex:"\\vdots"},{code:"&#x22F1;",tex:"\\ddots"}]},{id:"2",name:"Kí tự la mã",symbolArr:[{code:"&#x3B1;",tex:"\\alpha"},{code:"&#x3B2;",tex:"\\beta"},{code:"&#x3C7;",tex:"\\chi"},{code:"&#x3B4;",tex:"\\delta"},{code:"&#x3B5;",tex:"\\epsilon"},{code:"&#x3B7;",tex:"\\eta"},{code:"&#x3B3;",tex:"\\gamma"},{code:"&#x3B9;",tex:"\\iota"},{code:"&#x3BA;",tex:"\\kappa"},{code:"&#x03BB;",tex:"\\lambda"},{code:"&#x03BC;",tex:"\\mu"},{code:"&#x03BD;",tex:"\\nu"},{code:"&#x03A9;",tex:"\\omega"},{code:"&#x03D5;",tex:"\\phi"},{code:"&#x03C0;",tex:"\\pi"},{code:"&#x03C8;",tex:"\\psi"},{code:"&#x03A1;",tex:"\\rho"},{code:"&#x03C3;",tex:"\\sigma"},{code:"&#x03A4;",tex:"\\tau"},{code:"&#x03B8;",tex:"\\theta"},{code:"&#x03C5;",tex:"\\upsilon"},{code:"&#x03BE;",tex:"\\xi"},{code:"&#x0396;",tex:"\\zeta"},{code:"&#x03DC;",tex:"\\digamma"},{code:"&#x03F0;",tex:"\\varkappa"},{code:"&#x03C6;",tex:"\\varphi"},{code:"&#x03D6;",tex:"\\varpi"},{code:"&#x03F1;",tex:"\\varrho"},{code:"&#x03C2;",tex:"\\varsigma"},{code:"&#x03D1;",tex:"\\vartheta"},{code:"&#x0394;",tex:"\\Delta"},{code:"&#x0393;",tex:"\\Gamma"},{code:"&#x039B;",tex:"\\Lambda"},{code:"&#x03A9;",tex:"\\Omega"},{code:"&#x03A6;",tex:"\\Phi"},{code:"&#x03A0;",tex:"\\Pi"},{code:"&#x03A8;",tex:"\\Psi"},{code:"&#x03A3;",tex:"\\Sigma"},{code:"&#x0398;",tex:"\\Theta"},{code:"&#x03A5;",tex:"\\Upsilon"},{code:"&#x039E;",tex:"\\Xi"},{code:"&#x2135;",tex:"\\aleph"},{code:"&#x2136;",tex:"\\beth"},{code:"&#x2138;",tex:"\\daleth"},{code:"&#x2137;",tex:"\\gimel"}]},{id:"3",name:"Kí tự toán tử",symbolArr:[{code:"&#x2211;",tex:"\\sum"},{code:"&#x220F;",tex:"\\prod"},{code:"&#x2210;",tex:"\\coprod"},{code:"&#x222B;",tex:"\\int"},{code:"&#x222E;",tex:"\\oint"},{code:"&#x222C;",tex:"\\iint"},{code:"&#x2A04;",tex:"\\biguplus"},{code:"&#x22C2;",tex:"\\bigcap"},{code:"&#x22C3;",tex:"\\bigcup"},{code:"&#x2A01;",tex:"\\bigoplus"},{code:"&#x2A02;",tex:"\\bigotimes"},{code:"&#x2A00;",tex:"\\bigodot"},{code:"&#x22C1;",tex:"\\bigvee"},{code:"&#x22C0;",tex:"\\bigwedge"},{code:"&#x2A06;",tex:"\\bigsqcup"}]},{id:"4",name:"Kí tự phân chia",symbolArr:[{code:"&#x007C;",tex:"\\vert"},{code:"&#x2016;",tex:"\\Vert"},{code:"&#x2329;",tex:"\\langle"},{code:"&#x232A;",tex:"\\rangle"},{code:"&#x230A;",tex:"\\lfloor"},{code:"&#x230B;",tex:"\\rfloor"},{code:"&#x2308;",tex:"\\lceil"},{code:"&#x2309;",tex:"\\rceil"},{code:"&#x231E;",tex:"\\llcorner"},{code:"&#x231F;",tex:"\\lrcorner"},{code:"&#x231C;",tex:"\\ulcorner"},{code:"&#x231D;",tex:"\\urcorner"}]},{id:"5",name:"Toán tử",symbolArr:[{code:"&#x002A;",tex:"\\ast"},{code:"&#x22C6;",tex:"\\star"},{code:"&#x00B7;",tex:"\\cdot"},{code:"&#x2218;",tex:"\\circ"},{code:"&#x2219;",tex:"\\bullet"},{code:"&#x25CB;",tex:"\\bigcirc"},{code:"&#x22C4;",tex:"\\diamond"},{code:"&#x007D;",tex:"\\times"},{code:"&#x00F7;",tex:"\\div"},{code:"&#x2B1D;",tex:"\\centerdot"},{code:"&#x229B;",tex:"\\circledast"},{code:"&#x229A;",tex:"\\circledcirc"},{code:"&#x229D;",tex:"\\circleddash"},{code:"&#x2214;",tex:"\\dotplus"},{code:"&#x22C7;",tex:"\\divideontimes"},{code:"&#x00B1;",tex:"\\pm"},{code:"&#x2213;",tex:"\\mp"},{code:"&#x2A3F;",tex:"\\amalg"},{code:"&#x2299;",tex:"\\odot"},{code:"&#x2296;",tex:"\\ominus"},{code:"&#x2295;",tex:"\\oplus"},{code:"&#x2298;",tex:"\\oslash"},{code:"&#x2297;",tex:"\\otimes"},{code:"&#x2240;",tex:"\\wr"},{code:"&#x229E;",tex:"\\boxplus"},{code:"&#x229F;",tex:"\\boxminus"},{code:"&#x22A0;",tex:"\\boxtimes"},{code:"&#x22A1;",tex:"\\boxdot"},{code:"&#x25A1;",tex:"\\square"},{code:"&#x2229;",tex:"\\cap"},{code:"&#x222A;",tex:"\\cup"},{code:"&#x228E;",tex:"\\uplus"},{code:"&#x2293;",tex:"\\sqcap"},{code:"&#x2294;",tex:"\\sqcup"},{code:"&#x2227;",tex:"\\wedge"},{code:"&#x2228;",tex:"\\vee"},{code:"&#x2020;",tex:"\\dagger"},{code:"&#x2021;",tex:"\\ddagger"},{code:"&#x2305;",tex:"\\barwedge"},{code:"&#x22CF;",tex:"\\curlywedge"},{code:"&#x22D2;",tex:"\\Cap"},{code:"&#x22A5;",tex:"\\bot"},{code:"&#x22BA;",tex:"\\intercal"},{code:"&#x2A5E;",tex:"\\doublebarwedge"},{code:"&#x25C1;",tex:"\\lhd"},{code:"&#x25B7;",tex:"\\rhd"},{code:"&#x25C3;",tex:"\\triangleleft"},{code:"&#x25B9;",tex:"\\triangleright"},{code:"&#x22B4;",tex:"\\unlhd"},{code:"&#x22B5;",tex:"\\unrhd"},{code:"&#x25BD;",tex:"\\bigtriangledown"},{code:"&#x25B3;",tex:"\\bigtriangleup"},{code:"&#x2216;",tex:"\\setminus"},{code:"&#x22BB;",tex:"\\veebar"},{code:"&#x22CE;",tex:"\\curlyvee"},{code:"&#x22D3;",tex:"\\Cup"},{code:"&#x22A4;",tex:"\\top"},{code:"&#x22CC;",tex:"\\rightthreetimes"},{code:"&#x22CB;",tex:"\\leftthreetimes"}]},{id:"6",name:"Mũi tên",symbolArr:[{code:"&#x2190;",tex:"\\leftarrow"},{code:"&#x21D0;",tex:"\\Leftarrow"},{code:"&#x2192;",tex:"\\rightarrow"},{code:"&#x21D2;",tex:"\\Rightarrow"},{code:"&#x2194;",tex:"\\leftrightarrow"},{code:"&#x21D4;",tex:"\\Leftrightarrow"},{code:"&#x27F5;",tex:"\\longleftarrow"},{code:"&#x27F8;",tex:"\\Longleftarrow"},{code:"&#x27F6;",tex:"\\longrightarrow"},{code:"&#x27F9;",tex:"\\Longrightarrow"},{code:"&#x27F7;",tex:"\\longleftrightarrow"},{code:"&#x27FA;",tex:"\\Longleftrightarrow"},{code:"&#x2191;",tex:"\\uparrow"},{code:"&#x21D1;",tex:"\\Uparrow"},{code:"&#x2193;",tex:"\\downarrow"},{code:"&#x21D3;",tex:"\\Downarrow"},{code:"&#x2195;",tex:"\\updownarrow"},{code:"&#x21D1;",tex:"\\Updownarrow"},{code:"&#x21BC;",tex:"\\leftharpoonup"},{code:"&#x21BD;",tex:"\\leftharpoondown"},{code:"&#x21C0;",tex:"\\rightharpoonup"},{code:"&#x21C1;",tex:"\\rightharpoondown"},{code:"&#x21CC;",tex:"\\rightleftharpoons"},{code:"&#x21C6;",tex:"\\leftrightarrows"},{code:"&#x2197;",tex:"\\nearrow"},{code:"&#x2198;",tex:"\\searrow"},{code:"&#x2199;",tex:"\\swarrow"},{code:"&#x2196;",tex:"\\nwarrow"}]},{id:"7",name:"Khác",symbolArr:[{code:"&#x221E;",tex:"\\infty"},{code:"&#x2207;",tex:"\\nabla"},{code:"&#x2202;",tex:"\\partial"},{code:"&#x2204;",tex:"\\nexists"},{code:"&#x2205;",tex:"\\varnothing"},{code:"&#x266F;",tex:"\\sharp"},{code:"&#x266D;",tex:"\\flat"},{code:"&#x266E;",tex:"\\natural"},{code:"&#x221A;",tex:"\\surd"},{code:"&#x2220;",tex:"\\angle"},{code:"&#x2221;",tex:"\\measuredangle"},{code:"&#x2222;",tex:"\\sphericalangle"},{code:"&#x2201;",tex:"\\complement"},{code:"&#x25BF;",tex:"\\triangledown"},{code:"&#x25B5;",tex:"\\vartriangle"},{code:"&#x25AA;",tex:"\\blacksquare"},{code:"&#x25B4;",tex:"\\blacktriangle"},{code:"&#x25BE;",tex:"\\blacktriangledown"}]}],a.selectedSymbolGroup=a.symbolGroupList[0],a.fractionGroup=[{type:0,heading:"Kiểu phân số"},{type:1,items:[{id:"fraction1",tex:"\\frac{x}{y}"},{id:"fraction2",tex:"{x}/{y}"}]},{type:0,heading:"Mẫu phổ biến"},{type:1,items:[{id:"fraction3",tex:"\\frac{dx}{dy}"},{id:"fraction4",tex:"\\frac{\\Delta x}{\\Delta y}"},{id:"fraction5",tex:"\\frac{\\partial x}{\\partial y}"},{id:"fraction6",tex:"\\frac{\\delta x}{\\delta y}"},{id:"fraction7",tex:"\\frac{\\pi }{2}"}]}],a.scriptGroup=[{type:0,heading:"Kiểu hàm mũ"},{type:1,items:[{id:"script1",tex:"e^{x}"},{id:"script2",tex:"e_{y}"},{id:"script3",tex:"e_{y}^{x}"},{id:"script4",tex:"_{y}^{x}e"}]},{type:0,heading:"Mẫu phổ biến"},{type:1,items:[{id:"script5",tex:"x_{y^{2}}"},{id:"script6",tex:"e^{-i\\omega t}"},{id:"script7",tex:"x^{2}"}]}],a.radicalGroup=[{type:0,heading:"Kiểu hàm căn"},{type:1,items:[{id:"radical1",tex:"\\sqrt{x}"},{id:"radical2",tex:"\\sqrt[n]{x}"}]},{type:0,heading:"Mẫu phổ biến"},{type:1,items:[{id:"radical3",tex:"\\frac{-b\\pm \\sqrt{\\Delta}}{2a}"},{id:"radical4",tex:"\\sqrt{a^{2}+b^{2}}"}]}],a.integralGroup=[{type:0,heading:"Kiểu tích phân"},{type:1,items:[{id:"integral1",tex:"\\int{u}"},{id:"integral2",tex:"\\int_{a}^{b}{u}"},{id:"integral3",tex:"\\int\\limits_{a}^{b}{u}"}]},{type:1,items:[{id:"integral4",tex:"\\iint{u}"},{id:"integral5",tex:"\\iint_{a}^{b}{u}"},{id:"integral6",tex:"\\iint\\limits_{a}^{b}{u}"}]},{type:1,items:[{id:"integral7",tex:"\\oint{u}"},{id:"integral8",tex:"\\oint_{a}^{b}{u}"},{id:"integral9",tex:"\\oint\\limits_{a}^{b}{u}"}]}],a.largeOperatorGroup=[{type:0,heading:"Kiểu tổng"},{type:1,items:[{id:"largeOperator1",tex:"\\sum{u}"},{id:"largeOperator2",tex:"\\sum\\limits_{i=0}^{n}{u}"},{id:"largeOperator3",tex:"\\sum_{i=0}^{n}{u}"},{id:"largeOperator4",tex:"\\sum\\limits_{i}{u}"},{id:"largeOperator5",tex:"\\sum_{i}{u}"}]},{type:0,heading:"Kiểu tích"},{type:1,items:[{id:"largeOperator6",tex:"\\prod{u}"},{id:"largeOperator7",tex:"\\prod\\limits_{i=0}^{n}{u}"},{id:"largeOperator8",tex:"\\prod_{i=0}^{n}{u}"},{id:"largeOperator9",tex:"\\prod\\limits_{i}{u}"},{id:"largeOperator10",tex:"\\prod_{i}{u}"}]},{type:0,heading:"Kiểu hợp, giao"},{type:1,items:[{id:"largeOperator11",tex:"\\bigcap\\limits_{a}^{b}{u}"},{id:"largeOperator12",tex:"\\bigcup\\limits_{a}^{b}{u}"},{id:"largeOperator13",tex:"\\bigwedge\\limits_{a}^{b}{u}"},{id:"largeOperator14",tex:"\\bigvee\\limits_{a}^{b}{u}"}]},{type:0,heading:"Mẫu phổ biến"},{type:1,items:[{id:"largeOperator15",tex:"\\displaystyle\\sum\\limits_{k}\\left(\\begin{matrix}{n}\\\\{k}\\end{matrix}\\right)"},{id:"largeOperator16",tex:"\\sum\\limits_{\\substack{0\\leq i\\leq m \\\\ 0\\leq j\\leq n}}{P(i,j)}"},{id:"largeOperator17",tex:"\\prod\\limits_{k=1}^{n}{A_{k}}"},{id:"largeOperator18",tex:"\\bigcup\\limits_{n=1}^{m}{X_{n}\\cap Y_{n}}"}]}],a.bracketGroup=[{type:0,heading:"Kiểu dấu ngoặc"},{type:1,items:[{id:"bracket1",tex:"(s)"},{id:"bracket2",tex:"[s]"},{id:"bracket3",tex:"\\{s\\}"},{id:"bracket4",tex:"|s|"},{id:"bracket5",tex:"\\|s\\|"},{id:"bracket6",tex:"\\lceil s\\rceil"},{id:"bracket7",tex:"\\lfloor s\\rfloor"},{id:"bracket8",tex:"\\langle s\\rangle"}]},{type:0,heading:"Kiểu dấu ngoặc lớn"},{type:1,items:[{id:"bracket9",tex:"\\left(s\\right)"},{id:"bracket10",tex:"\\left[s\\right]"},{id:"bracket11",tex:"\\left\\{s\\right\\}"},{id:"bracket12",tex:"\\left|s\\right|"},{id:"bracket13",tex:"\\left\\|s\\right\\|"},{id:"bracket14",tex:"\\left\\lceil s\\right\\rceil"},{id:"bracket15",tex:"\\left\\lfloor s\\right\\rfloor"}]},{type:0,heading:"Kiểu nhóm"},{type:1,items:[{id:"bracket16",tex:"\\begin{cases}{x}\\\\{y}\\end{cases}"},{id:"bracket17",tex:"\\begin{cases}{x}\\\\{y}\\\\{z}\\end{cases}"},{id:"bracket18",tex:"\\left[\\begin{matrix}{x}\\\\{y}\\end{matrix}\\right."},{id:"bracket19",tex:"\\left[\\begin{matrix}{x}\\\\{y}\\\\{z}\\end{matrix}\\right."}]},{type:0,heading:"Mẫu phổ biến"},{type:1,items:[{id:"bracket20",tex:"f(x)=\\begin{cases}{-x,}&\\quad{x<0}\\\\{x,}&\\quad{x\\geq 0}\\end{cases}"}]},{type:1,items:[{id:"bracket21",tex:"f(u)=\\begin{cases}{x}&\\quad\\text{nếu n chẵn}\\\\{y}&\\quad\\text{nếu n lẽ}\\end{cases}"}]}],a.sinLimGroup=[{type:0,heading:"Kiểu lượng giác"},{type:1,items:[{id:"sinLim1",tex:"\\sin{x}"},{id:"sinLim2",tex:"\\cos{x}"},{id:"sinLim3",tex:"\\tan{x}"},{id:"sinLim4",tex:"\\csc{x}"},{id:"sinLim5",tex:"\\sec{x}"},{id:"sinLim6",tex:"\\cot{x}"}]},{type:0,heading:"Kiểu lượng giác đảo"},{type:1,items:[{id:"sinLim7",tex:"\\sin^{-1}{x}"},{id:"sinLim8",tex:"\\cos^{-1}{x}"},{id:"sinLim9",tex:"\\tan^{-1}{x}"}]},{type:1,items:[{id:"sinLim10",tex:"\\csc^{-1}{x}"},{id:"sinLim11",tex:"\\sec^{-1}{x}"},{id:"sinLim12",tex:"\\cot^{-1}{x}"}]},{type:0,heading:"Kiểu giới hạn"},{type:1,items:[{id:"sinLim13",tex:"\\lim_{n\\to\\infty}{u}"},{id:"sinLim14",tex:"\\log{u}"},{id:"sinLim15",tex:"\\log_{a}{b}"}]},{type:1,items:[{id:"sinLim16",tex:"\\ln{a}"},{id:"sinLim17",tex:"\\min_{a}{b}"},{id:"sinLim18",tex:"\\max_{a}{b}"}]},{type:0,heading:"Mẫu phổ biến"},{type:1,items:[{id:"sinLim19",tex:"\\sin{\\theta}"},{id:"sinLim20",tex:"\\cos{2x}"},{id:"sinLim21",tex:"\\tan{\\theta}=\\frac{\\sin{\\theta}}{\\cos{\\theta}}"},{id:"sinLim22",tex:"\\lim_{n\\to\\infty}\\left(1+\\frac{1}{n}\\right)^{n}"}]}],a.reactGroup=[{type:0,heading:"Kiểu nón"},{type:1,items:[{id:"react1",tex:"\\overrightarrow{a}"},{id:"react2",tex:"\\overleftarrow{a}"},{id:"react3",tex:"\\overleftrightarrow{a}"},{id:"react4",tex:"\\mathop{a}\\limits^{\\leftharpoonup}"},{id:"react5",tex:"\\mathop{a}\\limits^{\\rightharpoonup}"}]},{type:1,items:[{id:"react6",tex:"\\widetilde{a}"},{id:"react7",tex:"\\overline{a}"},{id:"react8",tex:"\\widehat{a}"},{id:"react9",tex:"\\stackrel\\smile{a}"},{id:"react10",tex:"\\stackrel\\frown{a}"}]},{type:0,heading:"Kiểu phương trình"},{type:1,items:[{id:"react11",tex:"A\\stackrel{x}{\\rightarrow}B"},{id:"react12",tex:"A\\stackrel{x}{\\leftarrow}B"},{id:"react13",tex:"A\\mathop{\\leftrightarrow}\\limits_{x}B"},{id:"react14",tex:"A\\stackrel{x}{\\leftrightarrow}B"}]},{type:1,items:[{id:"react15",tex:"A\\mathop{\\Leftarrow}\\limits_{x}B"},{id:"react16",tex:"A\\mathop{\\Rightarrow}\\limits_{x}B"},{id:"react17",tex:"A\\stackrel{x}{\\Leftarrow}B"},{id:"react18",tex:"A\\stackrel{x}{\\Rightarrow}B"}]},{type:1,items:[{id:"react19",tex:"A\\mathop{\\Leftrightarrow}\\limits_{x}B"},{id:"react20",tex:"A\\stackrel{x}{\\Leftrightarrow}B"},{id:"react21",tex:"A\\stackrel{x}{=}B"}]}],a.matrixGroup=[{type:0,heading:"Kiểu ma trận"},{type:1,items:[{id:"matrix1",tex:"\\begin{matrix}{x}&{y}\\end{matrix}"},{id:"matrix2",tex:"\\begin{matrix}{x}\\\\{y}\\end{matrix}"},{id:"matrix3",tex:"\\begin{matrix}{x}&{y}&{z}\\end{matrix}"},{id:"matrix4",tex:"\\begin{matrix}{x}\\\\{y}\\\\{z}\\end{matrix}"}]},{type:1,items:[{id:"matrix5",tex:"\\begin{matrix}{x}&{z}\\\\{y}&{t}\\end{matrix}"},{id:"matrix6",tex:"\\begin{matrix}{x}&{y}&{z}\\\\{t}&{u}&{v}\\end{matrix}"},{id:"matrix7",tex:"\\begin{matrix}{x}&{t}\\\\{y}&{u}\\\\{z}&{v}\\end{matrix}"},{id:"matrix8",tex:"\\begin{matrix}{x}&{t}&{l}\\\\{y}&{u}&{m}\\\\{z}&{v}&{n}\\end{matrix}"}]},{type:0,heading:"Kiểu ma trận có ngoặc"},{type:1,items:[{id:"matrix9",tex:"\\begin{pmatrix}{x}&{z}\\\\{y}&{t}\\end{pmatrix}"},{id:"matrix10",tex:"\\begin{bmatrix}{x}&{z}\\\\{y}&{t}\\end{bmatrix}"},{id:"matrix11",tex:"\\begin{vmatrix}{x}&{z}\\\\{y}&{t}\\end{vmatrix}"},{id:"matrix12",tex:"\\begin{Vmatrix}{x}&{z}\\\\{y}&{t}\\end{Vmatrix}"}]},{type:0,heading:"Kiểu ma trận thưa"},{type:1,items:[{id:"matrix13",tex:"\\begin{pmatrix}{x} & \\cdots & {u}\\\\ \\vdots & \\ddots & \\vdots\\\\ {y} & \\cdots & {v}\\end{pmatrix}"},{id:"matrix14",tex:"\\begin{bmatrix}{x} & \\cdots & {u}\\\\ \\vdots & \\ddots & \\vdots\\\\ {y} & \\cdots & {v}\\end{bmatrix}"}]}],a.chemGroup=[{type:0,heading:"Thư viện hóa học mhchm"},{type:1,items:[{id:"chem1",tex:"\\ce{A v -> B ^}"}]},{type:1,items:[{id:"chem2",tex:"\\ce{SO4^21- + Ba^2+ -> BaSO4 v}"}]},{type:1,items:[{id:"chem3",tex:"\\ce{ CO2 + C <=> 2CO }"}]},{type:1,items:[{id:"chem4",tex:"\\ce{Hg^2+ ->[I-]$\\underset{\\mathrm{red}}{\\ce{HgI2}}$->[I-]$\\underset{\\mathrm{red}}{\\ce{[Hg^{II}I4]^2-}}$}"}]}],a.equationGroups1=[{name:"fractionGroup",detail:a.fractionGroup},{name:"scriptGroup",detail:a.scriptGroup},{name:"radicalGroup",detail:a.radicalGroup},{name:"integralGroup",detail:a.integralGroup},{name:"largeOperatorGroup",detail:a.largeOperatorGroup}],a.equationGroups2=[{name:"bracketGroup",detail:a.bracketGroup},{name:"sinLimGroup",detail:a.sinLimGroup},{name:"reactGroup",detail:a.reactGroup},{name:"matrixGroup",detail:a.matrixGroup},{name:"chemGroup",detail:a.chemGroup}],a.renderHtml=function(e){return t.trustAsHtml(e)},a.finish=function(){if(""!=a.equation){var e=a.equation;e=e.trim(),e=e.replace(/<|>|&/g,function(e){switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;"}}),top.tinymce.activeEditor.windowManager.getParams().oninsert(e,a.blockDisplay)}top.tinymce.activeEditor.windowManager.close()},a.cancel=function(){top.tinymce.activeEditor.windowManager.close()}}]),mainApp.controller("activateEmailCtrl",["$scope","$uibModalInstance","ProfileService","email",function(e,t,n,a){var i=this;i.email=a,i.activateCode="",i.statusMessage="",i.processing=!1,i.status=0,n.sendActivateEmail({},{},function(e){i.status=e.success?1:-1},function(e){i.status=-1}),i.cancel=function(){t.close(!1)},i.finish=function(){return""==i.activateCode||16!=i.activateCode.length?void(i.statusMessage="Mã kích hoạt không hợp lệ"):(i.processing=!0,i.statusMessage="Hệ thống đang xử lý, vui lòng đợi trong giây lát...",void n.activate({e:i.email,code:i.activateCode},function(e){e.success?t.close(!0):i.statusMessage="Mã kích hoạt không khớp.",i.processing=!1},function(e){i.statusMessage="Lỗi kiểm tra mã kích hoạt.",i.processing=!1}))}}]),mainApp.controller("editPrivateCodeCtrl",["$scope","$uibModalInstance","ProfileService",function(e,t,n){var a=this;a.code="",a.statusMessage="",a.processing=!1,a.cancel=function(){t.close({success:!1,code:a.code})},a.finish=function(){return""==a.code||8!=a.code.length?void(a.statusMessage="Mã không hợp lệ"):(a.processing=!0,a.statusMessage="Hệ thống đang kiểm tra mã...",void n.verifyCode({},{code:a.code},function(e){e.success?t.close({success:!0,code:a.code}):a.statusMessage="Mã không khớp.",a.processing=!1},function(e){a.statusMessage="Lỗi kiểm tra mã.",a.processing=!1}))}}]),mainApp.controller("editPrivateCtrl",["$scope","$uibModalInstance","ProfileService","privateData",function(e,t,n,a){var i=this;i.fieldString="id_card"==a.field?"CMND":"telephone"==a.field?"Số điện thoại":"Số tài khoản",i.feild=a.field,i.currentValue=a.value,i.code=a.code,i.value="",i.statusMessage="",i.processing=!1,i.cancel=function(){t.close({success:!1,newValue:""})},i.finish=function(){if(i.value.length>255)return void(i.statusMessage="Giá trị không hợp lệ");if(i.value==i.currentValue)return void(i.statusMessage="Giá trị không thay đổi");i.processing=!0,i.statusMessage="Đang lưu thông tin cập nhật...";var e={};e.verification_code=i.code,e[i.feild]=i.value,n.save({},e,function(e){e.success?t.close({success:!0,newValue:i.value}):i.statusMessage="Giá trị không khớp.",i.processing=!1},function(e){i.statusMessage="Lỗi kiểm tra mã.",i.processing=!1})}}]),mainApp.controller("editPrivatePasswordCtrl",["$scope","$uibModalInstance","ProfileService",function(e,t,n){var a=this;a.password="",a.statusMessage="",a.processing=!1,a.cancel=function(){t.close(!1)},a.finish=function(){return""==a.password||a.password.length<8||a.password.length>255?void(a.statusMessage="Mật khẩu không hợp lệ"):(a.processing=!0,a.statusMessage="Hệ thống đang xử lý, vui lòng đợi trong giây lát...",void n.verifyPassword({},{password:a.password},function(e){e.success?t.close(!0):a.statusMessage="Mật khẩu không khớp.",a.processing=!1},function(e){a.statusMessage="Lỗi kiểm tra mật khẩu.",a.processing=!1}))}}]),mainApp.controller("editProfileCtrl",["$scope","$timeout","$window","$uibModal","Upload","ProfileService",function(e,t,n,a,i,s){var r=this;r.months=["Tháng 1","Tháng 2","Tháng 3","Tháng 4","Tháng 5","Tháng 6","Tháng 7","Tháng 8","Tháng 9","Tháng 10","Tháng 11","Tháng 12"],r.init=function(e){r.userId=e.userId,r.avatar=e.avatar,r.lastName=e.lastName,r.firstName=e.firstName,r.gender=e.gender,r.birth={},r.birth.day=e.birthDay,r.birth.month=e.birthMonth,r.birth.year=e.birthYear,r.birthdate=e.birthDate,r.idCard=e.idCard,r.about=e.about,r.school=e.school,r.studentId=e.studentId,r.position=e.position,r.fields=e.fields,r.telephone=e.telephone,r.address=e.address,r.facebook=e.facebook,r.twitter=e.twitter,r.bank=e.bank,r.bankId=e.bankId,r.emptyIdCard=""==e.idCard,r.emptyTelephone=""==e.telephone,r.emptyBankId=""==e.bankId},r.submit=function(e){if(e){var a={},i=!1;""!=r.idCard&&r.emptyIdCard&&(a.id_card=r.idCard,i=!0),""!=r.telephone&&r.emptyTelephone&&(a.telephone=r.telephone,i=!0),a.bank_id=r.bankId,i=!0,i?(r.statusMessage="Đang lưu...",s.save({},a,function(e){e.success?(r.statusMessage="Đã lưu.",n.location.href="/profile/show/"+r.userId):r.statusMessage="Không lưu được."},function(e){422==e.status?(r.statusMessage="Dữ liệu không hợp lệ...",t(function(){r.statusMessage=""},5e3)):r.statusMessage="Không lưu được..."})):n.location.href="/profile/show/"+r.userId}},r.avatarProgress=!1,r.progressImageUpload=0,r.upload=function(e){e&&!e.$error&&(r.progressImageUpload=0,r.avatarProgress=!0,i.upload({url:"/u/profile/avatar",data:{avatar:e}}).then(function(e){r.avatar=e.data.avatar+"?"+(new Date).getTime(),r.progressImageUpload=95,t(function(){r.avatarProgress=!1,r.progressImageUpload=100},100)},function(e){r.avatarProgress=!1},function(e){r.progressImageUpload=parseInt(90*e.loaded/e.total)}))},r.statusMessage="",r.update=function(e,n,a){if(e&&"id_card"!=n&&"telephone"!=n&&"bank_id"!=n){var i={};i[n]=a,r.statusMessage="Đang lưu...",s.save({},i,function(e){e.success?r.statusMessage="Đã lưu.":r.statusMessage="Không lưu được.",t(function(){r.statusMessage=""},2e3)},function(e){422==e.status?(r.statusMessage="Dữ liệu không hợp lệ...",t(function(){r.statusMessage=""},5e3)):r.statusMessage="Không lưu được..."})}},r.updatePrivateData=function(e,t){var n=a.open({animation:!0,templateUrl:"editPrivatePasswordModal.html",controller:"editPrivatePasswordCtrl",controllerAs:"editPrivatePasswordVm",keyboard:!0});n.result.then(function(n){if(n){var i=a.open({animation:!0,templateUrl:"editPrivateCodeModal.html",controller:"editPrivateCodeCtrl",controllerAs:"editPrivateCodeVm",keyboard:!1,backdrop:"static"});i.result.then(function(n){if(n.success){var i=a.open({animation:!0,templateUrl:"editPrivateModal.html",controller:"editPrivateCtrl",controllerAs:"editPrivateVm",keyboard:!1,backdrop:"static",resolve:{privateData:function(){var a={};return a.field=e,a.value=t,a.code=n.code,a}}});i.result.then(function(t){if(t.success)switch(e){case"id_card":r.idCard=t.newValue;break;case"telephone":r.telephone=t.newValue;break;case"bank_id":r.bankId=t.newValue}})}})}})}}]),mainApp.controller("showProfileCtrl",["$scope","$window","$timeout","$uibModal","ProfileService",function(e,t,n,a,i){var s=this;s.query="",s.init=function(e){s.loggedIn=e.loggedIn,s.userId=e.userId,s.vote=e.vote,s.voteNumStr="("+e.voteNum+")",s.email=e.email,s.activated=e.activated},s.searchExam=function(){s.query=s.query.trim(),0!==s.query.length&&(t.location.href="/search?q="+s.query)},s.voteMessage="",s.hoverRating=0,s.clickStar=function(e){s.loggedIn?(s.voteMessage="(Đang cập nhật bình chọn)",i.vote({userId:s.userId},{vote_point:e},function(e){e.success?(s.voteMessage="(Đã thực hiện bình chọn)",s.voteNum="("+e.voteNum+")"):s.voteMessage=e.message},function(e){n(function(){s.voteMessage="(Không kết nối được với server)"},5e3)})):n(function(){s.voteMessage="(Bạn cần đăng nhập để bình chọn)"},5e3)},s.mouseHoverStar=function(e){s.hoverRating=e},s.mouseLeaveStar=function(e){s.hoverRating=e+"*"},s.activateEmail=function(){var e=a.open({animation:!0,templateUrl:"activateEmailModal.html",controller:"activateEmailCtrl",controllerAs:"activateEmailVm",keyboard:!0,resolve:{email:function(){return s.email}}});e.result.then(function(e){e&&(s.activated=!0)})}}]),mainApp.controller("checkExistAnswerKeyCtrl",["$scope","$timeout","$uibModalInstance","examData",function(e,t,n,a){var i=this;i.close=function(){n.close(!1)},i.goNext=function(){n.close(!0)},i.checking=!1,i.noSelectionQuestions=[],i.noAnswerKeyQuestions=[],i.check=function(){i.checking=!0;for(var e=a.sections.length,s=0;s<e;s++)for(var r=a.sections[s].questions.length,o=0;o<r;o++){var c=a.sections[s].questions[o].type,u=a.sections[s].questions[o].answers.length-1;if(u<=0)i.noSelectionQuestions.push({id:a.sections[s].questions[o].id,order:a.sections[s].questions[o].order});else switch(c){case 0:case 1:for(var l=!1,d=0;d<u;d++)if(a.sections[s].questions[o].answers[d].is_right){l=!0;break}l||i.noAnswerKeyQuestions.push({id:a.sections[s].questions[o].id,order:a.sections[s].questions[o].order});break;case 2:0==a.sections[s].questions[o].answers[0].description.length&&i.noAnswerKeyQuestions.push({id:a.sections[s].questions[o].id,order:a.sections[s].questions[o].order});break;case 3:}}0==i.noSelectionQuestions.length&&0==i.noAnswerKeyQuestions.length&&t(function(){n.close(!0)}),i.checking=!1},i.check()}]),mainApp.controller("detailCtrl",["$scope","$document","$timeout","$compile","$uibModal","displayHtmlService","SectionService","QuestionService","AnswerService","Upload",function(e,t,n,a,i,s,r,o,c,u){MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]);var l=this;l.stopScroll=!0,l.init=function(e){l.examId=e.examId,n(l.loadSections)},l.loadSections=function(){r.get({examId:l.examId},function(e){
l.questionLoading=!1,l.loadedSections=e.sections;var t=l.loadedSections.length;l.questionExist=t>0;for(var n=0,a=0;a<t;a++)for(var i=l.loadedSections[a].questions.length,s=0;s<i;s++)n++,l.loadedSections[a].questions[s].order=n},function(e){l.questionLoading=!1,l.questionExist=!1,l.loadedSections=[]})},l.questionTypes=[{type:0,label:"o Loại một lựa chọn"},{type:1,label:"# Loại nhiều lựa chọn"},{type:2,label:"~ Loại tự luận"},{type:3,label:"- Loại so khớp"}],l.questionLoading=!0,l.questionEditing=!1,l.displayOptions="0",l.sections=[],l.loadedSections=[],l.loadMoreSection=function(){var e=l.loadedSections.length;l.loadedSections.length-l.sections.length>10&&(e=l.sections.length+10);for(var t=l.sections.length;t<e;t++)l.sections.push(l.loadedSections[t])},t.on("click",function(){!angular.isDefined(l.dragDrop)||null==l.dragDrop.selectedSectionId&&null==l.dragDrop.selectedQuestionId||e.$apply(function(){l.dragDrop.selectedSectionId=null,l.dragDrop.selectedSectionFooterId=null,l.dragDrop.selectedQuestionId=null})}),l.renderHtml=function(e){return""==e&&(e="<p><br></p>"),s.renderHtml(e)},l.dragDrop={selectedSectionId:null,selectedSectionFooterId:null,selectedQuestionId:null,selectedItem:null,selectedAnswer:null,insertedPos:-1},l.creatingNewSingleSection=!1,l.creatingNewGroupSection=!1,l.creatingNewQuestion=!1,l.creatingNewAnswer=!1,l.insertedNewAnswer=!1,l.addExamItem=function(t,a,i){angular.element('[data-toggle="tooltip"]').tooltip("hide");var s=null;switch(t){case 0:l.creatingNewSingleSection=!0,s=new r({examId:l.examId}),s.is_group_type=!1;break;case 1:l.creatingNewGroupSection=!0,s=new r({examId:l.examId}),s.is_group_type=!0;break;case 2:l.creatingNewQuestion=!0,s=new o({examId:l.examId,sectionId:l.sections[a].id});break;case 3:l.creatingNewAnswer=!0,l.insertedNewAnswer=!0;var u=l.sections[a].questions[i];if(2==u.type)return;var d=u.answers.length;u.answers[d-1].is_pseudo=!1,n(function(){var e=angular.element("#ans_desc_"+u.answers[d-1].id);e&&e.trigger("click")}),s=new c({examId:l.examId,questionId:u.id});break;default:return}s.$save(function(s){switch(l.questionExist=!0,t){case 0:l.creatingNewSingleSection=!1,s.success?(l.sections.push(s.section),l.updateQuestionOrder(),l.dragDrop.selectedSectionId=null,l.dragDrop.selectedSectionFooterId=null,l.dragDrop.selectedQuestionId=l.sections[l.sections.length-1].questions[0].id,l.dragDrop.selectedItem=l.sections[l.sections.length-1]):(e.examVm.statusMessage=s.message,n(function(){e.examVm.statusMessage=""},2e3));break;case 1:l.creatingNewGroupSection=!1,s.success?(l.sections.push(s.section),l.updateQuestionOrder(),l.dragDrop.selectedSectionId=l.sections[l.sections.length-1].id,l.dragDrop.selectedSectionFooterId=l.dragDrop.selectedSectionId,l.dragDrop.selectedQuestionId=null,l.dragDrop.selectedItem=l.sections[l.sections.length-1]):(e.examVm.statusMessage=s.message,n(function(){e.examVm.statusMessage=""},2e3));break;case 2:l.creatingNewQuestion=!1,s.success?(l.sections[a].questions.push(s.question),l.updateQuestionOrder(),l.dragDrop.selectedSectionId=null,l.dragDrop.selectedSectionFooterId=l.sections[a].id,l.dragDrop.selectedQuestionId=l.sections[a].questions[l.sections[a].questions.length-1].id,l.dragDrop.selectedItem=l.sections[a].questions[l.sections[a].questions.length-1]):(e.examVm.statusMessage=s.message,n(function(){e.examVm.statusMessage=""},2e3));break;case 3:l.creatingNewAnswer=!1,s.success?l.sections[a].questions[i].answers.push(s.answer):(e.examVm.statusMessage=s.message,n(function(){e.examVm.statusMessage=""},2e3));break;default:return}},function(e){l.creatingNewSingleSection=!1,l.creatingNewGroupSection=!1,l.creatingNewQuestion=!1,l.creatingNewAnswer=!1})},l.deleteExamItem=function(t,n,a,i){var s=null;switch(t){case 0:case 1:s=new r({examId:l.examId,sectionId:l.sections[n].id}),l.sections.splice(n,1),l.loadedSections.splice(n,1),l.updateQuestionOrder();break;case 2:s=new o({examId:l.examId,sectionId:l.sections[n].id,questionId:l.sections[n].questions[a].id}),l.sections[n].questions.splice(a,1),l.updateQuestionOrder();break;case 3:var u=l.sections[n].questions[a];if(2==u.type)return;s=new c({examId:l.examId,questionId:u.id,answerId:u.answers[i].id}),l.sections[n].questions[a].answers.splice(i,1);break;default:return}s.$remove(function(t){e.examVm.statusMessage=""},function(t){e.examVm.statusMessage="Server không thực hiện lệnh xóa được."})},l.focusQuestionGrade=function(e,t){l.questionEditing=!0,l.sections[e].questions[t].gradeEditing=!0},l.blurQuestionGrade=function(e,t){l.questionEditing=!1,l.sections[e].questions[t].gradeEditing=!1},l.focusQuestionTimer=function(e,t){l.questionEditing=!0,l.sections[e].questions[t].timerEditing=!0},l.blurQuestionTimer=function(e,t){l.questionEditing=!1,l.sections[e].questions[t].timerEditing=!1},l.updateQuestionGradeDuration=function(t,a,i,s){e.examVm.statusMessage="Đang lưu...";var r=new o({examId:l.examId,sectionId:t,questionId:a});r[i]=s,r.$update(function(t){e.examVm.statusMessage=""},function(t){422==t.status&&(e.examVm.statusMessage="Dữ liệu không hợp lệ...",n(function(){e.examVm.statusMessage=""},5e3))})},l.currentQuestionType=0,l.changingQuesType=!1,l.changeQuestionType=function(t,n){l.changingQuesType=!0;var a=new o({examId:l.examId,sectionId:l.sections[t].id,questionId:l.sections[t].questions[n].id});a.type=l.currentQuestionType.type;var i=l.currentQuestionType.type;a.$updateType(function(e){var a,s;for(l.sections[t].questions[n].type=i,l.sections[t].questions[n].ans_right="",a=l.sections[t].questions[n].answers.length,s=0;s<a;s++)l.sections[t].questions[n].answers[s].is_right=!1;1==a&&2==i&&(l.sections[t].questions[n].answers[0].is_pseudo=!1,l.sections[t].questions[n].answers.push(e.answer)),l.changingQuesType=!1},function(t){l.changingQuesType=!1,e.examVm.statusMessage="Không cập nhật được..."})},l.updateCorrectAnswer=function(t,a,i,s){var r=new c({examId:l.examId,questionId:a,answerId:i});r.type=t,r.value=s,r.$updateCorrectAnswer(function(t){e.examVm.statusMessage="Đã lưu",n(function(){e.examVm.statusMessage=""},2e3)},function(t){e.examVm.statusMessage="Dữ liệu không cập nhật được..."})},l.draggingAnswer=!1,l.selectItem=function(e,t,n){e.is_group_type&&null==t?(l.dragDrop.selectedSectionId=e.id,l.dragDrop.selectedSectionFooterId=e.id,l.dragDrop.selectedQuestionId=null,l.dragDrop.selectedItem=e):(l.dragDrop.selectedSectionId=null,l.dragDrop.selectedSectionFooterId=null,null==t?(l.dragDrop.selectedQuestionId=e.questions[0].id,l.dragDrop.selectedItem=e):(l.dragDrop.selectedSectionFooterId=e.id,l.dragDrop.selectedQuestionId=t.id,l.dragDrop.selectedItem=t)),null!=n&&(l.dragDrop.selectedAnswer=n,l.draggingAnswer=!0)},l.saveInsertedPosition=function(e){l.dragDrop.insertedPos=e},l.updatePosition=function(t,a){l.stopScroll=!0;var i=null==l.dragDrop.selectedItem?-1:l.dragDrop.selectedItem.position-1,s=l.dragDrop.insertedPos;if(!(t&&null==l.sections||!t&&(angular.isUndefined(l.sections[a])||null==l.sections[a].questions)||null==s||i<0||s<0||i==s||i==s-1)){l.questionEditing=!0;for(var c=s<i?s:i,u=s<i?i:s-1,d={},m=c;m<=u;m++)if(t){l.sections[m].position=m+1;var g=l.sections[m].id;d[g]=l.sections[m].position}else{l.sections[a].questions[m].position=m+1;var h=l.sections[a].questions[m].id;d[h]=l.sections[a].questions[m].position}l.updateQuestionOrder(),e.examVm.statusMessage="Đang lưu...";var p=t?new r({examId:l.examId}):new o({examId:l.examId,sectionId:l.sections[a].id});p.positions=d,p.$updatePosition(function(t){e.examVm.statusMessage="",l.questionEditing=!1},function(t){422==t.status&&(e.examVm.statusMessage="Dữ liệu không hợp lệ...",n(function(){e.examVm.statusMessage=""},5e3))})}},l.updateQuestionOrder=function(){for(var e=0,t=l.sections.length,n=0;n<t;n++)for(var a=l.sections[n].questions.length,i=0;i<a;i++)e++,l.sections[n].questions[i].order=e},l.updateAnswerPosition=function(t,a){l.stopScroll=!0,l.draggingAnswer=!1;var i=null==l.dragDrop.selectedAnswer?-1:l.dragDrop.selectedAnswer.position-1,s=l.dragDrop.insertedPos;if(!(null==s||i<0||s<0||i==s||i==s-1)){l.questionEditing=!0;for(var r=s<i?s:i,o=s<i?i:s-1,u={},d=r;d<=o;d++){l.sections[t].questions[a].answers[d].position=d+1;var m=l.sections[t].questions[a].answers[d].id;u[m]=l.sections[t].questions[a].answers[d].position}e.examVm.statusMessage="Đang lưu...";var g=new c({examId:l.examId,questionId:l.sections[t].questions[a].id});g.positions=u,g.$updatePosition(function(t){e.examVm.statusMessage="",l.questionEditing=!1},function(t){422==t.status&&(e.examVm.statusMessage="Dữ liệu không hợp lệ...",n(function(){e.examVm.statusMessage=""},5e3))})}},l.updateDescription=function(t,a,i){var s=a.description;3==i&&(s=a.match);var u=$("<div />").append(s);if(u.find("script").replaceWith(function(){var e=$(this).html().replace("// <![CDATA[","").replace("// ]]>","").trim(),t=$(this).attr("type");return e="undefined"!=typeof t&&"math/tex; mode=display"==t?"$$"+e+"$$":"\\("+e+"\\)&amp; zwnj;"}),u.find(".MathJax_SVG_Display, .MathJax_SVG, .editMath").remove(),s=u.html(),s=s.replace(/&amp; zwnj;/g,"&zwnj;"),s=s.replace(/[\n\t]+/g,""),!l.checkLengthOverLimit(s)){e.examVm.statusMessage="Đang lưu...";var d=null;switch(i){case 0:d=new r({examId:l.examId,sectionId:a.id}),d.description=s;break;case 1:d=new o({examId:l.examId,sectionId:t.id,questionId:a.id}),d.description=s;break;case 2:d=new c({examId:l.examId,questionId:t.id,answerId:a.id}),d.description=s;break;case 3:d=new c({examId:l.examId,questionId:t.id,answerId:a.id}),d.match=s;break;default:return}d.$update(function(t){e.examVm.statusMessage=""},function(t){422==t.status&&(e.examVm.statusMessage="Dữ liệu không hợp lệ...",n(function(){e.examVm.statusMessage=""},5e3))})}},l.trickLoadTinymce="",l.loadTinyMce=function(e,t,n,i){var s,r=angular.element(e.currentTarget||e.srcElement);s=3!=i?angular.element('<div class="contenteditable" ng-focus="'+t+".underlineCss='cq-exam-add-underline'\" ng-blur=\""+t+'.underlineCss=\'cq-exam-remove-underline\'" ui-tinymce="::detailVm.editorSettings" ng-model="'+t+".description\" ng-model-options=\"{updateOn:'default blur', debounce: {'default': 2000, 'blur': 0}}\" ng-change=\"detailVm.updateDescription("+n+", "+t+", "+i+')"></div>'):angular.element('<div class="contenteditable" ng-focus="'+t+".underlineCssMatch='cq-exam-add-underline'\" ng-blur=\""+t+'.underlineCssMatch=\'cq-exam-remove-underline\'" ui-tinymce="::detailVm.editorSettings" ng-model="'+t+".match\" ng-model-options=\"{updateOn:'default blur', debounce: {'default': 2000, 'blur': 0}}\" ng-change=\"detailVm.updateDescription("+n+", "+t+", "+i+')"> </div>'),s.insertAfter(r);var o=r.scope();r.remove(),a(s)(o)};var d="edit insert format table tools help",m="fontselect | fontsizeselect | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist indent outdent | table | image media | code | mathtype";l.editorSettings={language_url:"/js/tinymce-v451/langs/vi.js",external_plugins:{advlist:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/advlist/plugin.min.js",link:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/link/plugin.min.js",image:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/image/plugin.min.js",imagetools:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/imagetools/plugin.min.js",lists:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/lists/plugin.min.js",charmap:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/charmap/plugin.min.js",hr:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/hr/plugin.min.js",searchreplace:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/searchreplace/plugin.min.js",media:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/media/plugin.min.js",table:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/table/plugin.min.js",contextmenu:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/contextmenu/plugin.min.js",paste:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/paste/plugin.min.js",textcolor:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/textcolor/plugin.min.js",colorpicker:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/colorpicker/plugin.min.js",autoresize:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/autoresize/plugin.min.js",template:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/template/plugin.min.js",code:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/code/plugin.min.js"},inline:!0,trusted:!0,theme:"modern",language:"vi",plugins:["advlist link image imagetools lists charmap hr","searchreplace media","table contextmenu paste textcolor colorpicker","autoresize template code"],contextmenu:"cut copy paste | link image inserttable | cell row column deletetable",menu:{edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall | searchreplace"},insert:{title:"Insert",items:"image media link | charmap hr template | mathtype"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"},tools:{title:"Tools",items:"code"},help:{title:"Help",items:"editorhelp mathtypehelp"}},menubar:d,toolbar:m,table_default_styles:{width:"100%"},statusbar:!1,fontsize_formats:"8pt 10pt 12pt 14pt 16pt 18pt 20pt 22pt 24pt 26pt 28pt 32pt 36pt 48pt 72pt",custom_undo_redo_levels:10,image_advtab:!0,relative_urls:!1,remove_script_host:!1,convert_urls:!0,content_css:["/css/bootstrap.min.css?"+(new Date).getTime()],entity_encoding:"raw",templates:[{title:"Tiêu đề nhóm",description:"Thực hiện tiêu đề cho một nhóm câu hỏi",content:'<p style="font-size: 22px; font-weight: bold;">Nội dung điền vào đây</p>'},{title:"Câu hỏi",description:"Thể hiện nội dung câu hỏi",content:'<p style="font-size: 18px; font-weight: normal;">Đây là câu hỏi ...</p>'},{title:"Các lựa chọn",description:"Thể hiện các lựa chọn",content:'<p style="font-size: 16px; font-weight: normal;">Đây là các lựa chọn ...</p>'}],file_picker_callback:function(e,t,n){"image"==n.filetype&&tinymce.activeEditor.windowManager.open({title:"Đăng Tải Hình",url:"/u/image/exam/"+l.examId,width:650,height:470},{oninsert:function(t){e(t)}})},file_picker_types:"image",images_upload_handler:function(e,t,n){var a=new File([e.blob()],e.filename());u.imageDimensions(a).then(function(e){(e.width>1920||e.height>1200)&&u.resize(a,1920,1200,.8,"image/jpeg").then(function(e){a=e})}),u.upload({url:"/u/image/exam/"+l.examId,data:{image:a}}).then(function(e){var n="/image/"+e.data.imageName;t(n)},function(e){n("Update image failure")},function(e){})},extended_valid_elements:"*[*]",setup:function(e){function t(){e.windowManager.open({title:"Công thức",url:"/u/mathtype",width:700,height:600},{oninsert:function(t,n){var a;a=n?'<div class="math">$$'+t+"$$</div><p></p>":"&nbsp;\\("+t+"\\)&#8204;&nbsp;",e.insertContent(a,null),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id])}})}e.addMenuItem("editorhelp",{text:"Editor guide",context:"help",onclick:function(){e.windowManager.open({title:"Hướng dẫn soạn thảo",url:"/guide/editor?tinymce=1",width:800,height:570})}}),e.addMenuItem("mathtypehelp",{text:"Mathtype guide",context:"help",onclick:function(){e.windowManager.open({title:"Hướng dẫn gõ công thức",url:"/guide/mathtype?tinymce=1",width:800,height:570})}}),e.addMenuItem("mathtype",{text:"Công thức",context:"insert",onclick:function(){t()}}),e.addButton("mathtype",{text:"Công thức",tooltip:"Gõ công thức toán, hóa học",icon:!1,onclick:function(){t()}}),e.on("init",function(){if(e.isSavedContent=!0,e.selectedMathId=null,e.selectedMathDisplay=!1,e.moveNext=!0,e.pressSpace=!1,e.beginInlineMath=!1,e.endInlineMath=!1,e.runMathJax=!1,$("#"+e.id).find(".scriptMath").each(function(){var e=$(this).html();$(this).before(e)}),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id]),l.insertedNewAnswer){e.focus(),l.insertedNewAnswer=!1;var t=e.dom.createRng();t.selectNodeContents(e.getBody()),e.selection.setRng(t)}else e.focus()}),e.on("change",function(){e.endInlineMath?(e.endInlineMath=!1,e.runMathJax=!0,e.execCommand("mceInsertContent",!1,"&zwnj;")):e.runMathJax&&(e.runMathJax=!1,MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id]))}),e.on("blur",function(){l.questionEditing=!1}),e.on("click",function(t){l.questionEditing=!0;var n=$(t.target),a=n.closest(".MathJax_SVG");if(a.length>0)if(null!=e.selectedMathId&&a.attr("id")!=e.selectedMathId){var i=$(".editMath");if(i.length>0){var s=i.html();if(e.selectedMathDisplay){var r=i.closest(".MathJax_SVG_Display");r.replaceWith("$$"+s+"$$")}else i.replaceWith("\\("+s+"\\)");MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id],function(){e.selectedMathId=a.attr("id");var t,i,s=n.closest(".MathJax_SVG_Display");t=s.length>0?s.next("script"):a.next("script"),i=t.html(),e.selectedMathDisplay=t.attr("type").indexOf("mode=display")>-1,t.remove(),a.after('<span class="editMath" id="editMath_'+e.selectedMathId+'" style="border: 1px solid red; padding: 2px 2px;">'+i+"</span>"),a.remove()})}}else{e.selectedMathId=a.attr("id");var o,c,u=n.closest(".MathJax_SVG_Display");o=u.length>0?u.next("script"):a.next("script"),c=o.html(),e.selectedMathDisplay=o.attr("type").indexOf("mode=display")>-1,o.remove(),a.after('<span class="editMath" id="editMath_'+e.selectedMathId+'" style="border: 1px solid red; padding: 2px 2px;">'+c+"</span>"),a.remove()}}),e.on("NodeChange",function(t){var n=$(t.element),a=n.closest(".MathJax_SVG_Display");if(0==a.length&&(a=n.closest(".MathJax_SVG")),a.length>0){var i=a.find("img");i.length>0&&(i.remove(),a.before(i),a.before("&zwnj;"))}var s=n.closest(".editMath");if(0==s.length&&null!=e.selectedMathId){var r=$(".editMath");if(r.length>0){e.selectedMathId=null;var o=r.html();if(e.selectedMathDisplay){var c=r.closest(".MathJax_SVG_Display");c.replaceWith("$$"+o+"$$")}else r.replaceWith("\\("+o+"\\)");MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id])}}if(a.length>0&&0==s.length){var u,l=rangy.getSelection();u=rangy.createRange();var d;if(1==e.moveNext){if(d=a[0].nextSibling.nextSibling,null==d&&(d=a[0].parentNode.nextSibling.firstChild),d.nodeType!=Node.TEXT_NODE)for(var m=d.childNodes,g=0;g<m.length;g++){var h=m[g];if(3==h.nodeType){d=h;break}}var p=0;d.nodeType==Node.TEXT_NODE&&8204===d.wholeText.charCodeAt(0)&&(p=1),u.setStart(d,p),u.setEnd(d,p)}else{if(d=a[0].previousSibling,null==d&&(d=a[0].parentNode.previousSibling.lastChild),d.nodeType!=Node.TEXT_NODE)for(var f=d.childNodes,x=f.length;x--;){var v=f[x];if(3==v.nodeType){d=v;break}}u.setStart(d,d.length),u.setEnd(d,d.length)}l.removeAllRanges(),l.addRange(u)}}),e.on("KeyDown",function(t){e.isSavedContent=!1,e.moveNext="ArrowRight"==t.key||"Right"==t.key,e.endInlineMath=")"==t.key,e.runMathJax="]"==t.key||"$"==t.key;var n=["Backspace","Enter","Shift","Control","Alt","CapsLock","PageUp","PageDown","End","Home","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Delete","Left","Up","Right","Down","Del"];if(n.indexOf(t.key)==-1){var a=e.getContent().length;if(l.checkLengthOverLimit(a))return e.stopPropagation(),e.preventDefault(),!1}return"\\"!=t.key||e.pressSpace?void(e.pressSpace=" "==t.key||"\\"==t.key):(e.execCommand("mceInsertContent",!1," \\"),e.preventDefault(),e.stopPropagation(),e.pressSpace=!0,!1)})}},l.checkLengthOverLimit=function(t){var n=2e4;return t>n?(e.examVm.statusMessage="Chiều dài vượt giới hạn!",!0):(e.examVm.statusMessage="",!1)},e.$on("checkAnswerKey",function(t){if(angular.isDefined(l.sections)&&l.sections.length>0){var n=i.open({animation:!0,templateUrl:"checkExistAnswerKeyModal.html",controller:"checkExistAnswerKeyCtrl",controllerAs:"checkExistAnswerKeyVm",keyboard:!1,resolve:{examData:function(){return{sections:l.sections}}}});n.result.then(function(t){e.$emit("afterCheck",t)})}else e.$emit("afterCheck",!0)})}]),mainApp.controller("examCreationCtrl",["$scope","$timeout","$uibModal","$window","Upload","ExamService","PrintingService",function(e,t,n,a,i,s,r){var o=this;o.unSavedList={},o.statusMessage="",o.collapse=!1,o.init=function(e){o.published=e.published,o.id=e.id,o.title=e.title,o.code=e.code,o.cost=parseInt(e.cost),o.password=e.password,o.image=e.image,o.description=e.description,o.tags=e.tags,o.start=e.start,o.end=e.end,o.isEnd=e.isEnd,o.time_whole_exam=e.time_whole_exam,o.duration=e.duration,o.do_to_end_time=e.do_to_end_time,o.printCost=e.printCost,o.timeMethodOptions=[{id:"0",name:"Thời gian mỗi câu hỏi"},{id:"1",name:"Thời gian toàn bài"}],o.time_whole_exam?(o.selectedTimeMethod={id:"1",name:"Thời gian toàn bài"},o.duration=o.duration/60):o.selectedTimeMethod={id:"0",name:"Thời gian mỗi câu hỏi"},o.settings=e,o.settings.playerList=e.permitted_players&&e.permitted_players.length>0?angular.fromJson(e.permitted_players):[],o.identifyHelp(),t(o.loadPrintSettings())},o.removeEnd=function(){if(0==o.isEnd)o.do_to_end_time=!1,o.end="",o.updateExam(["do_to_end_time","end"]);else{var e=moment();if(""!=o.start){var t=e.add(1,"d");o.end=t.format()}else o.end=e.format();o.updateExam(["end"])}},o.updateTimeMethod=function(){o.time_whole_exam="1"==o.selectedTimeMethod.id,o.time_whole_exam?o.duration=o.duration/60:o.duration=60*o.duration,o.updateExam(["time_whole_exam"])},o.updateExam=function(e){o.statusMessage="Đang lưu...";var n,a,i,r=new s({id:o.id}),c=e.length,u=0;for(n=0;n<c;n++){if(a=e[n],i=o[a],"cost"==a){if(null==o[a])i=0;else if(o[a]<0||o[a]>2e3)continue}else if(angular.isUndefined(o[a]))continue;"duration"==a&&o.time_whole_exam?r[a]=60*i:r[a]=i,u++}return 0==u?void(o.statusMessage=""):void r.$update(function(){o.statusMessage="";var t,n,a=e.length;for(t=0;t<a;t++)n=e[t],o.unSavedList.hasOwnProperty(n)&&delete o.unSavedList[n]},function(n){if(422==n.status)o.statusMessage="Dữ liệu không hợp lệ...",t(function(){o.statusMessage=""},5e3);else{var a,i,s=e.length;for(a=0;a<s;a++)i=e[a],o.unSavedList[i]=o[i]}})},o.avatarProgress=!1,o.progressImageUpload=0,o.upload=function(e){e&&!e.$error&&(o.progressImageUpload=0,o.avatarProgress=!0,i.upload({url:"/u/exam/"+o.id+"/image",data:{image:e,oldImage:o.image}}).then(function(e){o.image=e.data.imagePath,o.progressImageUpload=95,t(function(){o.avatarProgress=!1,o.progressImageUpload=100},2e3)},function(e){o.avatarProgress=!1},function(e){o.progressImageUpload=parseInt(90*e.loaded/e.total)}))},o.identifyHelp=function(){o.settings.help_reduce_selection=parseInt(o.settings.help_reduce_selection),o.settings.enableHelpReduceSelection=o.settings.help_reduce_selection!=-1,o.settings.help_increase_time=parseInt(o.settings.help_increase_time),o.settings.enableHelpIncreaseTime=o.settings.help_increase_time!=-1,o.settings.help_answer_later=parseInt(o.settings.help_answer_later),o.settings.enableHelpAnswerLater=o.settings.help_answer_later!=-1,o.settings.help_save_time=parseInt(o.settings.help_save_time),o.settings.enableHelpSaveTime=o.settings.help_save_time!=-1,o.settings.help_question_again=parseInt(o.settings.help_question_again),o.settings.enableHelpQuestionAgain=o.settings.help_question_again!=-1,o.settings.help_exam_again=parseInt(o.settings.help_exam_again),o.settings.enableHelpExamAgain=o.settings.help_exam_again!=-1},o.showSettingModal=function(){var e=n.open({animation:!0,templateUrl:"examSettingModal.html",controller:"settingCtrl",controllerAs:"settingVm",keyboard:!0,size:"lg",resolve:{examSettings:function(){return o.settings}}});e.result.then(function(e){o.settings=e})},o.isTry=!1,o.tryToDoExam=function(){var e=n.open({animation:!1,templateUrl:"tryModal.html",controller:"tryCtrl",controllerAs:"tryVm",keyboard:!1,backdrop:"static",size:null});o.isTry=!0,s.tryToDoExam({id:o.id},function(t){o.isTry&&t.success?a.location.href="/u/exam/"+o.id+"/run/question/"+t.firstQuestionId+"?order=1&trying=1":e.close()},function(e){}),e.result.then(function(){o.isTry=!1})},o.loadedPrintSettings=!1,o.printSettings=null,o.loadPrintSettings=function(){r.getSettings({id:o.id},function(e){o.statusMessage="",angular.isObject(e.printSettings)?o.printSettings=e.printSettings:o.initPrintSetting(),o.printSettings.cost=o.printCost,o.loadedPrintSettings=!0},function(e){o.statusMessage="Không lấy được các thiết lập",o.printSettings=[],o.loadedPrintSettings=!1})},o.initPrintSetting=function(){o.printSettings={},o.printSettings.exam_id=o.id,o.printSettings.link="",o.printSettings.paid=!1,o.printSettings.shuffle_section=!0,o.printSettings.shuffle_question=!0,o.printSettings.shuffle_answer=!0,o.printSettings.question_order=!0,o.printSettings.page_number=!0,o.printSettings.bold_section=!0,o.printSettings.bold_question=!0,o.printSettings.answer_key=!1,o.printSettings.section_break=!0,o.printSettings.question_order_method=0,o.printSettings.font_size=12,o.printSettings.enable_heading=!0,o.printSettings.heading=""},o.showPrintingModal=function(){if(o.loadedPrintSettings){var e=n.open({animation:!0,templateUrl:"examPrintingModal.html",controller:"printingCtrl",controllerAs:"printingVm",keyboard:!1,backdrop:"static",size:"lg",resolve:{printSettings:function(){return o.printSettings}}});e.result.then(function(e){o.printSettings=e})}else null===o.printSettings?o.statusMessage="Đang lấy các thiết lập...":(o.statusMessage="Không thể kết nối với máy chủ...",o.printSettings=null)},o.togglePublishing=function(){o.published=!o.published,o.updateExam(["published"])},o.finish=function(){angular.isDefined(o.id)&&(o.unSavedList.length>0&&o.updateExam(o.unSavedList),e.$broadcast("checkAnswerKey"))},e.$on("afterCheck",function(e,t){if(t){var a=n.open({animation:!0,templateUrl:"examFinishModal.html",controller:"finishCtrl",controllerAs:"finishVm",keyboard:!1,openedClass:"cq-exam-modal",size:null,resolve:{examInfo:function(){return{examId:o.id,code:o.code,tags:o.tags,published:o.published}}}});a.result.then(function(e){o.published=e})}})}]),mainApp.controller("finishCtrl",["$scope","$timeout","$window","ngClipboard","ExamService","$uibModalInstance","examInfo",function(e,t,n,a,i,s,r){var o=this;o.examInfo=r,o.statusMessage="",o.waiting=!1,o.link="https://toithi.com/exam/"+r.examId+"/information",o.unlockExam=function(){if(!o.examInfo.published){o.statusMessage="Đang mở khóa...";var e=new i({id:o.examInfo.examId});e.published=!0,o.waiting=!0,e.$update(function(){o.statusMessage="",o.waiting=!1,o.examInfo.published=!0},function(e){o.waiting=!1,422==e.status?(o.statusMessage="Dữ liệu không hợp lệ...",t(function(){o.statusMessage=""},5e3)):o.statusMessage="Không kết nối với server được..."})}},o.copyLink=function(){a.toClipboard(o.link),o.statusMessage="Liên kết đã sao chép vào clipboard",t(function(){o.statusMessage=""},5e3)},o.close=function(){s.close(o.examInfo.published)},o.end=function(){o.waiting=!0,n.location.href="/"}}]),mainApp.controller("printingCtrl",["$scope","$timeout","PrintingService","$uibModalInstance","printSettings","Upload",function(e,t,n,a,i,s){var r=this;r.settings=i,r.statusMessage="",""==r.settings.link?r.downloadLink="":r.downloadLink='Bản in đã tạo lần trước: <a href="'+r.settings.link+'" target="_blank">'+r.settings.link+"</a>",r.payForPrint=function(){var e=new n({id:r.settings.exam_id});r.statusMessage="Đang thanh toán...",e.$pay(function(e){r.statusMessage="",e.success?r.settings.paid=!0:r.statusMessage=e.message},function(e){r.statusMessage="Giao dịch không thành công..."})},r.update=function(e,a){if(r.settings.paid){var i=new n({id:r.settings.exam_id});i[e]=a,"enable_heading"==e&&(i.heading=r.settings.heading),r.statusMessage="Đang lưu...",i.$update(function(){r.statusMessage=""},function(e){422==e.status?(r.statusMessage="Dữ liệu không hợp lệ...",t(function(){r.statusMessage=""},5e3)):r.statusMessage="Không lưu được..."})}},r.setDefaultHeading=function(){r.settings.heading=r.templateHeading,r.update("heading",r.settings.heading)},r.exporting=!1,r.print=function(){r.exporting=!0,r.downloadLink="Vui lòng chờ trong ít phút... Thời gian phụ thuộc vào độ dài của nội dung.";var e=new n({id:r.settings.exam_id});e.$exportPdf(function(e){r.exporting=!1,e.success?(r.settings.link=e.link,r.downloadLink='Link tải bản in: <a href="'+e.link+'" target="_blank">'+e.link+"</a>"):r.downloadLink="Bạn đã tạo bản in vượt số lượng cho phép một ngày. Vui lòng quay lại vào ngày khác"},function(e){r.downloadLink="Không tạo được bản in. Nguyên nhân có thể do lỗi server hoặc đề quá dài, có nhiều hình ảnh và video.",r.statusMessage="Không kết nối với server được.",t(function(){r.statusMessage=""},5e3),r.downloadLink="",r.exporting=!1})},r.close=function(){a.close(r.settings)};var o="fontselect | fontsizeselect | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist indent outdent | image | fullscreen | code";r.editorSettings={language_url:"/js/tinymce-v451/langs/vi.js",external_plugins:{advlist:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/advlist/plugin.min.js",link:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/link/plugin.min.js",image:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/image/plugin.min.js",imagetools:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/imagetools/plugin.min.js",lists:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/lists/plugin.min.js",charmap:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/charmap/plugin.min.js",hr:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/hr/plugin.min.js",table:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/table/plugin.min.js",contextmenu:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/contextmenu/plugin.min.js",paste:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/paste/plugin.min.js",textcolor:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/textcolor/plugin.min.js",colorpicker:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/colorpicker/plugin.min.js",fullscreen:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/fullscreen/plugin.min.js",code:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/code/plugin.min.js"},trusted:!0,theme:"modern",language:"vi",plugins:["advlist link image imagetools lists charmap hr","table contextmenu paste textcolor colorpicker fullscreen code"],contextmenu:"cut copy paste | link image inserttable | cell row column deletetable",menu:{edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall"},insert:{title:"Insert",items:"image link | charmap hr template"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"},tools:{title:"Tools",items:"code"}},menubar:"edit insert format table tools",toolbar:o,table_default_styles:{width:"100%"},statusbar:!1,fontsize_formats:"8pt 10pt 12pt 14pt 16pt 18pt 20pt 22pt 24pt 26pt 28pt 32pt 36pt 48pt 72pt",custom_undo_redo_levels:5,relative_urls:!1,remove_script_host:!1,convert_urls:!0,content_css:["/css/bootstrap.min.css?"+(new Date).getTime()],height:260,file_picker_callback:function(e,t,n){"image"==n.filetype&&tinymce.activeEditor.windowManager.open({title:"Đăng Tải Hình",url:"/u/image/exam/"+r.settings.exam_id,width:650,height:470},{oninsert:function(t){e(t)}})},file_picker_types:"image",images_upload_handler:function(e,t,n){var a=new File([e.blob()],e.filename());s.imageDimensions(a).then(function(e){(e.width>1920||e.height>1200)&&s.resize(a,1920,1200,.8,"image/jpeg").then(function(e){a=e})}),s.upload({url:"/u/image/exam/"+r.settings.exam_id,data:{image:a}}).then(function(e){var n="/image/"+e.data.imageName;t(n)},function(e){n("Update image failure")},function(e){})},setup:function(e){e.on("KeyDown",function(t){e.isSavedContent=!1,e.moveNext="ArrowRight"==t.key||"Right"==t.key,e.endInlineMath=")"==t.key,e.runMathJax="]"==t.key||"$"==t.key;var n=["Backspace","Enter","Shift","Control","Alt","CapsLock","PageUp","PageDown","End","Home","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Delete","Left","Up","Right","Down","Del"];if(n.indexOf(t.key)==-1){var a=e.getContent().length;if(a>2e3)return r.statusMessage="Chiều dài vượt giới hạn!",
e.stopPropagation(),e.preventDefault(),!1}}),e.on("blur",function(){r.update("heading",e.getContent())})}},r.templateHeading=['<table style="width: 100%; border-style: none;">',"<tbody>","<tr>",'<td style="vertical-align: top;">','<p style="text-align: center;">',"<strong>BỘ GIÁO DỤC & ĐÀO TẠO<br></strong>","<strong>TRƯỜNG ĐẠI HỌC ...<br></strong>","<strong>KHOA ...<br></strong>",'<hr style="width: 50%; border-top: 1px solid black;">',"</p>","</td>",'<td style="vertical-align: top;">','<p style="text-align: center;">',"<strong>ĐỀ THI HỌC KỲ I<br></strong>","<strong>Môn học: ...<br></strong>","<em>Thời gian: 90 phút<br></em>","<em>(Không được tham khảo tài liệu)</em>","</p>","</td>","</tr>","</tbody>","</table>",'<table style="width: 100%; border-style: none;">',"<tbody>","<tr>",'<td style="width: 90.3236%;">',"<p>&nbsp; Họ tên: .....................................................................................</p>","<p>&nbsp; Mã sinh viên: ...........................................................................</p>","<p>&nbsp; Lớp:..........................................................................................</p>","</td>",'<td style="width: 10%;">','<table style="width: 114px; border-style: solid; height: 29px; border-color: #000000;">',"<tbody>","<tr>",'<td style="text-align: center; width: 113px;">Mã đề 001</td>',"</tr>","</tbody>","</table>","</td>","</tr>","</tbody>","</table>"].join("\n"),null!=r.settings.heading&&0!=r.settings.heading.length||(r.settings.heading=r.templateHeading)}]),mainApp.controller("settingCtrl",["$scope","$timeout","ExamService","$uibModalInstance","examSettings","Upload",function(e,t,n,a,i,s){var r=this;r.examSettings=i,r.selectedDisplayMethod=r.examSettings.display_all_question?"1":"0",r.updateHelpEnable=function(e,t){var n=1==t?1:-1;r.examSettings[e]=n,r.update(e,n)},r.statusMessage="",r.update=function(e,a){if(("help_exam_again"!=e&&"help_question_again"!=e&&"help_save_time"!=e&&"help_answer_later"!=e&&"help_increase_time"!=e&&"help_reduce_selection"!=e||!(a<-1||a>1e3))&&("max_exam_again"!=e&&"max_question_again"!=e&&"max_save_time"!=e&&"max_answer_later"!=e&&"max_increase_time"!=e&&"max_reduce_selection"!=e||!(a<1||a>1e3))){var i=new n({id:r.examSettings.id});i[e]=a,r.statusMessage="Đang lưu...",i.$update(function(){r.statusMessage=""},function(e){422==e.status?(r.statusMessage="Dữ liệu không hợp lệ...",t(function(){r.statusMessage=""},5e3)):r.statusMessage="Không lưu được..."})}},r.uploadPlayerList=function(e){e&&!e.$error?(r.statusMessage="Đang tải dữ liệu lên...",s.upload({url:"/u/exam/"+r.examSettings.id+"/upload-players",data:{players:e}}).then(function(e){e.data.success&&(e.data.players&&e.data.players.length>0?r.examSettings.playerList=angular.fromJson(e.data.players):r.examSettings.playerList=[]),r.statusMessage=""},function(e){r.statusMessage="Dữ liệu không tải lên được...",t(function(){r.statusMessage=""},5e3)})):(r.statusMessage="File không hợp lệ...",t(function(){r.statusMessage=""},5e3))},r.close=function(){a.close(r.examSettings)}}]),mainApp.controller("tryCtrl",["$scope","$uibModalInstance",function(e,t){var n=this;n.close=function(){t.close()}}]),mainApp.controller("certificateCtrl",["$scope","$timeout","$uibModal","CertificateService",function(e,t,n,a){var i=this;i.certPaid=!1,i.certLink=null,i.certPaidCost=0,i.coin=0,i.examId=null,i.init=function(e){i.certPaid=e.certPaid,i.certLink=e.certLink,i.certPaidCost=e.certPaidCost,i.coin=e.coin,i.examId=e.examId},i.print=function(){if(i.certPaid)i.doPrintCert();else{var e=n.open({animation:!0,templateUrl:"confirmPayCertModal.html",controller:"confirmPayCertCtrl",controllerAs:"confirmPayCertVm",keyboard:!0,resolve:{data:function(){return{coin:i.coin,certPaidCost:i.certPaidCost}}}});e.result.then(function(e){e&&i.doPrintCert()})}},i.message="",i.printing=!1,i.certDate=null,i.doPrintCert=function(){i.printing||(i.printing=!0,a.print({id:i.examId},function(e){e.success?(i.certLink=e.link,i.certDate=moment().format("DD-MM-YYYY")):i.message=e.message,i.printing=!1},function(e){i.printing=!1}))}}]),mainApp.controller("confirmExamAgainCtrl",["$scope","$uibModalInstance",function(e,t){var n=this;n.cancel=function(){t.close(!1)},n.finish=function(){t.close(!0)}}]),mainApp.controller("confirmPayCertCtrl",["$scope","$uibModalInstance","data",function(e,t,n){var a=this;a.certPaidCost=n.certPaidCost,a.coin=n.coin,a.message=n.coin<n.certPaidCost?"Bạn không đủ xu để thực hiện":"",a.cancel=function(){t.close(!1)},a.finish=function(){a.coin>=a.certPaidCost&&t.close(!0)}}]),mainApp.controller("dashboardCtrl",["$scope","$uibModal","$window","$timeout","DashboardService","InformationService","RunService",function(e,t,n,a,i,s,r){var o=this;o.score="",o.query="",o.searchExam=function(){o.query=o.query.trim(),0!==o.query.length&&(n.location.href="/search?q="+o.query)},o.init=function(e){o.userId=e.userId,o.userIsCreator=e.userIsCreator,o.examId=e.examId,o.isExamFinish=e.isExamFinish,o.userCoin=(1*e.userCoin).toString(),o.remain_question_again=e.remain_question_again,o.remain_exam_again=e.remain_exam_again,o.helpQuestionAgain=e.helpQuestionAgain,o.isQuestionAgain=e.helpQuestionAgain>=0&&o.remain_question_again>0,o.helpExamAgain=e.helpExamAgain,o.isExamAgain=e.helpExamAgain>=0&&o.remain_exam_again>0,o.starRating=e.votePoint,o.comment=e.voteComment,o.timeMethod=e.timeMethod,1==e.timeMethod?(o.isBegin=e.isBegin,e.isBegin?(o.remainTime=e.remainTime,o.isExamFinish||(o.startPoint=moment(),o.stopCountDown(),o.myCountDown=a(o.runCountDown,1e3))):o.remainTime=e.remainTime/60):(o.isBegin=0,o.remainTime=0),a(o.loadQuestionInfo),o.userIsCreator||a(o.loadLeaderBoard(),1e3)},o.showDetailProgress=!1,o.toggleDisplayProgress=function(){o.showAnswerKey&&(o.showDetailProgress=!o.showDetailProgress)},o.loadedQuestions=!1,o.displayedQuestions=[],o.questions=[],o.loadQuestionInfo=function(){i.loadQuestion({id:o.examId},function(e){o.loadedQuestions=!0,o.questionRate=e.data.nDoneQuestion+"/"+e.data.totalQuestion,o.nDoneQuestion=e.data.nDoneQuestion,o.totalQuestion=e.data.totalQuestion,o.rateDoneQuestion=Math.round(o.nDoneQuestion/o.totalQuestion*100),o.isExamFinish=e.data.isExamFinish,o.showQuestionAfterFinish=e.data.showQuestionAfterFinish,o.showAnswerKey=e.data.showAnswerKey,o.showAnswerKey&&(o.nCorrectQuestion=e.data.nCorrectQuestion,o.rateCorrectQuestion=Math.round(o.nCorrectQuestion/o.totalQuestion*100),o.nIncorrectQuestion=o.nDoneQuestion-o.nCorrectQuestion,o.rateInCorrectQuestion=Math.round(o.nIncorrectQuestion/o.totalQuestion*100)),o.isExamFinish||o.showAnswerKey?(o.showScore=!0,o.score=e.data.score):o.showScore=!1,o.questions=e.data.questions,o.loadMoreQuestion(),e.data.preparedAnswers?(o.preparedAnswers=!0,o.requireSync=e.data.requireSync):o.prepareAnswers()},function(e){})},o.loadedLeaderBoard=!1,o.leaderBoardRequest=null,o.loadLeaderBoard=function(){o.userIsCreator||(o.leaderBoardRequest=i.loadLeaderBoard({id:o.examId},function(e){o.loadedLeaderBoard=!0,o.topTenStudents=e.data},function(e){}))},o.loadedAllQuestion=!1,o.loadMoreQuestion=function(){if(o.questions.length==o.displayedQuestions.length)return void(o.loadedAllQuestion=!0);var e=o.questions.length;o.questions.length-o.displayedQuestions.length>20&&(e=o.displayedQuestions.length+20);for(var t=o.displayedQuestions.length;t<e;t++)o.displayedQuestions.push(o.questions[t])},o.loadedStudents=[],o.loadedStudentPage=0,o.showMoreRank=function(){if(!o.userIsCreator){0==o.loadedStudents.length&&(o.loadedStudents=o.topTenStudents.slice(),o.loadedStudentPage=1,11==o.loadedStudents.length&&o.loadedStudents.splice(10,1));var e=t.open({animation:!0,templateUrl:"leaderBoardModal.html",controller:"leaderBoardCtrl",controllerAs:"leaderBoardVm",keyboard:!0,size:"lg",resolve:{data:function(){return{userId:o.userId,examId:o.examId,students:o.loadedStudents,page:o.loadedStudentPage,showScore:o.showScore}}}});e.result.then(function(e){o.loadedStudents=e.students,o.loadedStudentPage=e.page})}},o.preparedAnswers=!1,o.prepareAnswers=function(){i.prepareAnswer({id:o.examId},function(e){e.success&&(o.preparedAnswers=!0,null!=o.accessingQuestion&&(null!=o.leaderBoardRequest&&o.leaderBoardRequest.$cancelRequest(),n.location.href="/u/exam/"+o.examId+"/run/question/"+o.accessingQuestion+"?order="+o.accessingOrder)),o.accessButPreparingAnswers=!1},function(e){})},o.synchronizingExam=!1,o.requireSync=!1,o["synchronized"]=!1,o.synchronizeExam=function(){o.synchronizingExam=!0,i.synchronizeExam({id:o.examId},function(e){o["synchronized"]=e.success,o.requireSync=!e.success,o.synchronizingExam=!1},function(e){o.synchronizingExam=!1})},o.accessingQuestion=null,o.accessingOrder=null,o.accessButPreparingAnswers=!1,o.doQuestion=function(e,t,a,i){return o.accessingQuestion=a,o.accessingOrder=e,o.preparedAnswers?(null!=o.leaderBoardRequest&&o.leaderBoardRequest.$cancelRequest(),void(n.location.href="/u/exam/"+o.examId+"/run/question/"+a+"?order="+e)):(i.stopPropagation(),void(o.accessButPreparingAnswers=!0))},o.statusMessage="",o.doQuestionAgain=function(e,t,i,s){return o.preparedAnswers?o.helpQuestionAgain<0||1==o.timeMethod||o.isExamFinish?(o.statusMessage="Chức năng không hỗ trợ",void a(function(){o.statusMessage=""},5e3)):o.helpQuestionAgain>=0&&o.userCoin<=o.helpQuestionAgain?(o.statusMessage="Không đủ xu để thực hiện",void a(function(){o.statusMessage=""},5e3)):(o.accessingQuestion=i,o.accessingOrder=e,void r.helpQuestion({examId:o.examId,questionId:i,type:5},function(e){o.statusMessage="",e.success?(angular.isDefined(e.coin)&&(o.userCoin=e.coin),null!=o.leaderBoardRequest&&o.leaderBoardRequest.$cancelRequest(),n.location.href="/u/exam/"+o.examId+"/run/question/"+o.accessingQuestion+"?order="+o.accessingOrder):(o.statusMessage=e.message,a(function(){o.statusMessage=""},5e3),o.accessingQuestion=null,o.accessingOrder=null)},function(e){o.statusMessage="",o.accessingQuestion=null,o.accessingOrder=null})):(s.stopPropagation(),void(o.accessButPreparingAnswers=!0))},o.calculateCountDown=function(e){o.currentSecond=e%60,o.currentMinute=Math.floor(e/60)%60,o.currentHour=Math.floor(e/3600),o.currentHour<100?o.digitalTimer=("0"+o.currentHour).slice(-2)+":"+("0"+o.currentMinute).slice(-2)+":"+("0"+o.currentSecond).slice(-2):o.digitalTimer="> 99:"+("0"+o.currentMinute).slice(-2)+":"+("0"+o.currentSecond).slice(-2)},o.myCountDown=null,o.runCountDown=function(){var e=moment(),t=e.diff(o.startPoint,"seconds");o.localRemainTime=o.remainTime-t,o.localRemainTime>0?(o.calculateCountDown(o.localRemainTime),o.myCountDown=a(o.runCountDown,1e3)):(o.localRemainTime=0,o.calculateCountDown(o.localRemainTime))},o.stopCountDown=function(){a.cancel(o.myCountDown),o.calculateCountDown(0)},o.rateMessage="",o.starRating=0,o.hoverRating=0,o.comment="",o.clickStar=function(e){if(null!=o.userId){var t=new s({id:o.examId});t.vote_point=e,t.$updateVotePoint(function(e){0==e.success&&(o.starRating=0,o.rateMessage="Lỗi chứng thực")},function(e){o.rateMessage="Không kết nối được với server"})}},o.updateComment=function(){if(null!=o.userId){var e=new s({id:o.examId});e.vote_comment=o.comment,e.$updateComment(function(e){0==e.success&&(o.commentMessage="Lỗi chứng thực")},function(e){o.commentMessage="Không kết nối được với server"})}},o.mouseHoverStar=function(e){o.hoverRating=e},o.mouseLeaveStar=function(e){o.hoverRating=e+"*"},o.goToInformationPage=function(){null!=o.leaderBoardRequest&&o.leaderBoardRequest.$cancelRequest(),n.location.href="/exam/"+o.examId+"/information"},o.finishingExam=!1,o.finishExam=function(){if(!o.isExamFinish){var e=t.open({animation:!0,templateUrl:"confirmFinishModal.html",controller:"confirmFinishCtrl",controllerAs:"confirmFinishVm",keyboard:!0,size:null});e.result.then(function(e){if(1==e){var t=new r({examId:o.examId});o.finishingExam=!0,t.$finishExam(function(e){if(o.finishingExam=!1,e.success){o.isExamFinish=!0,o.showScore=!0,o.score=e.examResult.score;for(var t=o.topTenStudents.length,n=0;n<t;n++)if(o.topTenStudents[n].id==o.userId){o.topTenStudents[n].score=o.score;break}}},function(e){o.finishingExam=!1})}})}},o.doExamAgain=function(){if(o.isExamAgain&&!o.userIsCreator&&!o.helpingExam){if(o.userCoin<o.helpExamAgain)return void a(function(){o.statusMessage="Bạn không đủ xu để thực hiện."},5e3);var e=t.open({animation:!0,templateUrl:"confirmExamAgainModal.html",controller:"confirmExamAgainCtrl",controllerAs:"confirmExamAgainVm",keyboard:!0,size:null});e.result.then(function(e){1==e&&(o.helpingExam=!0,i.helpExamAgain({examId:o.examId,type:6},function(e){if(o.helpingExam=!1,e.success){o.userCoin=e.coin,o.remain_exam_again=e.remain_exam_again,1==o.timeMethod?(o.isBegin=!1,o.remainTime=e.remainTime/60):(o.isBegin=!1,o.remainTime=0),o.questionRate=0,o.nDoneQuestion=0,o.rateDoneQuestion=0,o.isExamFinish=!1,o.showAnswerKey=!1,o.nCorrectQuestion=0,o.nIncorrectQuestion=0,o.rateCorrectQuestion=0,o.rateInCorrectQuestion=0,o.showScore=!1,o.score=0;var t,n;for(n=o.displayedQuestions.length,t=0;t<n;t++)o.displayedQuestions[t].is_done=!1,o.displayedQuestions[t].is_correct=!1;for(n=o.questions.length,t=0;t<n;t++)o.questions[t].is_done=!1,o.questions[t].is_correct=!1;for(n=o.topTenStudents.length,t=0;t<n;t++)if(o.topTenStudents[t].id==o.userId){o.topTenStudents[t].score=0;break}}else o.statusMessage=e.message},function(e){o.helpingExam=!1}))})}},o.getCertificate=function(){o.isExamFinish&&(n.location.href="/u/exam/"+o.examId+"/dashboard/certificate")}}]),mainApp.controller("leaderBoardCtrl",["$scope","$uibModalInstance","DashboardService","data",function(e,t,n,a){var i=this;i.data=a,i.statusMessage="",i.loading=!1,i.loadMoreStudent=function(){i.loading=!0,n.loadMoreStudent({id:i.data.examId,page:i.data.page+1},function(e){i.loading=!1,e.data&&(i.data.page++,i.data.students=i.data.students.concat(e.data))},function(e){i.loading=!1,i.statusMessage="Lỗi kết nối server"})},i.close=function(){t.close({students:i.data.students,page:i.data.page})}}]),mainApp.controller("demoCtrl",["$scope","$window","$timeout","$uibModal","Fullscreen",function(e,t,n,a,i){var s=this;s.statusMessage="",s.savedTime=0,s.updating=0,MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]),s.questionList=null,s.loadingQuestion=!0,s.finishPage=!1,s.disabledReduceSelection=!1,s.disabledQuestionAgain=!1,s.init=function(e){s.countDownMode=1,s.questionList=e.questionList,s.numberQuestion=s.questionList.length,s.questionOrder=1,n(s.loadQuestion,0,!0,s.questionOrder),s.savedTime=0,s.questionsStatus=e.questionsStatus,n(s.displayPagePagination),n(s.initResultChart)},s.reducedAnswers=[],s.loadQuestion=function(e){var a=s.questionList[e-1];s.questionId=a.id,s.questionFinished=a.finished,s.finishPage=!1,s.timer=parseInt(a.timer),s.bonusTime=parseInt(a.bonusTime),s.duration=parseInt(a.timer)+parseInt(a.bonusTime),s.currentOrder=a.order,s.displayPagePagination(),s.isGroupType=a.isGroupType,s.questionType=a.questionType,s.numberSelection=a.numberSelection,s.sectionDescription=a.sectionDescription,s.questionDescription=a.questionDescription,s.answers=a.answers,s.prepareAnswer(a.questionType,a.answers),s.reducedAnswers=[],s.loadingQuestion=!1,s.loadingIcon=!1,s.disabledReduceSelection=!1,s.disabledQuestionAgain=!1,s.hidingMessage="",s.hidingQuestion=!1,s.calculateCountDown(0),s.stopCountDown(),s.questionFinished||s.examFinished||(angular.isDefined(s.questionList[e-1].questionBeginTime)?s.questionBeginTime=s.questionList[e-1].questionBeginTime:s.questionBeginTime=s.questionList[e-1].questionBeginTime=moment(),s.duration=a.timer,s.myCountDown=n(s.runCountDown,1e3)),n(function(){2==s.questionType&&angular.element("#uAnswer").focus(),MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){s.refreshAfterMathjax()})}),t.scrollTo(0,0)},s.prepareAnswer=function(e,t){var n,a=t.length;switch(e){case 0:for(s.selectedRadio=-1,n=0;n<a;n++)t[n].isSelected&&(s.selectedRadio=t[n].id);break;case 1:for(s.selectedCheckbox={},n=0;n<a;n++)s.selectedCheckbox[t[n].id]=t[n].isSelected;break;case 2:s.essay=t[0].essay;break;case 3:for(s.matchedPairArray={},n=0;n<a;n++)s.matchedPairArray[t[n].order]=t[n].matchId;s.resetSelectedMatch()}},s.getNameFromNumber=function(e){var t=(e-1)%26,n=String.fromCharCode(65+t),a=Math.floor((e-1)/26);return a>0?s.getNameFromNumber(a)+n:n},s.refreshAfterMathjax=function(){n(function(){s.drawConnect()})},s.questionsStatus=null,s.pages={},s.currentOrder=1,s.pages.previous=!1,s.pages.next=!1,s.pages.viewFrame=[],s.displayPagePagination=function(){if(null!=s.questionsStatus){s.identifyNumberItemPerPage();var e=s.identifyPageItem(s.currentOrder),t=s.numberItemPerPage/2,n=e>t?e-t:0,a=Math.min(n+s.numberItemPerPage,s.questionsStatus.length),i=Math.max(a-s.numberItemPerPage,0);s.pages.viewFrame=[];for(var r=i;r<a;r++)if(angular.isDefined(s.questionsStatus[r])){var o={};o.order=s.questionsStatus[r].order,o.id=s.questionsStatus[r].id,o.done=s.questionsStatus[r].done,s.pages.viewFrame.push(o)}s.addFinishPageToFrame(a),s.pages.previous=i>0,s.pages.next=a<s.questionsStatus.length}},s.finishOrder="Hoàn thành",s.addFinishPageToFrame=function(e){if(e==s.questionsStatus.length){var t={};t.order=s.finishOrder,t.id=null,t.done=!1,s.pages.viewFrame.push(t)}},s.viewPreviousFrame=function(){var e=s.identifyPageItem(s.pages.viewFrame[0].order);if(0!=e){var t=Math.max(e-s.numberItemPerPage,0),n=Math.min(t+s.numberItemPerPage,s.questionsStatus.length);s.pages.viewFrame=[];for(var a=t;a<n;a++)if(angular.isDefined(s.questionsStatus[a])){var i={};i.order=s.questionsStatus[a].order,i.id=s.questionsStatus[a].id,i.done=s.questionsStatus[a].done,s.pages.viewFrame.push(i)}s.addFinishPageToFrame(n),s.pages.previous=t>0,s.pages.next=n<s.questionsStatus.length}},s.viewNextFrame=function(){var e=s.pages.viewFrame[s.pages.viewFrame.length-1].order;if(e!=s.finishOrder){var t=s.identifyPageItem(e),n=Math.min(t+s.numberItemPerPage,s.questionsStatus.length),a=Math.max(n-s.numberItemPerPage,0);s.pages.viewFrame=[];for(var i=a;i<n;i++){if(angular.isDefined(s.questionsStatus[i])){var r={};r.order=s.questionsStatus[i].order,r.id=s.questionsStatus[i].id,r.done=s.questionsStatus[i].done}s.pages.viewFrame.push(r)}s.addFinishPageToFrame(n),s.pages.next=n<s.questionsStatus.length,s.pages.previous=a>0}},s.numberItemPerPage=0,s.identifyNumberItemPerPage=function(){var e=s.myWindow.width();e>1150?s.numberItemPerPage=22:e<=1150&&e>880?s.numberItemPerPage=16:e<=880&&e>526?s.numberItemPerPage=8:e<=526&&e>350?s.numberItemPerPage=4:s.numberItemPerPage=2},s.identifyPageItem=function(e){if(null==s.questionsStatus)return null;for(var t=s.questionsStatus.length,n=0;n<t;n++)if(s.questionsStatus[n].order==e)return n},s.selectRadio=function(e){s.questionFinished||s.examFinished||s.selectedRadio==e||(s.selectedRadio=e,s.updateRadio())},s.updateRadio=function(){if(!s.questionFinished&&!s.examFinished)for(var e=s.answers.length,t=0;t<e;t++)s.answers[t].isSelected=s.answers[t].id==s.selectedRadio},s.selectCheckbox=function(e){s.questionFinished||s.examFinished||(s.selectedCheckbox[e]=!s.selectedCheckbox[e],s.updateCheckbox())},s.updateCheckbox=function(){if(!s.questionFinished&&!s.examFinished)for(var e,t=s.answers.length,n=0;n<t;n++)e=s.answers[n].id,s.answers[n].isSelected=s.selectedCheckbox[e]},s.calculateCountDown=function(e){s.currentSecond=e%60,s.currentMinute=Math.floor(e/60)%60,s.currentHour=Math.floor(e/3600),s.currentHour<100?s.digitalTimer=("0"+s.currentHour).slice(-2)+":"+("0"+s.currentMinute).slice(-2)+":"+("0"+s.currentSecond).slice(-2):s.digitalTimer="> 99:"+("0"+s.currentMinute).slice(-2)+":"+("0"+s.currentSecond).slice(-2),s.currentHour=s.currentHour>24?24:s.currentHour},s.myCountDown=null,s.runCountDown=function(){var e=moment(),t=e.diff(s.questionBeginTime,"seconds");s.remainTime=s.duration-t,s.remainTime>0?(0!=s.countDownMode&&s.calculateCountDown(s.remainTime),s.myCountDown=n(s.runCountDown,1e3)):(s.remainTime=0,s.calculateCountDown(s.remainTime),s.closeQuestion())},s.stopCountDown=function(){n.cancel(s.myCountDown)},s.changeCountDownMode=function(){switch(s.countDownMode){case 0:s.countDownMode=1;break;case 1:s.countDownMode=2;break;case 2:s.countDownMode=3;break;default:s.countDownMode=0}},s.closeQuestion=function(){if(!s.questionFinished&&!s.examFinished){s.calculateCountDown(0),s.stopCountDown();var e=s.questionOrder,t=s.questionId;if(3==s.questionType&&n(function(){s.drawConnect()}),s.questionFinished=s.questionList[e-1].finished=!0,s.questionList[e-1].consumedTime=moment().diff(s.questionBeginTime,"seconds"),2==s.questionType){var a=angular.element(document.querySelector("#essay-pseudo"));a.focus(),n(function(){s.closeQuestionService(e,t)})}else s.closeQuestionService(e,t)}},s.closeQuestionService=function(e,t){if(!angular.isUndefined(s.questionList[e-1])){s.questionList[e-1].finished=!0;var a=s.identifyPageItem(e);s.questionsStatus[a].done=!0;var i,r,o;switch(r=s.questionList[e-1].answers.length,o=s.questionList[e-1].answers,s.questionList[e-1].questionType){case 0:case 1:for(i=0;i<r;i++)s.questionList[e-1].answers[i].isRight=o[i].isSelected==o[i].isCorrect;break;case 2:s.questionList[e-1].answers[0].isRight=o[0].description.toLowerCase()==s.essay.toLowerCase();break;case 3:var c;for(i=0;i<r;i++)c=s.questionList[e-1].answers[i].id%10,s.questionList[e-1].answers[i].isRight=o[i].correctId==o[i].matchId;n(function(){s.drawConnect()})}}},s.isFullScreen=!1,s.goFullScreen=function(){i.isEnabled()?(i.cancel(),s.isFullScreen=!1):(i.all(),s.isFullScreen=!0)},s.myWindow=angular.element(t),s.myWindow.on("resize",function(){s.displayPagePagination(),n(function(){s.drawConnect()}),e.$digest()}),s.essay="",s.changeEssay=function(e){s.questionList[s.questionOrder-1].answers[0].essay=e},s.resetSelectedMatch=function(){s.selectedAnswer=-1,s.selectedMatch=-1},s.selectAnswer=function(e,t){s.questionFinished||s.examFinished||(s.selectedAnswer=e,null!=t&&t.stopPropagation(),s.processedMatchedPair?(s.selectedMatch=-1,s.processedMatchedPair=!1):s.paringMatch())},s.selectMatch=function(e,t){s.questionFinished||s.examFinished||(s.selectedMatch=e,null!=t&&t.stopPropagation(),s.processedMatchedPair?(s.selectedAnswer=-1,s.processedMatchedPair=!1):s.paringMatch())},s.processedMatchedPair=!1,s.paringMatch=function(){if(s.selectedAnswer!=-1&&s.selectedMatch!=-1){for(var e in s.matchedPairArray)s.matchedPairArray.hasOwnProperty(e)&&s.matchedPairArray[e]==s.selectedMatch&&(s.matchedPairArray[e]=0);s.matchedPairArray[s.selectedAnswer]=s.selectedMatch,s.answers[s.selectedAnswer-1].matchId=s.selectedMatch,s.processedMatchedPair=!0,n(function(){s.drawConnect()})}},s.drawConnect=function(){if(!s.finishPage&&3==s.questionType){var e,t,n,a,i,r,o,c,u,l;for(var d in s.matchedPairArray)s.matchedPairArray.hasOwnProperty(d)&&(e=s.matchedPairArray[d],t=angular.element(document.querySelector("#answer-"+d)),a=angular.element(document.querySelector("#line1-"+d)),i=angular.element(document.querySelector("#line2-"+d)),r=angular.element(document.querySelector("#line3-"+d)),0!=e?(n=angular.element(document.querySelector("#match-"+e)),o=t.position().left+t.outerWidth(),c=t.position().top+t.outerHeight()/2,u=n.position().left,l=n.position().top+n.outerHeight()/2,a.attr("x1",o),a.attr("y1",c),a.attr("x2",o+10),a.attr("y2",c),i.attr("x1",o+10),i.attr("y1",c),i.attr("x2",u-10),i.attr("y2",l),r.attr("x1",u-10),r.attr("y1",l),r.attr("x2",u),r.attr("y2",l)):(a.attr("x1",0),a.attr("y1",0),a.attr("x2",0),a.attr("y2",0),i.attr("x1",0),i.attr("y1",0),i.attr("x2",0),i.attr("y2",0),r.attr("x1",0),r.attr("y1",0),r.attr("x2",0),r.attr("y2",0)));if(s.questionFinished||s.examFinished)for(var m=s.answers.length,g=0;g<m;g++){var h=s.answers[g];h.isRight||(t=angular.element(document.querySelector("#answer-"+h.order)),n=angular.element(document.querySelector("#match-"+h.correctId)),a=angular.element(document.querySelector("#line1c-"+h.order)),i=angular.element(document.querySelector("#line2c-"+h.order)),r=angular.element(document.querySelector("#line3c-"+h.order)),o=t.position().left+t.outerWidth(),c=t.position().top+t.outerHeight()/2+5,u=n.position().left,l=n.position().top+n.outerHeight()/2+5,a.attr("x1",o),a.attr("y1",c),a.attr("x2",o+10),a.attr("y2",c),i.attr("x1",o+10),i.attr("y1",c),i.attr("x2",u-10),i.attr("y2",l),r.attr("x1",u-10),r.attr("y1",l),r.attr("x2",u),r.attr("y2",l))}}},s.doingHelp=!1,s.hidingQuestion=!1,s.helpingType=-1,s.doHelp=function(e){if(!s.loadingQuestion&&!s.closing)switch(s.hidingQuestion=!1,s.doingHelp=!0,e){case 0:if(s.questionFinished||s.examFinished||s.disabledReduceSelection)return;s.disabledReduceSelection=!0;var t=s.questionList[s.questionOrder-1],a=t.answers.length/2>=t.numberSelection?t.answers.length/2:t.answers.length-t.numberSelection;a=Math.floor(a);var i,r,o;switch(t.questionType){case 0:case 1:for(i=[],o=0,r=0;r<t.answers.length;r++)o<a&&0==t.answers[r].isCorrect&&(i.push(t.answers[r].id),o++);break;case 2:i=null;break;case 3:for(i={},a=Math.floor(t.answers.length/2),r=0;r<a;r++)i[r+1]=t.answers[r].correctId,s.questionList[s.questionOrder-1].answers[r].matchId=t.answers[r].correctId}s.helpReduceSelection(i);break;case 1:if(s.questionFinished||s.examFinished)return;s.questionList[s.questionOrder-1].bonusTime+=s.questionList[s.questionOrder-1].timer,s.duration=parseInt(s.questionList[s.questionOrder-1].timer)+parseInt(s.questionList[s.questionOrder-1].bonusTime),s.questionList[s.questionOrder-1].finished=!1,s.questionFinished=!1,s.stopCountDown(),s.myCountDown=n(s.runCountDown,1e3);break;case 2:if(s.questionFinished||s.examFinished)return;s.questionFinished=!0,s.questionList[s.questionOrder-1].finished=!1;var c=moment().diff(s.questionBeginTime,"seconds");s.questionList[s.questionOrder-1].bonusTime=-1*(c>=s.questionList[s.questionOrder-1].timer?0:c),s.calculateCountDown(0),s.stopCountDown(),s.disabledQuestionAgain=!0,s.hidingMessage="Đã tạm hoãn câu hỏi hiện tại. Hãy chọn câu hỏi khác để thực hiện tiếp!",s.hidingQuestion=!0,s.hideQuestionContent(),delete s.questionList[s.questionOrder-1].questionBeginTime;break;case 3:if(s.questionFinished||s.examFinished)return;if(s.questionFinished=!0,s.questionList[s.questionOrder-1].finished=!0,s.questionList[s.questionOrder-1].bonusTime=0,null!=s.questionsStatus){var u=s.identifyPageItem(s.questionOrder);s.questionsStatus[u].done=!0}var l=moment(),d=l.diff(s.questionBeginTime,"seconds");s.savedTime+=s.duration-d>0?s.duration-d:0,s.calculateCountDown(0),s.stopCountDown(),s.hidingMessage="Đã tích lũy thời gian. Hãy chọn câu hỏi khác để thực hiện tiếp!",s.hidingQuestion=!0,s.hideQuestionContent();break;case 4:if(s.questionFinished||s.examFinished)return;s.questionList[s.questionOrder-1].bonusTime+=s.savedTime<=0?0:s.savedTime-60>0?60:s.savedTime,s.savedTime=s.savedTime<=0?0:s.savedTime-60>0?s.savedTime-60:0,s.duration=parseInt(s.timer)+parseInt(s.questionList[s.questionOrder-1].bonusTime),s.questionList[s.questionOrder-1].finished=!1,s.questionFinished=!1,s.stopCountDown(),s.myCountDown=n(s.runCountDown,1e3);break;case 5:if(s.examFinished||!s.questionFinished||s.disabledQuestionAgain)return;s.questionList[s.questionOrder-1].bonusTime=0,s.duration=s.questionList[s.questionOrder-1].timer,s.questionBeginTime=s.questionList[s.questionOrder-1].questionBeginTime=moment(),s.questionList[s.questionOrder-1].finished=!1,s.questionFinished=!1,s.reducedAnswers=[],s.disabledReduceSelection=!1,s.runQuestionAgain()}},s.helpReduceSelection=function(e){switch(s.questionType){case 0:case 1:if(0==e.length)return;if(s.reducedAnswers=e,0==s.questionType)s.selectedRadio=-1;else for(var t in s.selectedCheckbox)s.selectedCheckbox.hasOwnProperty(t)&&(s.selectedCheckbox[t]=!1);break;case 2:break;case 3:s.matchedPairArray=e,n(function(){s.drawConnect()})}},s.hideQuestionContent=function(){s.hidedSectionDescription=s.sectionDescription,s.hidedQuestionDescription=s.questionDescription,s.hidedAnswers=s.answers,s.sectionDescription="",s.questionDescription="",s.answers=[]},s.runQuestionAgain=function(){s.hidingQuestion&&(s.sectionDescription=s.hidedSectionDescription,s.questionDescription=s.hidedQuestionDescription,s.answers=s.hidedAnswers,n(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){s.refreshAfterMathjax()})},0)),t.scrollTo(0,0),s.showQuestion=!0,s.hidingQuestion=!1,s.showAnswerKey=!1,s.stopCountDown(),s.myCountDown=n(s.runCountDown,1e3)},s.changeQuestion=function(e){e<1||e>s.numberQuestion||null==s.questionsStatus||(s.questionOrder=e,s.loadQuestion(e))},s.medalLevel=0,s.score="",s.examResult=null,s.finishExam=function(){s.questionOrder=parseInt(s.numberQuestion)+1,s.currentOrder=s.finishOrder,s.hidingQuestion=!1,s.loadingQuestion=!1,s.loadingIcon=!1,s.finishPage=!0,s.questionFinished=!0,s.examFinished=!0,s.calculateCountDown(0),s.stopCountDown(),s.countDownMode=3,t.scrollTo(0,0);for(var e={},n=s.questionList.length,a=0,i=0,r=0,o=0,c=0;c<n;c++){switch(s.questionList[c].questionType){case 0:case 1:case 3:i=s.questionList[c].answers.length;for(var u=0;u<i&&0!=s.questionList[c].answers[u].isRight;u++);u==i&&a++;break;case 2:1==s.questionList[c].answers[0].isRight&&a++}r+=s.questionList[c].consumedTime,o+=s.questionList[c].timer}e.totalScore=e.totalQuestion=n,e.score=e.numberCorrect=a,e.consumedTime=r,e.totalTime=Math.max(o,r),s.prepareResultChart(e)},s.correctChart=null,s.consumedTimeChart=null,s.scoreChart=null,s.initResultChart=function(){s.correctChart={labels:["Đúng","Sai"],colors:["#00E676","#DCDCDC"],data:[]},s.consumedTimeChart={labels:["Thời gian sử dụng","Còn lại"],colors:["#00ADF9","#DCDCDC"],data:[]},s.scoreChart={labels:["Mức đạt","Mức chưa đạt"],colors:["#803690","#DCDCDC"],data:[]}},s.prepareResultChart=function(e){s.score=(1*e.score).toString(),s.correctChart.data=[e.numberCorrect,e.totalQuestion-e.numberCorrect],s.consumedTimeChart.data=[Math.round(e.consumedTime/60),Math.round(Math.max(0,e.totalTime-e.consumedTime)/60)],s.scoreChart.data=[e.score,Math.max(0,e.totalScore-e.score)];var t=e.numberCorrect/e.totalQuestion,n=e.consumedTime/e.totalTime,a=e.score/e.totalScore;s.medalLevel=0,1==t&&1==a?s.medalLevel=5:t>=.8&&a>=.8?s.medalLevel=4:t>=.6&&a>=.6&&n<=.9?s.medalLevel=3:t>=.3&&a>=.3?s.medalLevel=2:t>0&&a>0&&(s.medalLevel=1)},s.loadingIcon=!1,s.displayLoadingIcon=function(){s.loadingIcon=!0,e.$digest()},s.goToQuestion=function(e){if(!(e<1||e>s.numberQuestion||e==s.currentOrder)){var t=800;(s.questionFinished||s.examFinished)&&(t=0),s.hidingQuestion=!1,s.closeQuestion(),n(function(){if(s.loadingQuestion=!0,e==s.finishOrder){if(s.finishPage)return;s.loadingOrder="HT",s.finishExam()}else s.loadingQuestion=!0,s.loadingOrder=e,s.changeQuestion(e)},t)}},s.goNext=function(){s.questionOrder<s.numberQuestion?s.goToQuestion(parseInt(s.questionOrder)+1):s.goToQuestion(s.finishOrder)},s.goPrevious=function(){s.questionOrder>1&&s.goToQuestion(s.questionOrder-1)},s.exit=function(){s.hidingMessage="Đang đóng bài thi...",s.hidingQuestion=!0,s.closeQuestion(),s.questionFinished=!0,s.closing=!0,t.location.href="/"},s.shortcutKey=function(){a.open({animation:!0,templateUrl:"shortcutKeyModal.html",controller:"shortcutKeyCtrl",controllerAs:"shortcutKeyVm",keyboard:!0,size:"lg"})},s.pressingCtrlAlt=!1,e.$on("keydown",function(t,n){if(e.$apply(function(){s.pressingCtrlAlt=n.ctrlKey&&n.altKey}),s.questionFinished&&!s.examFinished&&n.ctrlKey&&n.altKey&&"l"==n.key)return void e.$apply(function(){s.doHelp(5)});if(("ArrowRight"==n.key||"Right"==n.key)&&n.ctrlKey&&n.altKey)return void e.$apply(function(){s.goNext()});if(("ArrowLeft"==n.key||"Left"==n.key)&&n.ctrlKey&&n.altKey)return void e.$apply(function(){s.goPrevious()});if(!s.questionFinished&&!s.examFinished){if(n.ctrlKey&&n.altKey){var a=-1;switch(n.key){case"g":a=0;break;case"t":a=1;break;case"s":a=2;break;case"i":a=3;break;case"x":a=4}return void(a!=-1&&e.$apply(function(){s.doHelp(a)}))}var i=null,r=null,o=!1;n.key>="1"&&n.key<="9"?(i=parseInt(n.key),o=!0):i=parseInt(n.key,36)-9;for(var c=s.answers.length,u=0;u<c;u++)if(s.answers[u].order==i){r=s.answers[u].id;break}null!=r&&e.$apply(function(){switch(s.questionType){case 0:s.selectedRadio=r;break;case 1:s.selectedCheckbox[r]=!s.selectedCheckbox[r];break;case 2:break;case 3:o?s.selectMatch(r,null):s.selectAnswer(i,null);
}})}}),e.$on("keyup",function(t,n){e.$apply(function(){s.pressingCtrlAlt=!1})})}]),mainApp.controller("accessExamCtrl",["$scope","$timeout","$window","InformationService","$uibModalInstance","vcRecaptchaService","examInfo",function(e,t,n,a,i,s,r){var o=this;o.examInfo=r,o.examInfo.remainCoin=o.examInfo.userCoin-o.examInfo.cost,o.examPasswordMessage="",o.userPasswordMessage="",o.statusMessage="",o.errorMessage="",o.captchaMessage="",o.recaptchaResponse="",o.widgetId=null,o.createReCaptcha=function(e){o.captchaMessage="",o.widgetId=e},o.successReCaptcha=function(){o.captchaMessage=""},o.resetReCaptcha=function(){o.captchaMessage="",o.recaptchaResponse="",s.reload(o.widgetId)},o.accessing=!1,o.doIt=function(){if(o.examPassword=angular.isDefined(o.examPassword)?o.examPassword.trim():"",o.examInfo.requiredExamPassword&&0==o.examPassword.length)return void(o.examPasswordMessage="Vui lòng nhập mã truy xuất đề thi");if(o.userPassword=angular.isDefined(o.userPassword)?o.userPassword.trim():"",o.examInfo.cost>0&&0==o.userPassword.length)return void(o.userPasswordMessage="Vui lòng nhập mật khẩu tài khoản");if(o.examInfo.requiredCaptcha&&0==o.recaptchaResponse.length)return void(o.captchaMessage="Xác nhận bạn không phải là người máy");o.errorMessage="";var e=new a({id:o.examInfo.examId});e.examPassword=o.examPassword,e.userPassword=o.userPassword,e.userCoin=o.examInfo.userCoin,e.cost=o.examInfo.cost,e["g-recaptcha-response"]=o.recaptchaResponse,e.verificationCode=o.examInfo.verificationCode,o.accessing=!0,e.$access(function(e){o.accessing=!1,e.success?(o.errorMessage="",o.statusMessage="Đang chuyển kênh...",n.location.href="/u/exam/"+o.examInfo.examId+"/dashboard/show"):o.errorMessage=e.message},function(e){o.accessing=!1,o.errorMessage="Lỗi kết nối server"})},o.close=function(){i.close()}}]),mainApp.controller("infoCtrl",["$scope","$window","$uibModal","$timeout","InformationService",function(e,t,n,a,i){var s=this;s.query="",s.socialCountRequest=null,s.userRatingRequest=null,s.sameCreatorRequest=null,s.similarExamRequest=null,s.init=function(e){s.userId=e.userId,s.activatedAccount=e.activatedAccount,s.examId=e.examId,s.creatorId=e.creatorId,s.titleWords=angular.isDefined(e.title)?e.title.split(/[, ]+/):"",s.available=e.available,s.requireExamPassword=e.requireExamPassword,s.requiredCaptcha=e.requiredCaptcha,s.requiredVerification=e.requiredVerification,s.userCoin=e.userCoin,s.cost=e.cost,s.isBegan=e.isBegan,s.untilToBegin=e.untilToBegin,s.countUpPoint=moment(),s.permitted=e.permitted,s.accessed=e.accessed,a(s.getSocialCounts),s.userId!=s.creatorId&&a(s.getUserRating),a(s.loadSameCreatorExams),a(s.loadSimilarExams)},s.accessExamMessage="",s.accessing=!1,s.accessExam=function(){if(s.accessExamMessage="",null==s.userId)return void(s.accessExamMessage="Bạn chưa đăng nhập");if(!s.activatedAccount)return void(s.accessExamMessage="Tài khoản của bạn chưa được kích hoạt");if(s.creatorId!=s.userId&&s.untilToBegin>0){var e=moment(),a=e.diff(s.countUpPoint,"seconds");if(a<s.untilToBegin)return void(s.accessExamMessage="Đề thi chưa bắt đầu.")}if(s.accessed)s.cancelAllRequests(),s.accessing=!0,t.location.href="/u/exam/"+s.examId+"/dashboard/show";else{if(s.creatorId!=s.userId&&s.cost>s.userCoin)return void(s.accessExamMessage="Bạn không đủ xu để thực hiện.");if(s.creatorId!=s.userId&&!s.permitted)return void(s.accessExamMessage="Đề thi giới hạn chỉ những người trong danh sách.");if(!s.available)return void(s.accessExamMessage="Đề thi đã đóng");if(s.requiredVerification){var i=n.open({animation:!0,templateUrl:"verificationCodeModal.html",controller:"verificationCodeCtrl",controllerAs:"verificationCodeVm",keyboard:!1,backdrop:"static",resolve:{examInfo:function(){return{examId:s.examId}}}});i.result.then(function(e){e.success&&(s.verificationCode=e.code,s.payExam())})}else s.payExam()}},s.verificationCode="",s.payExam=function(){var e=n.open({animation:!0,templateUrl:"accessExamModal.html",controller:"accessExamCtrl",controllerAs:"accessExamVm",keyboard:!1,openedClass:s.cost>0&&s.requireExamPassword?"cq-information":"modal-open",backdrop:"static",resolve:{examInfo:function(){return{examId:s.examId,userId:s.userId,creatorId:s.creatorId,userCoin:s.userCoin,cost:s.cost,requiredExamPassword:s.requireExamPassword,requiredCaptcha:s.requiredCaptcha,requiredVerification:s.requiredVerification,verificationCode:s.verificationCode}}}});e.result.then(function(){s.getInformationAgain()})},s.searchExam=function(){s.query=s.query.trim(),0!==s.query.length&&(t.location.href="/search?q="+s.query)},s.rateMessage="",s.rateLoaded=!1,s.starRating=0,s.hoverRating=0,s.comment="",s.getUserRating=function(){null!=s.userId&&(s.userRatingRequest=i.rating({id:s.examId},function(e){angular.isDefined(e.data)&&(s.starRating=e.data.vote_point,s.comment=e.data.vote_comment),s.rateLoaded=!0},function(e){s.rateLoaded=!1}))},s.clickStar=function(e){if(null!=s.userId){var t=new i({id:s.examId});t.vote_point=e,t.$updateVotePoint(function(e){0==e.success&&(s.starRating=0,s.rateMessage="Bạn chưa thực hiện bài kiểm tra")},function(e){s.rateMessage="Không kết nối được với server"})}},s.updateComment=function(){if(null!=s.userId){var e=new i({id:s.examId});e.vote_comment=s.comment,e.$updateComment(function(e){0==e.success&&(s.commentMessage="Bạn chưa thực hiện bài kiểm tra")},function(e){s.commentMessage="Không kết nối được với server"})}},s.mouseHoverStar=function(e){s.hoverRating=e},s.mouseLeaveStar=function(e){s.hoverRating=e+"*"},s.sameCreator={exams:[],examIdList:[],slides:[],currentSlideIdx:0,currentPage:1,lastPage:0,loading:!1,loadFn:function(){s.loadSameCreatorExams()}},s.sameCreatorLoaded=!1,s.loadSameCreatorExams=function(){var e={creatorId:s.creatorId};if(0!=s.sameCreator.lastPage){if(s.sameCreator.currentPage>=s.sameCreator.lastPage)return;e.page=parseInt(s.sameCreator.currentPage)+1}else e.page=s.sameCreator.currentPage;s.sameCreator.loading=!0,s.sameCreatorRequest=i.loadSameCreatorExam({id:s.examId},e,function(e){if(angular.isDefined(e.result)){s.sameCreator.currentPage=e.result.current_page,s.sameCreator.lastPage=e.result.last_page,null==e.result.prev_page_url&&(s.sameCreator.currentSlideIdx=0);for(var t=0;t<e.result.data.length;t++)s.sameCreator.examIdList.indexOf(e.result.data[t].id)==-1&&e.result.data[t].id!=s.examId&&(s.sameCreator.exams.push(e.result.data[t]),s.sameCreator.examIdList.push(e.result.data[t].id));s.identifyNumberExamPerSlide(),s.buildSlide(s.sameCreator),s.sameCreatorLoaded=!0}s.sameCreator.loading=!1},function(e){s.sameCreator.loading=!1})},s.similarExams={exams:[],examIdList:[],slides:[],currentSlideIdx:0,currentTitleIdx:0,step:2,loading:!1,loadFn:function(){s.loadSimilarExams()}},s.similarExamsLoaded=!1,s.loadSimilarExams=function(){if(s.titleWords.length<2)return void(s.similarExams.loading=!1);if(s.similarExams.currentTitleIdx+s.similarExams.step>s.titleWords.length){if(2==s.similarExams.step)s.similarExams.step++;else if(3==s.similarExams.step)s.similarExams.step++;else{if(4!=s.similarExams.step)return void(s.similarExams.loading=!1);s.similarExams.step=1}s.similarExams.currentTitleIdx=0}for(var e="",t=0;t<s.similarExams.step;t++)e+=s.titleWords[s.similarExams.currentTitleIdx+t]+" ";e=e.trim(),s.similarExams.currentTitleIdx++;var n=e.length>255?substr(e,0,255):e;s.similarExams.loading=!0,s.similarExamRequest=i.loadSimilarExam({id:s.examId},{q:n},function(e){if(s.similarExams.loading=!1,angular.isDefined(e.result)){for(var t=0,n=0;n<e.result.length;n++)s.similarExams.examIdList.indexOf(e.result[n].id)==-1&&e.result[n].id!=s.examId&&(s.similarExams.exams.push(e.result[n]),s.similarExams.examIdList.push(e.result[n].id),t++);0==t?s.similarExams.currentTitleIdx+s.similarExams.step<s.titleWords.length&&s.loadSimilarExams():(s.identifyNumberExamPerSlide(),s.buildSlide(s.similarExams)),s.similarExamsLoaded=!0}},function(e){s.similarExams.loading=!1})},s.goNextSlide=function(e){e.loading||(e.currentSlideIdx+1>=e.slides.length?e.currentSlideIdx=e.slides.length-1:e.currentSlideIdx++,e.currentSlideIdx>=e.slides.length-2&&e.loadFn())},s.goPreviousSlide=function(e){e.currentSlideIdx=e.currentSlideIdx<=0?0:e.currentSlideIdx-1},s.myWindow=angular.element(t),s.myWindow.on("resize",function(){s.identifyNumberExamPerSlide(),s.buildSlide(s.sameCreator),s.buildSlide(s.similarExams),e.$digest()}),s.numberExamPerSlide=0,s.oldExamPerSlide=0,s.identifyNumberExamPerSlide=function(){var e=s.myWindow.width();s.oldExamPerSlide=s.numberExamPerSlide,e>974?s.numberExamPerSlide=4:e<=974&&e>750?s.numberExamPerSlide=3:e<=750&&e>526?s.numberExamPerSlide=2:s.numberExamPerSlide=1},s.buildSlide=function(e){e.slides=s.rebuildSlide(e.exams,s.numberExamPerSlide),0!=s.oldExamPerSlide&&(e.currentSlideIdx=Math.round((e.currentSlideIdx+1)*s.oldExamPerSlide/s.numberExamPerSlide)-1,e.currentSlideIdx>e.slides.length-1&&(e.currentSlideIdx=e.slides.length-1),e.currentSlideIdx<0&&(e.currentSlideIdx=0))},s.rebuildSlide=function(e,t){var n,a=[],i={},s=[],r="";for(n=0;n<e.length;n++)s.length===t&&(i.identify=r,i.exams=s,a.push(i),i={},s=[],r=""),s.push(e[n]),r+=e[n].id;return i.identify=r,i.exams=s,a.push(i),a},s.getStar=function(e,t){var n=0==t?0:Math.round(e/t);return new Array(n)},s.getUnStar=function(e,t){var n=0==t?5:5-Math.round(e/t);return new Array(n)},s.facebookCount="",s.twitterCount="",s.gplusCount="",s.stumbleCount="",s.socialCountLoaded=!1,s.getSocialCounts=function(){s.socialCountRequest=i.socialCount({id:s.examId},function(e){angular.isDefined(e.data)&&(s.facebookCount=e.data.facebook,s.twitterCount=e.data.twitter,s.gplusCount=e.data.gplus,s.stumbleCount=e.data.stumble,s.socialCountLoaded=!0)},function(e){})},s.cancelAllRequests=function(){null!=s.socialCountRequest&&s.socialCountRequest.$cancelRequest(),null!=s.userRatingRequest&&s.userRatingRequest.$cancelRequest(),null!=s.sameCreatorRequest&&s.sameCreatorRequest.$cancelRequest(),null!=s.similarExamRequest&&s.similarExamRequest.$cancelRequest()},s.getInformationAgain=function(){s.rateLoaded||s.userId==s.creatorId||s.getUserRating(),s.socialCountLoaded||s.getSocialCounts(),s.sameCreatorLoaded||s.loadSameCreatorExams(),s.similarExamsLoaded||s.loadSimilarExams()}}]),mainApp.controller("verificationCodeCtrl",["$scope","$uibModalInstance","InformationService","examInfo",function(e,t,n,a){var i=this;i.examId=a.examId,i.code="",i.statusMessage="",i.requested=!1,i.processing=!1,i.init=function(){n.requestVerification({id:i.examId},function(e){e.success?i.requested=!0:i.statusMessage=e.message},function(e){i.statusMessage="Lỗi không thể gửi yêu cầu xác nhận."})},i.init(),i.cancel=function(){t.close({success:!1,code:""})},i.finish=function(){return""==i.code||16!=i.code.length?void(i.statusMessage="Mã không hợp lệ"):(i.processing=!0,i.statusMessage="Hệ thống đang kiểm tra mã...",void n.verifyCode({id:i.examId},{code:i.code},function(e){e.success?t.close({success:!0,code:i.code}):i.statusMessage="Mã không khớp.",i.processing=!1},function(e){i.statusMessage="Lỗi kiểm tra mã.",i.processing=!1}))}}]),mainApp.controller("leaderBoardMajorCtrl",["$scope","$timeout","LeaderBoardService",function(e,t,n){var a=this;a.statusMessage="",a.students=null,a.init=function(e){a.examId=e.examId,a.creatorId=e.creatorId,a.page=0,a.students=[],t(a.loadLeaderBoard)},a.leaderBoardRequest=null,a.loadLeaderBoard=function(){a.loading=!0,a.leaderBoardRequest=n.loadLeaderBoard({id:a.examId},function(e){a.loading=!1,e.success&&(a.students=e.data,a.page=1)},function(e){a.loading=!1})},a.loading=!1,a.leaderBoardMoreRequest=null,a.loadMoreStudent=function(){a.loading=!0,a.leaderBoardMoreRequest=n.loadMoreStudent({id:a.examId,page:a.page+1},function(e){a.loading=!1,e.success&&(a.page++,a.students=a.students.concat(e.data))},function(e){a.loading=!1,a.statusMessage="Lỗi kết nối server"})},e.$on("$locationChangeSuccess",function(e,t,n){t.split("#")[0]!=n.split("#")[0]&&(null!=a.leaderBoardRequest&&a.leaderBoardRequest.$cancelRequest(),null!=a.leaderBoardMoreRequest&&a.leaderBoardMoreRequest.$cancelRequest())})}]),mainApp.controller("confirmFinishCtrl",["$scope","$uibModalInstance",function(e,t){var n=this;n.cancel=function(){t.close(!1)},n.finish=function(){t.close(!0)}}]),mainApp.controller("reduceSelectionCtrl",["$scope","$uibModalInstance","questionOrder","cost",function(e,t,n,a){var i=this;i.questionOrder=n,i.cost=a,i.cancel=function(){t.close(!1)},i.finish=function(){t.close(!0)}}]),mainApp.controller("runExamCtrl",["$scope","$window","$location","$timeout","$animate","$uibModal","$anchorScroll","Fullscreen","RunService",function(e,t,n,a,i,s,r,o,c){var u=this;u.statusMessage="",u.updateTryTime=0,u.maxTryTime=60,MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]),u.loadingExam=!1,u.finishPage=!1,u.init=function(e){u.countDownMode=1,u.userIsCreator=e.userIsCreator,u.backPage=e.backPage,u.examId=e.examId,u.coin=1*e.coin,u.timeWholeExam=e.timeWholeExam,u.reduceSelectionCost=e.reduceSelectionCost,u.remainReduceSelection=e.remainReduceSelection,u.numberQuestion=e.numberQuestion,u.timeZone=e.timeZone,u.showNumberSelection=e.showNumberSelection,u.loadingExam=!0;var t=parseInt(e.order,10);isNaN(t)||t<1||t>e.numberQuestion?u.beginOrder=1:u.beginOrder=t;var n=angular.element(document.querySelector("#cq-run-init"));n.remove(),a(u.loadAllQuestion),a(u.initResultChart)},u.loadAllQuestion=function(){var e=new c({examId:u.examId});e.beginOrder=u.beginOrder,e.$loadAllQuestion(function(e){e.success?(u.questionsStatus=e.data.questionsStatus,u.remainTime=e.data.remainTime,u.examFinished=e.data.examFinished,u.showAnswerKey=e.data.showAnswerKey,u.showAnswerKey||(u.encryptKey=e.data.encryptKey,u.iv=e.data.iv),u.loadedSections=e.data.sections,u.loadSection(e.data.loadToSection,u.beginOrder)):(u.loadingExam=!1,u.hidingExam=!0,u.hidingMessage="Bạn vui lòng kiểm tra lại thiết lập. Nếu thiết lập trình diễn tất cả câu hỏi, thì cách tích thời gian là toàn bài.")},function(e){u.loadingExam=!1,u.hidingExam=!0,u.hidingMessage="Không kết nối được với máy chủ. Vui lòng thử lại"})},u.sections=[],u.loadedSections=[],u.loadSection=function(t,i){var s=u.loadedSections.length;u.loadedSections.length-u.sections.length>5&&(s=u.sections.length+5),s<t&&(s=t);for(var o=u.sections.length;o<s;o++)u.sections.push(u.loadedSections[o]);u.currentOrder=i,u.displayPagePagination(),a(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){n.search("order",u.currentOrder).hash("question-"+u.currentOrder).replace(),r.yOffset=135,r(),u.loadingExam=!1,u.calculateCountDown(0),u.stopCountDown(),u.examFinished||(u.startPoint=moment(),u.myCountDown=a(u.runCountDown,1e3)),u.reDrawAllConnect(),u.checkHelps(),e.$digest()})},0)},u.loadMoreSection=function(){if(u.loadedSections.length!=u.sections.length){var t=u.loadedSections.length;u.loadedSections.length-u.sections.length>10&&(t=u.sections.length+10);for(var n=u.sections.length;n<t;n++)u.sections.push(u.loadedSections[n]);a(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){u.reDrawAllConnect(),e.$digest()})},0)}},u.getNameFromNumber=function(e){var t=(e-1)%26,n=String.fromCharCode(65+t),a=Math.floor((e-1)/26);return a>0?u.getNameFromNumber(a)+n:n},u.questionsStatus=null,u.pages={},u.currentOrder=1,u.pages.previous=!1,u.pages.next=!1,u.pages.viewFrame=[],u.displayPagePagination=function(){if(null!=u.questionsStatus){u.identifyNumberItemPerPage();var e=u.identifyPageItem(u.currentOrder),t=u.numberItemPerPage/2,n=e>t?e-t:0,a=Math.min(n+u.numberItemPerPage,u.questionsStatus.length),i=Math.max(a-u.numberItemPerPage,0);u.pages.viewFrame=[];for(var s=i;s<a;s++)if(angular.isDefined(u.questionsStatus[s])){var r={};r.order=u.questionsStatus[s].order,r.id=u.questionsStatus[s].id,r.sectionId=u.questionsStatus[s].sectionId,r.done=u.questionsStatus[s].done,u.pages.viewFrame.push(r)}u.addFinishPageToFrame(a),u.pages.previous=i>0,u.pages.next=a<u.questionsStatus.length}},u.finishOrder="Hoàn thành",u.addFinishPageToFrame=function(e){if(e==u.questionsStatus.length){var t={};t.order=u.finishOrder,t.id=null,t.sectionId=null,t.done=!1,u.pages.viewFrame.push(t)}},u.viewPreviousFrame=function(){var e=u.identifyPageItem(u.pages.viewFrame[0].order);if(0!=e){var t=Math.max(e-u.numberItemPerPage,0),n=Math.min(t+u.numberItemPerPage,u.questionsStatus.length);u.pages.viewFrame=[];for(var a=t;a<n;a++)if(angular.isDefined(u.questionsStatus[a])){var i={};i.order=u.questionsStatus[a].order,i.id=u.questionsStatus[a].id,i.sectionId=u.questionsStatus[a].sectionId,i.done=u.questionsStatus[a].done,u.pages.viewFrame.push(i)}u.addFinishPageToFrame(n),u.pages.previous=t>0,u.pages.next=n<u.questionsStatus.length}},u.viewNextFrame=function(){var e=u.pages.viewFrame[u.pages.viewFrame.length-1].order;if(e!=u.finishOrder){var t=u.identifyPageItem(e),n=Math.min(t+u.numberItemPerPage,u.questionsStatus.length),a=Math.max(n-u.numberItemPerPage,0);u.pages.viewFrame=[];for(var i=a;i<n;i++)if(angular.isDefined(u.questionsStatus[i])){var s={};s.order=u.questionsStatus[i].order,s.id=u.questionsStatus[i].id,s.sectionId=u.questionsStatus[i].sectionId,s.done=u.questionsStatus[i].done,u.pages.viewFrame.push(s)}u.addFinishPageToFrame(n),u.pages.next=n<u.questionsStatus.length,u.pages.previous=a>0}},u.numberItemPerPage=0,u.identifyNumberItemPerPage=function(){var e=u.myWindow.width();e>1150?u.numberItemPerPage=22:e<=1150&&e>880?u.numberItemPerPage=16:e<=880&&e>526?u.numberItemPerPage=8:e<=526&&e>350?u.numberItemPerPage=4:u.numberItemPerPage=2},u.identifyPageItem=function(e){if(null==u.questionsStatus)return null;for(var t=u.questionsStatus.length,n=0;n<t;n++)if(u.questionsStatus[n].order==e)return n},u.selectRadio=function(e,t,n,a){u.examFinished||(u.sections[e].questions[t].selectedRadio=a,u.updateRadio(e,t,n,a))},u.updateRadio=function(e,t,i,s){if(!u.examFinished){var r=u.sections[e].questions[t].order,o=u.identifyPageItem(r);u.questionsStatus[o].done=!0,u.currentOrder=r,u.displayPagePagination(),n.search("order",r).hash("_").replace();var l=new c({examId:u.examId,questionId:i});l.selectedId=s,l.sectionIdx=e,l.questionIdx=t,l.$updateAnswers(function(e){u.updateTryTime=0},function(e){u.statusMessage="Chưa cập nhật câu trả lời được. Đang gửi lại...",u.updateTryTime<u.maxTryTime&&(u.updateTryTime++,a(u.updateRadio,1e4,!0,l.sectionIdx,l.questionIdx,l.questionId,l.selectedId))})}},u.selectCheckbox=function(e,t,n){u.examFinished||(u.sections[e].questions[t].answers[n].isSelected=u.sections[e].questions[t].answers[n].isSelected?0:1,u.updateCheckbox(e,t))},u.updateCheckbox=function(e,t){var i,s=u.sections[e].questions[t].answers.length,r=u.sections[e].questions[t].id,o={},l=u.sections[e].questions[t].order,d=u.identifyPageItem(l);u.questionsStatus[d].done=!1;for(var m=0;m<s;m++)i=u.sections[e].questions[t].answers[m],o[i.id]=i.isSelected,i.isSelected&&(u.questionsStatus[d].done=!0);u.currentOrder=l,u.displayPagePagination(),n.search("order",l).hash("_").replace();var g=new c({examId:u.examId,questionId:r});g.checkedStatusArray=o,g.sectionIdx=e,g.questionIdx=t,g.$updateAnswers(function(e){u.updateTryTime=0},function(e){u.statusMessage="Chưa cập nhật câu trả lời được. Đang gửi lại...",u.updateTryTime<u.maxTryTime&&(u.updateTryTime++,a(u.updateCheckbox,1e4,!0,g.sectionIdx,g.questionIdx))})},u.calculateCountDown=function(e){u.currentSecond=e%60,u.currentMinute=Math.floor(e/60)%60,u.currentHour=Math.floor(e/3600),u.currentHour<100?u.digitalTimer=("0"+u.currentHour).slice(-2)+":"+("0"+u.currentMinute).slice(-2)+":"+("0"+u.currentSecond).slice(-2):u.digitalTimer="> 99:"+("0"+u.currentMinute).slice(-2)+":"+("0"+u.currentSecond).slice(-2),u.currentHour=u.currentHour>24?24:u.currentHour},u.myCountDown=null,u.localRemainTime=0,u.runCountDown=function(){var e=moment(),t=e.diff(u.startPoint,"seconds");u.localRemainTime=u.remainTime-t,u.localRemainTime>0?(0!=u.countDownMode&&u.calculateCountDown(u.localRemainTime),u.myCountDown=a(u.runCountDown,1e3)):(u.localRemainTime=0,u.calculateCountDown(u.localRemainTime),u.displayFinishPage=!1,u.finishExam())},u.stopCountDown=function(){a.cancel(u.myCountDown)},u.changeCountDownMode=function(){switch(u.countDownMode){case 0:u.countDownMode=1;break;case 1:u.countDownMode=2;break;case 2:u.countDownMode=3;break;default:u.countDownMode=0}},u.isFullScreen=!1,u.goFullScreen=function(){o.isEnabled()?(o.cancel(),u.isFullScreen=!1):(o.all(),u.isFullScreen=!0)},u.myWindow=angular.element(t),u.myWindow.on("resize",function(){u.displayPagePagination(),a(function(){u.reDrawAllConnect()}),e.$digest()});var l="fontselect | fontsizeselect | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist indent outdent | image media | code | mathtype";u.questionEditing=!1,u.editorSettings={language_url:"/js/tinymce-v451/langs/vi.js",external_plugins:{advlist:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/advlist/plugin.min.js",link:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/link/plugin.min.js",image:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/image/plugin.min.js",imagetools:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/imagetools/plugin.min.js",lists:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/lists/plugin.min.js",charmap:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/charmap/plugin.min.js",hr:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/hr/plugin.min.js",searchreplace:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/searchreplace/plugin.min.js",media:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/media/plugin.min.js",table:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/table/plugin.min.js",contextmenu:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/contextmenu/plugin.min.js",paste:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/paste/plugin.min.js",textcolor:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/textcolor/plugin.min.js",colorpicker:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/colorpicker/plugin.min.js",code:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/code/plugin.min.js"},themes:"inlite",inline:!0,trusted:!0,theme:"modern",language:"vi",plugins:["advlist link image imagetools lists charmap hr","searchreplace media","table contextmenu paste textcolor colorpicker code"],contextmenu:"cut copy paste | link image inserttable | cell row column deletetable",menu:{edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall | searchreplace"},insert:{title:"Insert",items:"image media link | charmap hr template | mathtype"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"},tools:{title:"Tools",items:"code"},help:{title:"Help",items:"editorhelp mathtypehelp"}},menubar:"edit insert format table tools help",toolbar:l,table_default_styles:{width:"100%"},statusbar:!1,fontsize_formats:"8pt 10pt 12pt 14pt 16pt 18pt 20pt 22pt 24pt 26pt 28pt 32pt 36pt 48pt 72pt",custom_undo_redo_levels:10,image_advtab:!0,relative_urls:!1,remove_script_host:!1,convert_urls:!0,content_css:["/css/bootstrap.min.css?"+(new Date).getTime()],entity_encoding:"raw",extended_valid_elements:"*[*]",setup:function(e){function t(){e.windowManager.open({title:"Công thức",url:"/u/mathtype",width:700,height:600},{oninsert:function(t,n){var a;a=n?'<div class="math">$$'+t+"$$</div><p></p>":"&nbsp;\\("+t+"\\)&#8204;&nbsp;",e.insertContent(a,null),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id])}})}e.addMenuItem("editorhelp",{text:"Editor guide",context:"help",onclick:function(){e.windowManager.open({title:"Hướng dẫn soạn thảo",url:"/guide/editor?tinymce=1",width:800,height:570})}}),e.addMenuItem("mathtypehelp",{text:"Mathtype guide",context:"help",onclick:function(){e.windowManager.open({title:"Hướng dẫn gõ công thức",url:"/guide/mathtype?tinymce=1",width:800,height:570})}}),e.addMenuItem("mathtype",{text:"Công thức",context:"insert",icon:"sigma",onclick:function(){t()}}),e.addButton("mathtype",{text:"Công thức",tooltip:"Gõ công thức toán, hóa học",icon:!1,onclick:function(){t()}}),e.on("init",function(){u.essayEditor=e,e.selectedMathId=null,e.selectedMathDisplay=!1,e.moveNext=!0,e.pressSpace=!1,e.beginInlineMath=!1,e.endInlineMath=!1,e.runMathJax=!1,$("#"+e.id).find(".scriptMath").each(function(){var e=$(this).html();$(this).before(e)}),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id])}),e.on("change",function(){e.endInlineMath?(e.endInlineMath=!1,e.runMathJax=!0,e.execCommand("mceInsertContent",!1,"&zwnj;")):e.runMathJax&&(e.runMathJax=!1,MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id]))}),e.on("click",function(t){u.questionEditing=!0;var n=$(t.target),a=n.closest(".MathJax_SVG");if(a.length>0)if(null!=e.selectedMathId&&a.attr("id")!=e.selectedMathId){var i=$(".editMath");if(i.length>0){var s=i.html();if(e.selectedMathDisplay){var r=i.closest(".MathJax_SVG_Display");r.replaceWith("$$"+s+"$$")}else i.replaceWith("\\("+s+"\\)");MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id],function(){e.selectedMathId=a.attr("id");var t,i,s=n.closest(".MathJax_SVG_Display");t=s.length>0?s.next("script"):a.next("script"),i=t.html(),e.selectedMathDisplay=t.attr("type").indexOf("mode=display")>-1,t.remove(),a.after('<span class="editMath" id="editMath_'+e.selectedMathId+'" style="border: 1px solid red; padding: 2px 2px;">'+i+"</span>"),a.remove()})}}else{e.selectedMathId=a.attr("id");var o,c,l=n.closest(".MathJax_SVG_Display");o=l.length>0?l.next("script"):a.next("script"),c=o.html(),e.selectedMathDisplay=o.attr("type").indexOf("mode=display")>-1,o.remove(),a.after('<span class="editMath" id="editMath_'+e.selectedMathId+'" style="border: 1px solid red; padding: 2px 2px;">'+c+"</span>"),a.remove()}}),e.on("blur",function(){u.questionEditing=!1}),e.on("NodeChange",function(t){var n=$(t.element),a=n.closest(".MathJax_SVG_Display");if(0==a.length&&(a=n.closest(".MathJax_SVG")),a.length>0){var i=a.find("img");i.length>0&&(i.remove(),a.before(i),a.before("&zwnj;"))}var s=n.closest(".editMath");if(0==s.length&&null!=e.selectedMathId){var r=$(".editMath");if(r.length>0){e.selectedMathId=null;var o=r.html();if(e.selectedMathDisplay){var c=r.closest(".MathJax_SVG_Display");c.replaceWith("$$"+o+"$$")}else r.replaceWith("\\("+o+"\\)");MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id])}}if(a.length>0&&0==s.length){var u,l=rangy.getSelection();u=rangy.createRange();var d;if(1==e.moveNext){if(d=a[0].nextSibling.nextSibling,null==d&&(d=a[0].parentNode.nextSibling.firstChild),d.nodeType!=Node.TEXT_NODE)for(var m=d.childNodes,g=0;g<m.length;g++){var h=m[g];if(3==h.nodeType){d=h;break}}var p=0;d.nodeType==Node.TEXT_NODE&&8204===d.wholeText.charCodeAt(0)&&(p=1),u.setStart(d,p),u.setEnd(d,p)}else{if(d=a[0].previousSibling,null==d&&(d=a[0].parentNode.previousSibling.lastChild),d.nodeType!=Node.TEXT_NODE)for(var f=d.childNodes,x=f.length;x--;){var v=f[x];if(3==v.nodeType){d=v;break}}u.setStart(d,d.length),u.setEnd(d,d.length)}l.removeAllRanges(),l.addRange(u)}}),e.on("KeyDown",function(t){if("Tab"!=t.key&&u.examFinished)return void t.preventDefault();e.moveNext="ArrowRight"==t.key||"Right"==t.key,e.endInlineMath=")"==t.key,e.runMathJax="]"==t.key||"$"==t.key;var n=["Backspace","Enter","Shift","Control","Alt","CapsLock","PageUp","PageDown","End","Home","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Delete","Left","Up","Right","Down","Del"];if(n.indexOf(t.key)==-1){var a=e.getContent().length;if(u.checkLengthOverLimit(a))return e.stopPropagation(),e.preventDefault(),!1}return"\\"!=t.key||e.pressSpace?void(e.pressSpace=" "==t.key||"\\"==t.key):(e.execCommand("mceInsertContent",!1," \\"),e.preventDefault(),e.stopPropagation(),e.pressSpace=!0,!1)})}},u.checkLengthOverLimit=function(e){var t=2e4;return e>t?(u.statusMessage="Chiều dài vượt giới hạn!",!0):(u.statusMessage="",!1)},u.updateEssay=function(e,t,n,i){if(!u.examFinished){var s=$("<div />").append(i);s.find("script").replaceWith(function(){var e=$(this).html().replace("// <![CDATA[","").replace("// ]]>","").trim(),t=$(this).attr("type");return e="undefined"!=typeof t&&"math/tex; mode=display"==t?"$$"+e+"$$":"\\("+e+"\\)&amp; zwnj;"}),s.find(".MathJax_SVG_Display, .MathJax_SVG, .editMath").remove();var r=s.html();if(r=r.replace(/&amp; zwnj;/g,"&zwnj;"),r=r.replace(/[\n\t]+/g,""),!u.checkLengthOverLimit(r)){var o=u.sections[e].questions[t].order,l=u.identifyPageItem(o);u.questionsStatus[l].done||(u.questionsStatus[l].done=!0);var d=new c({examId:u.examId,questionId:n});d.essay=r,d.sectionIdx=e,d.questionIdx=t,d.$updateAnswers(function(e){u.updateTryTime=0},function(e){u.statusMessage="Chưa cập nhật câu trả lời được. Đang gửi lại...",u.updateTryTime<u.maxTryTime&&(u.updateTryTime++,a(u.updateEssay,1e4,!0,d.sectionIdx,d.questionIdx,d.questionId,d.essay))})}}},u.resetSelectedMatch=function(){u.selectedQuestion=-1,u.selectedAnswer=-1,u.selectedQuestionMatch=-1,u.selectedMatch=-1},u.selectAnswer=function(e,t,a,i){if(!u.examFinished){u.selectedQuestion=u.sections[e].questions[t].id,u.selectedAnswer=a,null!=i&&i.stopPropagation(),u.processedMatchedPair||u.selectedQuestion!=u.selectedQuestionMatch?(u.selectedQuestionMatch=-1,u.selectedMatch=-1,u.processedMatchedPair=!1):u.paringMatch(e,t,u.selectedQuestion,u.selectedQuestionMatch,u.selectedAnswer,u.selectedMatch);var s=u.sections[e].questions[t].order;u.currentOrder=s,u.displayPagePagination(),n.search("order",s).hash("_").replace()}},u.selectMatch=function(e,t,a,i){if(!u.examFinished){u.selectedQuestionMatch=u.sections[e].questions[t].id,u.selectedMatch=a,null!=i&&i.stopPropagation(),u.processedMatchedPair||u.selectedQuestion!=u.selectedQuestionMatch?(u.selectedQuestion=-1,u.selectedAnswer=-1,u.processedMatchedPair=!1):u.paringMatch(e,t,u.selectedQuestion,u.selectedQuestionMatch,u.selectedAnswer,u.selectedMatch);var s=u.sections[e].questions[t].order;u.currentOrder=s,u.displayPagePagination(),n.search("order",s).hash("_").replace()}},u.processedMatchedPair=!1,u.paringMatch=function(e,t,n,i,s,r){if(s!=-1&&r!=-1&&n==i){var o=u.sections[e].questions[t].order,l=u.identifyPageItem(o);u.questionsStatus[l].done=!0;for(var d,m,g=u.sections[e].questions[t].id,h={},p=u.sections[e].questions[t].answers.length,f=0;f<p;f++)d=u.sections[e].questions[t].answers[f].order,d==s?u.sections[e].questions[t].answers[f].matchId=r:(m=u.sections[e].questions[t].answers[f].matchId,m==r&&(u.sections[e].questions[t].answers[f].matchId=0)),h[d]=u.sections[e].questions[t].answers[f].matchId;u.processedMatchedPair=!0,u.drawConnect(e,t);var x=new c({examId:u.examId,questionId:g});x.matchedPairArray=h,x.sectionIdx=e,x.questionIdx=t,x.selectedQuestion=n,x.selectedQuestionMatch=i,x.selectedAnswer=s,x.selectedMatch=r,x.$updateAnswers(function(e){u.updateTryTime=0},function(e){u.statusMessage="Chưa cập nhật câu trả lời được. Đang gửi lại...",u.updateTryTime<u.maxTryTime&&(u.updateTryTime++,a(u.paringMatch,1e4,!0,x.sectionIdx,x.questionIdx,x.selectedQuestion,x.selectedQuestionMatch,x.selectedAnswer,x.selectedMatch))})}},u.drawConnect=function(e,t){if(!u.finishPage){var n=u.sections[e].questions[t];if(3==n.type){var a,i,s,r,o,c,l,d,m,g,h,p,f=n.id,x=n.answers.length;for(h=0;h<x;h++)p=n.answers[h].order,a=n.answers[h].matchId,i=angular.element(document.querySelector("#answer-"+f+"-"+p)),r=angular.element(document.querySelector("#line1-"+f+"-"+p)),o=angular.element(document.querySelector("#line2-"+f+"-"+p)),c=angular.element(document.querySelector("#line3-"+f+"-"+p)),0!=a?(s=angular.element(document.querySelector("#match-"+f+"-"+a)),l=i.position().left+i.outerWidth(),d=i.position().top+i.outerHeight()/2,m=s.position().left,g=s.position().top+s.outerHeight()/2,r.attr("x1",l),r.attr("y1",d),r.attr("x2",l+10),r.attr("y2",d),o.attr("x1",l+10),o.attr("y1",d),o.attr("x2",m-10),o.attr("y2",g),c.attr("x1",m-10),c.attr("y1",g),c.attr("x2",m),c.attr("y2",g)):(r.attr("x1",0),r.attr("y1",0),r.attr("x2",0),r.attr("y2",0),o.attr("x1",0),o.attr("y1",0),o.attr("x2",0),o.attr("y2",0),c.attr("x1",0),c.attr("y1",0),c.attr("x2",0),
c.attr("y2",0));if(u.showAnswerKey)for(h=0;h<x;h++){var v=n.answers[h];v.isRight||(i=angular.element(document.querySelector("#answer-"+f+"-"+v.order)),s=angular.element(document.querySelector("#match-"+f+"-"+v.correctId)),r=angular.element(document.querySelector("#line1c-"+f+"-"+v.order)),o=angular.element(document.querySelector("#line2c-"+f+"-"+v.order)),c=angular.element(document.querySelector("#line3c-"+f+"-"+v.order)),l=i.position().left+i.outerWidth(),d=i.position().top+i.outerHeight()/2+5,m=s.position().left,g=s.position().top+s.outerHeight()/2+5,r.attr("x1",l),r.attr("y1",d),r.attr("x2",l+10),r.attr("y2",d),o.attr("x1",l+10),o.attr("y1",d),o.attr("x2",m-10),o.attr("y2",g),c.attr("x1",m-10),c.attr("y1",g),c.attr("x2",m),c.attr("y2",g))}}}},u.reDrawAllConnect=function(){var e,t,n;e=u.sections.length;for(var a=0;a<e;a++){t=u.sections[a].questions.length;for(var i=0;i<t;i++)n=u.sections[a].questions[i],3==n.type&&u.drawConnect(a,i)}},u.checkHelps=function(){u.isHelpReduceSelection=!u.examFinished&&u.reduceSelectionCost>=0&&(u.userIsCreator||u.reduceSelectionCost<=u.coin)&&u.remainReduceSelection>0},u.doingHelp=!1,u.hidingExam=!1,u.helpingType=-1,u.doHelp=function(e,t,n){if(!u.loadingExam&&!u.closing){if(u.doingHelp)return void(u.statusMessage="Đang xử lý hỗ trợ khác, vui lòng đợi...");if(t){var i,r,o=u.currentOrder,l=u.identifyPageItem(o),d=u.questionsStatus[l].id,m=u.questionsStatus[l].sectionId,g=-1,h=-1;i=u.sections.length;for(var p=0;p<i;p++)if(u.sections[p].id==m){g=p,r=u.sections[p].questions.length;for(var f=0;f<r;f++)if(u.sections[p].questions[f].id==d){h=f;break}break}if(g!=-1&&h!=-1&&2==u.sections[g].questions[h])return u.statusMessage="Loại câu hỏi của "+o+" không được hỗ trợ...",void a(function(){u.statusMessage=""},5e3);if(u.localRemainTime<=5)return u.statusMessage="Thời gian còn lại quá ít để thực hiện hỗ trợ này",void a(function(){u.statusMessage=""},5e3);var x=s.open({animation:!0,templateUrl:"reduceSelectionModal.html",controller:"reduceSelectionCtrl",controllerAs:"reduceSelectionVm",keyboard:!0,size:null,resolve:{questionOrder:function(){return u.currentOrder},cost:function(){return u.reduceSelectionCost}}});x.result.then(function(t){if(1==t){u.doingHelp=!0,u.statusMessage="Đang xử lý hỗ trợ...";var n=c.helpQuestion({examId:u.examId,questionId:d,type:e},function(e){u.statusMessage="",e.success?(angular.isDefined(e.coin)&&(u.coin=1*e.coin),u.remainReduceSelection=e.remainReduceSelection,u.helpReduceSelection(e.questionId,e.reducedAnswers),u.checkHelps()):(u.statusMessage=e.message,a(function(){u.statusMessage=""},5e3)),u.doingHelp=!1},function(e){u.doingHelp=!1,u.statusMessage=""});u.myCancelableRequests.length>=500&&u.myCancelableRequests.shift(),u.myCancelableRequests.push(n)}})}else n>=0&&u.coin<=n&&u.localRemainTime>0&&(u.statusMessage="Không đủ xu để thực hiện",a(function(){u.statusMessage=""},5e3))}},u.helpReduceSelection=function(e,t){var n,i,s,r=-1,o=-1;for(i=u.sections.length,n=0;n<i;n++){r=n,s=u.sections[n].questions.length;for(var c=0;c<s;c++)if(u.sections[n].questions[c].id==e){o=c;break}if(o!=-1)break}if(r!=-1&&o!=-1){var l=u.sections[r].questions[o];switch(l.type){case 0:case 1:if(0==t.length)return;var d=l.answers.length;for(n=d-1;n>=0;n--){var m=l.answers[n];t.indexOf(m.id)!==-1&&u.sections[r].questions[o].answers.splice(n,1)}if(0==l.type)u.sections[r].questions[o].selectedRadio=-1;else for(d=u.sections[r].questions[o].answers.length,n=0;n<d;n++)u.sections[r].questions[o].answers[n].isSelected=!1;break;case 2:break;case 3:var g,h=u.sections[r].questions[o].answers.length;for(n=0;n<h;n++)g=u.sections[r].questions[o].answers[n].order,u.sections[r].questions[o].answers[n].matchId=t[g]}a(function(){u.reDrawAllConnect()})}},u.activeQuestion=function(e){e<1||e>u.numberQuestion||(u.currentOrder=e,u.displayPagePagination(),n.search("order",e).hash("_").replace())},u.medalLevel=0,u.score="",u.examResult=null,u.finishExam=function(){if(u.examFinished&&null!=u.examResult&&u.displayFinishPage)return u.loadingExam=!1,void u.showFinishPage();var e=new c({examId:u.examId});u.showAnswerKey||(e.encryptKey=u.encryptKey,e.iv=u.iv),e.$finishExam(function(e){e.success&&(u.loadingExam=!1,u.examFinished=!0,u.calculateCountDown(0),u.stopCountDown(),u.countDownMode=3,u.checkHelps(),u.examResult=e.examResult,u.showAnswerKey=e.examResult.showAnswerKey,u.encryptKey=e.examResult.encryptKey,u.iv=e.examResult.iv,u.showAnswerKey&&u.decryptAnswerKey(),u.displayFinishPage&&u.showFinishPage())},function(e){u.prepareResultChart(u.examResult)})},u.showFinishPage=function(){u.currentOrder=u.finishOrder,u.finishPage=!0,u.prepareResultChart(u.examResult),t.scrollTo(0,0),n.search("order","HT").hash("_").replace()},u.decrypt=function(e,t,n){if(angular.isUndefined(e)||0==e.length)return"";var a=CryptoJS.enc.Base64.parse(t),i=CryptoJS.enc.Base64.parse(n),s=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(e)}),r=CryptoJS.AES.decrypt(s,a,{iv:i});return r.toString(CryptoJS.enc.Utf8)},u.decryptAnswerKey=function(){var e,t,n,a,i,s,r=u.sections.length;for(a=0;a<r;a++)for(e=u.sections[a].questions.length,i=0;i<e;i++)for(t=u.sections[a].questions[i].answers.length,s=0;s<t;s++)u.sections[a].questions[i].answers[s].encrypted&&(n=u.decrypt(u.sections[a].questions[i].answers[s].isRight,u.encryptKey,u.iv),u.sections[a].questions[i].answers[s].isRight=n>0,2==u.sections[a].questions[i].type&&(u.sections[a].questions[i].answers[s].description=u.decrypt(u.sections[a].questions[i].answers[s].description,u.encryptKey,u.iv)),3==u.sections[a].questions[i].type&&(u.sections[a].questions[i].answers[s].correctId=u.decrypt(u.sections[a].questions[i].answers[s].correctId,u.encryptKey,u.iv)),u.sections[a].questions[i].answers[s].encrypted=!1);for(r=u.loadedSections.length,a=0;a<r;a++)for(e=u.loadedSections[a].questions.length,i=0;i<e;i++)for(t=u.loadedSections[a].questions[i].answers.length,s=0;s<t;s++)u.loadedSections[a].questions[i].answers[s].encrypted&&(n=u.decrypt(u.loadedSections[a].questions[i].answers[s].isRight,u.encryptKey,u.iv),u.loadedSections[a].questions[i].answers[s].isRight=n>0,2==u.loadedSections[a].questions[i].type&&(u.loadedSections[a].questions[i].answers[s].description=u.decrypt(u.loadedSections[a].questions[i].answers[s].description,u.encryptKey,u.iv)),3==u.loadedSections[a].questions[i].type&&(u.loadedSections[a].questions[i].answers[s].correctId=u.decrypt(u.loadedSections[a].questions[i].answers[s].correctId,u.encryptKey,u.iv)),u.loadedSections[a].questions[i].answers[s].encrypted=!1)},u.correctChart=null,u.consumedTimeChart=null,u.scoreChart=null,u.initResultChart=function(){u.correctChart={labels:["Đúng","Sai"],colors:["#00E676","#DCDCDC"],data:[]},u.consumedTimeChart={labels:["Thời gian đã làm","Còn lại"],colors:["#00ADF9","#DCDCDC"],data:[]},u.scoreChart={labels:["Mức đạt","Mức chưa đạt"],colors:["#803690","#DCDCDC"],data:[]}},u.prepareResultChart=function(e){u.score=(1*e.score).toString(),u.correctChart.data=[e.numberCorrect,e.totalQuestion-e.numberCorrect],u.consumedTimeChart.data=[e.consumedTime,Math.max(0,e.totalTime-e.consumedTime)],u.scoreChart.data=[e.score,Math.max(0,e.totalScore-e.score)];var t=e.numberCorrect/e.totalQuestion,n=e.consumedTime/e.totalTime,a=e.score/e.totalScore;u.medalLevel=0,1==t&&1==a?u.medalLevel=5:t>=.8&&a>=.8?u.medalLevel=4:t>=.6&&a>=.6&&n<=.9?u.medalLevel=3:t>=.3&&a>=.3?u.medalLevel=2:t>0&&a>0&&(u.medalLevel=1)},u.goToQuestion=function(t,i){if(i==u.finishOrder||!(i<1||i>u.numberQuestion||i==u.currentOrder))if(i==u.finishOrder){if(u.finishPage)return;if(u.examFinished)u.loadingExam=!0,u.loadingOrder="HT",u.displayFinishPage=!0,u.finishExam();else{var o=s.open({animation:!0,templateUrl:"confirmFinishModal.html",controller:"confirmFinishCtrl",controllerAs:"confirmFinishVm",keyboard:!0,size:null});o.result.then(function(e){1==e&&(u.loadingExam=!0,u.loadingOrder="HT",u.displayFinishPage=!0,u.finishExam())})}}else{u.finishPage=!1;var c,l=!1,d=u.sections.length;for(c=0;c<d;c++)if(u.sections[c].id==t){l=!0;break}if(l)u.currentOrder==u.finishOrder?(u.currentOrder=i,u.loadingExam=!0,u.loadingOrder=i,a(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){n.search("order",u.currentOrder).hash("question-"+u.currentOrder).replace(),r.yOffset=135,r(),u.reDrawAllConnect(),u.loadingExam=!1,e.$digest()})})):(u.currentOrder=i,n.search("order",u.currentOrder).hash("question-"+u.currentOrder).replace(),r.yOffset=135,r());else{for(d=u.loadedSections.length,c=u.sections.length;c<d&&(u.sections.push(u.loadedSections[c]),u.loadedSections[c].id!=t);c++);u.loadingExam=!0,u.currentOrder=i,a(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){n.search("order",u.currentOrder).hash("question-"+u.currentOrder).replace(),r.yOffset=135,r(),u.reDrawAllConnect(),u.loadingExam=!1,e.$digest()})},0)}}},u.exit=function(){u.hidingMessage="Đang dừng đề thi...",u.hidingExam=!0,u.cancelAllRequests(),"edit"==u.backPage?t.location.href="/u/exam/"+u.examId+"/edit":t.location.href="/u/exam/"+u.examId+"/dashboard/show"},u.goToPageManager=function(){u.cancelAllRequests(),"edit"==u.backPage?t.location.href="/u/exam/"+u.examId+"/edit":t.location.href="/u/exam/"+u.examId+"/dashboard/show"},u.myCancelableRequests=[],u.cancelAllRequests=function(){for(var e=u.myCancelableRequests.length,t=0;t<e;t++)u.myCancelableRequests[t].$cancelRequest()},u.shortcutKey=function(){s.open({animation:!0,templateUrl:"shortcutKeyModal.html",controller:"shortcutKeyCtrl",controllerAs:"shortcutKeyVm",keyboard:!0,size:"lg"})},u.pressingCtrlAlt=!1,e.$on("keydown",function(t,n){if(e.$apply(function(){u.pressingCtrlAlt=n.ctrlKey&&n.altKey}),n.ctrlKey&&n.altKey){var a=-1,i=!1,s=0;switch(n.key){case"g":a=0,i=u.isHelpReduceSelection,s=u.reduceSelectionCost}a!=-1&&e.$apply(function(){u.doHelp(a,i,s)})}}),e.$on("keyup",function(t,n){e.$apply(function(){u.pressingCtrlAlt=!1})})}]),mainApp.controller("runQuestionCtrl",["$scope","$window","$location","$timeout","$animate","$uibModal","Fullscreen","RunService",function(e,t,n,a,i,s,r,o){var c=this;c.statusMessage="",c.updateTryTime=0,c.maxTryTime=60,c.updating=0,MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]),c.loadingQuestion=!0,c.finishPage=!1,c.init=function(e){c.countDownMode=1,c.userIsCreator=e.userIsCreator,c.backPage=e.backPage,c.examId=e.examId,c.coin=1*e.coin,c.timeWholeExam=e.timeWholeExam,c.timeWholeExam&&(c.remainTime=e.remainTime,c.startPoint=moment()),c.reduceSelectionCost=e.reduceSelectionCost,c.increaseTimeCost=e.increaseTimeCost,c.answerLaterCost=e.answerLaterCost,c.saveTimeCost=e.saveTimeCost,c.questionAgainCost=e.questionAgainCost,c.savedTime=e.savedTime,c.numberQuestion=e.numberQuestion,c.remainReduceSelection=e.remainReduceSelection,c.remainIncreaseTime=e.remainIncreaseTime,c.remainAnswerLater=e.remainAnswerLater,c.remainSaveTime=e.remainSaveTime,c.remainQuestionAgain=e.remainQuestionAgain;var t=e.order;c.loadedQuestionList[t]=e,c.questionOrder=e.order,c.loadQuestion(e);var n=angular.element(document.querySelector("#cq-run-init"));n.remove(),a(c.getQuestionsStatus),a(c.initResultChart)},c.loadQuestion=function(e){c.questionOrder==e.order&&(c.questionId=e.questionId,c.questionFinished=e.questionFinished,c.examFinished||(c.examFinished=e.examFinished),c.finishPage=!1,c.timeWholeExam||(c.remainTime=e.remainTime,c.startPoint=moment()),c.selectedRadio=null,c.selectedCheckbox={},c.essay="",c.matchedPairArray={},c.currentOrder=e.order,c.displayPagePagination(),c.showQuestion=!e.questionFinished||e.showQuestionAfterFinish,c.isGroupType=e.isGroupType,c.questionType=e.questionType,c.showAnswerKey=e.showAnswerKey,c.numberSelection=e.numberSelection,c.sectionDescription=e.sectionDescription,c.questionDescription=e.questionDescription,c.answers=e.answers,c.prepareAnswer(e.questionType,e.answers),c.loadingQuestion=!1,c.loadingIcon=!1,c.disabledReduceSelection=!1,c.checkHelps(),c.disabledQuestionAgain=!1,c.hidingMessage="",c.hidingQuestion=!1,c.timeWholeExam||c.calculateCountDown(0),c.stopCountDown(),c.questionFinished||(c.calculateCountDown(c.remainTime),c.myCountDown=a(c.runCountDown,1e3)),a(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){c.refreshAfterMathjax()})},0),t.scrollTo(0,0))},c.prepareAnswer=function(e,t){var n,a=t.length;switch(e){case 0:for(c.selectedRadio=null,n=0;n<a;n++)t[n].isSelected&&(c.selectedRadio=t[n].id);break;case 1:for(c.selectedCheckbox={},n=0;n<a;n++)c.selectedCheckbox[t[n].id]=t[n].isSelected;break;case 2:c.essay=t[0].essay;break;case 3:for(c.matchedPairArray={},n=0;n<a;n++)c.matchedPairArray[t[n].order]=t[n].matchId;c.resetSelectedMatch()}},c.loadedQuestionList={},c.preLoadQuestions=function(){if(null!=c.questionsStatus)for(var e,t,n=[1,2,-1,-2],a=0;a<4;a++)if(e=c.questionOrder+n[a],e>0&&e<=c.numberQuestion&&e!=c.questionOrder&&angular.isUndefined(c.loadedQuestionList[e])){var i=c.identifyPageItem(e);if(null==i)continue;t=c.questionsStatus[i].id;var s=o.preLoadQuestion({examId:c.examId,questionId:t},function(e){if(e.success){var t=e.questionData.order;angular.isUndefined(c.loadedQuestionList[t])&&(c.loadedQuestionList[t]=e.questionData)}},function(e){});c.myCancelableRequests.length>=500&&c.myCancelableRequests.shift(),c.myCancelableRequests.push(s)}},c.refreshAfterMathjax=function(){a(c.drawConnect)},c.decrypt=function(e,t,n){if(angular.isUndefined(e)||0==e.length)return"";var a=CryptoJS.enc.Base64.parse(t),i=CryptoJS.enc.Base64.parse(n),s=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(e)}),r=CryptoJS.AES.decrypt(s,a,{iv:i});return r.toString(CryptoJS.enc.Utf8)},c.decryptQuestion=function(e,t,n){if(!angular.isUndefined(c.loadedQuestionList[e])){c.loadedQuestionList[e].sectionDescription=c.decrypt(c.loadedQuestionList[e].sectionDescription,t,n),c.loadedQuestionList[e].questionDescription=c.decrypt(c.loadedQuestionList[e].questionDescription,t,n);for(var a=c.loadedQuestionList[e].answers.length,i=0;i<a;i++)c.loadedQuestionList[e].answers[i].description=c.decrypt(c.loadedQuestionList[e].answers[i].description,t,n),angular.isDefined(c.loadedQuestionList[e].answers[i].match)&&(c.loadedQuestionList[e].answers[i].match=c.decrypt(c.loadedQuestionList[e].answers[i].match,t,n))}},c.getNameFromNumber=function(e){var t=(e-1)%26,n=String.fromCharCode(65+t),a=Math.floor((e-1)/26);return a>0?c.getNameFromNumber(a)+n:n},c.disabledReduceSelection=!1,c.disabledQuestionAgain=!1,c.checkHelps=function(){c.disabledReduceSelection?c.isHelpReduceSelection=!1:c.isHelpReduceSelection=!c.questionFinished&&c.reduceSelectionCost>=0&&(c.userIsCreator||c.reduceSelectionCost<=c.coin)&&c.remainReduceSelection>0,c.timeWholeExam?(c.isHelpIncreaseTime=!1,c.isHelpAnswerLater=!1,c.isHelpSaveTime=!1,c.isHelpQuestionAgain=!1,c.isHelpTime=!1):(c.isHelpIncreaseTime=!c.questionFinished&&c.increaseTimeCost>=0&&(c.userIsCreator||c.increaseTimeCost<=c.coin)&&c.remainIncreaseTime>0,c.isHelpAnswerLater=!c.questionFinished&&c.answerLaterCost>=0&&(c.userIsCreator||c.answerLaterCost<=c.coin)&&c.remainAnswerLater>0,c.isHelpSaveTime=!c.questionFinished&&c.saveTimeCost>=0&&(c.userIsCreator||c.saveTimeCost<=c.coin)&&c.remainSaveTime>0,c.isHelpQuestionAgain=!c.disabledQuestionAgain&&!c.examFinished&&c.questionFinished&&c.questionAgainCost>=0&&(c.userIsCreator||c.questionAgainCost<=c.coin)&&c.remainQuestionAgain>0,c.isHelpTime=!c.questionFinished&&c.savedTime>0)},c.disableHelps=function(){c.isHelpReduceSelection=!1,c.isHelpIncreaseTime=!1,c.isHelpAnswerLater=!1,c.isHelpSaveTime=!1,c.isHelpQuestionAgain=!1,c.isHelpTime=!1},c.questionsStatus=null,c.getQuestionsStatus=function(){o.getQuestionsStatus({examId:c.examId},function(e){e.success&&(c.questionsStatus=e.questionsStatus,c.displayPagePagination(),c.preLoadQuestions())},function(e){})},c.pages={},c.currentOrder=1,c.pages.previous=!1,c.pages.next=!1,c.pages.viewFrame=[],c.displayPagePagination=function(){if(null!=c.questionsStatus){c.identifyNumberItemPerPage();var e=c.identifyPageItem(c.currentOrder),t=c.numberItemPerPage/2,n=e>t?e-t:0,a=Math.min(n+c.numberItemPerPage,c.questionsStatus.length),i=Math.max(a-c.numberItemPerPage,0);c.pages.viewFrame=[];for(var s=i;s<a;s++)if(angular.isDefined(c.questionsStatus[s])){var r={};r.order=c.questionsStatus[s].order,r.id=c.questionsStatus[s].id,r.done=c.questionsStatus[s].done,c.pages.viewFrame.push(r)}c.addFinishPageToFrame(a),c.pages.previous=i>0,c.pages.next=a<c.questionsStatus.length}},c.finishOrder="Hoàn thành",c.addFinishPageToFrame=function(e){if(e==c.questionsStatus.length){var t={};t.order=c.finishOrder,t.id=null,t.done=!1,c.pages.viewFrame.push(t)}},c.viewPreviousFrame=function(){var e=c.identifyPageItem(c.pages.viewFrame[0].order);if(0!=e){var t=Math.max(e-c.numberItemPerPage,0),n=Math.min(t+c.numberItemPerPage,c.questionsStatus.length);c.pages.viewFrame=[];for(var a=t;a<n;a++)if(angular.isDefined(c.questionsStatus[a])){var i={};i.order=c.questionsStatus[a].order,i.id=c.questionsStatus[a].id,i.done=c.questionsStatus[a].done,c.pages.viewFrame.push(i)}c.addFinishPageToFrame(n),c.pages.previous=t>0,c.pages.next=n<c.questionsStatus.length}},c.viewNextFrame=function(){var e=c.pages.viewFrame[c.pages.viewFrame.length-1].order;if(e!=c.finishOrder){var t=c.identifyPageItem(e),n=Math.min(t+c.numberItemPerPage,c.questionsStatus.length),a=Math.max(n-c.numberItemPerPage,0);c.pages.viewFrame=[];for(var i=a;i<n;i++){if(angular.isDefined(c.questionsStatus[i])){var s={};s.order=c.questionsStatus[i].order,s.id=c.questionsStatus[i].id,s.done=c.questionsStatus[i].done}c.pages.viewFrame.push(s)}c.addFinishPageToFrame(n),c.pages.next=n<c.questionsStatus.length,c.pages.previous=a>0}},c.numberItemPerPage=0,c.identifyNumberItemPerPage=function(){var e=c.myWindow.width();e>1150?c.numberItemPerPage=22:e<=1150&&e>880?c.numberItemPerPage=16:e<=880&&e>526?c.numberItemPerPage=8:e<=526&&e>350?c.numberItemPerPage=4:c.numberItemPerPage=2},c.identifyPageItem=function(e){if(null==c.questionsStatus)return null;for(var t=c.questionsStatus.length,n=0;n<t;n++)if(c.questionsStatus[n].order==e)return n},c.selectRadio=function(e){c.questionFinished||c.selectedRadio==e||(c.selectedRadio=e,c.updateRadio())},c.updateRadio=function(){if(!c.questionFinished&&null!=c.selectedRadio){for(var e=c.answers.length,t=0;t<e;t++)c.answers[t].isSelected=c.answers[t].id==c.selectedRadio;var n=new o({examId:c.examId,questionId:c.questionId});n.selectedId=c.selectedRadio,c.updating++,n.$updateAnswers(function(e){c.updating--,c.updateTryTime=0},function(e){c.updating--,c.statusMessage="Chưa cập nhật câu trả lời được. Đang gửi lại...",c.updateTryTime<c.maxTryTime&&(c.updateTryTime++,a(c.updateRadio,5e3))})}},c.selectCheckbox=function(e){c.questionFinished||(c.selectedCheckbox[e]=!c.selectedCheckbox[e],c.updateCheckbox())},c.updateCheckbox=function(){if(!c.questionFinished){for(var e,t=c.answers.length,n=0;n<t;n++)e=c.answers[n].id,c.answers[n].isSelected=c.selectedCheckbox[e];var i=new o({examId:c.examId,questionId:c.questionId});i.checkedStatusArray=c.selectedCheckbox,c.updating++,i.$updateAnswers(function(e){c.updating--,c.updateTryTime=0},function(e){c.updating--,c.statusMessage="Chưa cập nhật câu trả lời được. Đang gửi lại...",c.updateTryTime<c.maxTryTime&&(c.updateTryTime++,a(c.updateCheckbox,5e3))})}},c.calculateCountDown=function(e){c.currentSecond=e%60,c.currentMinute=Math.floor(e/60)%60,c.currentHour=Math.floor(e/3600),c.currentHour<100?c.digitalTimer=("0"+c.currentHour).slice(-2)+":"+("0"+c.currentMinute).slice(-2)+":"+("0"+c.currentSecond).slice(-2):c.digitalTimer="> 99:"+("0"+c.currentMinute).slice(-2)+":"+("0"+c.currentSecond).slice(-2),c.currentHour=c.currentHour>24?24:c.currentHour},c.myCountDown=null,c.localRemainTime=0,c.runCountDown=function(){var e=moment(),t=e.diff(c.startPoint,"seconds");c.localRemainTime=c.remainTime-t,c.localRemainTime>0?(0!=c.countDownMode&&c.calculateCountDown(c.localRemainTime),c.myCountDown=a(c.runCountDown,1e3)):(c.localRemainTime=0,c.calculateCountDown(c.localRemainTime),c.closeQuestion(),c.checkHelps(),c.timeWholeExam&&(c.examFinished=!0))},c.stopCountDown=function(){a.cancel(c.myCountDown)},c.changeCountDownMode=function(){switch(c.countDownMode){case 0:c.countDownMode=1;break;case 1:c.countDownMode=2;break;case 2:c.countDownMode=3;break;default:c.countDownMode=0}},c.closeQuestion=function(){if(!c.questionFinished){c.timeWholeExam||c.calculateCountDown(0),c.stopCountDown();var e=c.questionOrder,t=c.questionId;if(3==c.questionType&&a(c.drawConnect),c.questionFinished=!0,c.updating>0)a(function(){c.closeQuestionService(e,t)},1e3);else if(2==c.questionType&&c.questionEditing){var n=angular.element(document.querySelector("#essay-pseudo"));n.focus(),a(function(){c.closeQuestionService(e,t)},1e3)}else c.closeQuestionService(e,t)}},c.closeQuestionService=function(e,t){if(!angular.isUndefined(c.loadedQuestionList[e])){if(c.timeWholeExam||(c.loadedQuestionList[e].questionFinished=!0),null!=c.questionsStatus){var i=c.identifyPageItem(e);c.questionsStatus[i].done=!0;for(var s=c.pages.viewFrame.length,r=0;r<s;r++)if(c.pages.viewFrame[r].id==t){c.pages.viewFrame[r].done=!0;break}}var u=new o({examId:c.examId,questionId:t});u.order=e,u.$closeQuestion(function(e){if(e.success){var t=e.order;if(c.loadedQuestionList[t].showAnswerKey=e.data.showAnswerKey,e.data.showAnswerKey&&angular.isDefined(e.data.answers)){var i,s;switch(s=e.data.answers.length,c.loadedQuestionList[t].questionType){case 0:case 1:for(i=0;i<s;i++){var r=e.data.answers[i],o=r.order;o==c.loadedQuestionList[t].answers[i].order&&(c.loadedQuestionList[t].answers[i].isRight=r.isRight)}break;case 2:c.loadedQuestionList[t].answers[0].isRight=e.data.answers[0].isRight,c.loadedQuestionList[t].answers[0].description=e.data.answers[0].description;break;case 3:for(i=0;i<s;i++)c.loadedQuestionList[t].answers[i].order==e.data.answers[i].order&&(c.loadedQuestionList[t].answers[i].isRight=e.data.answers[i].isRight,c.loadedQuestionList[t].answers[i].correctId=e.data.answers[i].correctId);a(c.drawConnect)}}if("HT"==c.loadingOrder){var u=n.path();u=u.substr(0,u.lastIndexOf("/")+1)+"finish";var l={confirmed:1};"edit"==c.backPage&&(l.trying=1),n.path(u).search(l)}}},function(e){})}},c.isFullScreen=!1,c.goFullScreen=function(){r.isEnabled()?(r.cancel(),c.isFullScreen=!1):(r.all(),c.isFullScreen=!0)},c.myWindow=angular.element(t),c.myWindow.on("resize",function(){c.displayPagePagination(),a(c.drawConnect),e.$digest()});var u="fontselect | fontsizeselect | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist indent outdent | image media | code | mathtype";c.questionEditing=!1,c.editorSettings={language_url:"/js/tinymce-v451/langs/vi.js",external_plugins:{advlist:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/advlist/plugin.min.js",link:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/link/plugin.min.js",image:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/image/plugin.min.js",imagetools:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/imagetools/plugin.min.js",lists:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/lists/plugin.min.js",charmap:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/charmap/plugin.min.js",hr:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/hr/plugin.min.js",searchreplace:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/searchreplace/plugin.min.js",media:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/media/plugin.min.js",table:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/table/plugin.min.js",contextmenu:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/contextmenu/plugin.min.js",paste:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/paste/plugin.min.js",textcolor:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/textcolor/plugin.min.js",colorpicker:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/colorpicker/plugin.min.js",code:"https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.5.1/plugins/code/plugin.min.js"},themes:"inlite",inline:!0,trusted:!0,theme:"modern",language:"vi",plugins:["advlist link image imagetools lists charmap hr","searchreplace media","table contextmenu paste textcolor colorpicker code"],contextmenu:"cut copy paste | link image inserttable | cell row column deletetable",menu:{edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall | searchreplace"},insert:{title:"Insert",items:"image media link | charmap hr template | mathtype"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"},tools:{title:"Tools",items:"code"},help:{title:"Help",items:"editorhelp mathtypehelp"}},menubar:"edit insert format table tools help",toolbar:u,table_default_styles:{width:"100%"},statusbar:!1,fontsize_formats:"8pt 10pt 12pt 14pt 16pt 18pt 20pt 22pt 24pt 26pt 28pt 32pt 36pt 48pt 72pt",custom_undo_redo_levels:10,image_advtab:!0,relative_urls:!1,remove_script_host:!1,convert_urls:!0,content_css:["/css/bootstrap.min.css?"+(new Date).getTime()],entity_encoding:"raw",extended_valid_elements:"*[*]",setup:function(e){function t(){e.windowManager.open({title:"Công thức",url:"/u/mathtype",width:700,height:600},{oninsert:function(t,n){var a;a=n?'<div class="math">$$'+t+"$$</div><p></p>":"&nbsp;\\("+t+"\\)&#8204;&nbsp;",e.insertContent(a,null),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id])}})}e.addMenuItem("editorhelp",{text:"Editor guide",context:"help",onclick:function(){e.windowManager.open({title:"Hướng dẫn soạn thảo",url:"/guide/editor",width:700,height:570})}}),e.addMenuItem("mathtypehelp",{text:"Mathtype guide",context:"help",onclick:function(){e.windowManager.open({title:"Hướng dẫn gõ công thức",url:"/guide/mathtype",width:800,height:570})}}),e.addMenuItem("mathtype",{text:"Công thức",context:"insert",icon:"sigma",onclick:function(){t()}}),e.addButton("mathtype",{text:"Công thức",tooltip:"Gõ công thức toán, hóa học",icon:!1,onclick:function(){t()}}),e.on("init",function(){c.essayEditor=e,e.selectedMathId=null,e.selectedMathDisplay=!1,e.moveNext=!0,e.pressSpace=!1,e.beginInlineMath=!1,e.endInlineMath=!1,e.runMathJax=!1,$("#"+e.id).find(".scriptMath").each(function(){var e=$(this).html();$(this).before(e)}),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id,function(){2==c.questionType&&angular.element("#"+e.id).focus()}])}),e.on("change",function(){e.endInlineMath?(e.endInlineMath=!1,e.runMathJax=!0,e.execCommand("mceInsertContent",!1,"&zwnj;")):e.runMathJax&&(e.runMathJax=!1,MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id]))}),e.on("click",function(t){c.questionEditing=!0;var n=$(t.target),a=n.closest(".MathJax_SVG");if(a.length>0)if(null!=e.selectedMathId&&a.attr("id")!=e.selectedMathId){var i=$(".editMath");if(i.length>0){var s=i.html();if(e.selectedMathDisplay){var r=i.closest(".MathJax_SVG_Display");r.replaceWith("$$"+s+"$$")}else i.replaceWith("\\("+s+"\\)");MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id],function(){e.selectedMathId=a.attr("id");var t,i,s=n.closest(".MathJax_SVG_Display");t=s.length>0?s.next("script"):a.next("script"),i=t.html(),e.selectedMathDisplay=t.attr("type").indexOf("mode=display")>-1,t.remove(),a.after('<span class="editMath" id="editMath_'+e.selectedMathId+'" style="border: 1px solid red; padding: 2px 2px;">'+i+"</span>"),a.remove()})}}else{e.selectedMathId=a.attr("id");var o,u,l=n.closest(".MathJax_SVG_Display");o=l.length>0?l.next("script"):a.next("script"),u=o.html(),e.selectedMathDisplay=o.attr("type").indexOf("mode=display")>-1,o.remove(),a.after('<span class="editMath" id="editMath_'+e.selectedMathId+'" style="border: 1px solid red; padding: 2px 2px;">'+u+"</span>"),a.remove()}}),e.on("blur",function(){c.questionEditing=!1}),e.on("NodeChange",function(t){var n=$(t.element),a=n.closest(".MathJax_SVG_Display");if(0==a.length&&(a=n.closest(".MathJax_SVG")),a.length>0){var i=a.find("img");i.length>0&&(i.remove(),a.before(i),a.before("&zwnj;"))}var s=n.closest(".editMath");if(0==s.length&&null!=e.selectedMathId){var r=$(".editMath");if(r.length>0){e.selectedMathId=null;var o=r.html();if(e.selectedMathDisplay){var c=r.closest(".MathJax_SVG_Display");c.replaceWith("$$"+o+"$$")}else r.replaceWith("\\("+o+"\\)");MathJax.Hub.Queue(["Typeset",MathJax.Hub,e.id])}}if(a.length>0&&0==s.length){var u,l=rangy.getSelection();u=rangy.createRange();var d;if(1==e.moveNext){if(d=a[0].nextSibling.nextSibling,null==d&&(d=a[0].parentNode.nextSibling.firstChild),d.nodeType!=Node.TEXT_NODE)for(var m=d.childNodes,g=0;g<m.length;g++){var h=m[g];if(3==h.nodeType){d=h;break}}var p=0;d.nodeType==Node.TEXT_NODE&&8204===d.wholeText.charCodeAt(0)&&(p=1),u.setStart(d,p),u.setEnd(d,p)}else{if(d=a[0].previousSibling,null==d&&(d=a[0].parentNode.previousSibling.lastChild),d.nodeType!=Node.TEXT_NODE)for(var f=d.childNodes,x=f.length;x--;){var v=f[x];if(3==v.nodeType){d=v;break}}u.setStart(d,d.length),u.setEnd(d,d.length)}l.removeAllRanges(),l.addRange(u)}}),e.on("KeyDown",function(t){if("Tab"!=t.key&&c.questionFinished)return void t.preventDefault();e.moveNext="ArrowRight"==t.key||"Right"==t.key,e.endInlineMath=")"==t.key,e.runMathJax="]"==t.key||"$"==t.key;var n=["Backspace","Enter","Shift","Control","Alt","CapsLock","PageUp","PageDown","End","Home","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Delete","Left","Up","Right","Down","Del"];if(n.indexOf(t.key)==-1){var a=e.getContent().length;if(c.checkLengthOverLimit(a))return e.stopPropagation(),e.preventDefault(),!1}return"\\"!=t.key||e.pressSpace?void(e.pressSpace=" "==t.key||"\\"==t.key):(e.execCommand("mceInsertContent",!1," \\"),e.preventDefault(),e.stopPropagation(),e.pressSpace=!0,!1)})}},c.checkLengthOverLimit=function(e){var t=2e4;return e>t?(c.statusMessage="Chiều dài vượt giới hạn!",!0):(c.statusMessage="",!1)},c.updateEssay=function(){if(!c.questionFinished){var e=$("<div />").append(c.essay);e.find("script").replaceWith(function(){var e=$(this).html().replace("// <![CDATA[","").replace("// ]]>","").trim(),t=$(this).attr("type");return e="undefined"!=typeof t&&"math/tex; mode=display"==t?"$$"+e+"$$":"\\("+e+"\\)&amp; zwnj;"}),e.find(".MathJax_SVG_Display, .MathJax_SVG, .editMath").remove();var t=e.html();if(t=t.replace(/&amp; zwnj;/g,"&zwnj;"),t=t.replace(/[\n\t]+/g,""),!c.checkLengthOverLimit(t)){c.answers[0].essay=t;var n=new o({examId:c.examId,questionId:c.questionId});n.essay=t,c.updating++,n.$updateAnswers(function(e){c.updating--,c.updateTryTime=0},function(e){c.updating--,c.statusMessage="Chưa cập nhật câu trả lời được. Đang gửi lại...",c.updateTryTime<c.maxTryTime&&(c.updateTryTime++,a(c.updateEssay,5e3))})}}},c.resetSelectedMatch=function(){c.selectedAnswer=-1,c.selectedMatch=-1},c.selectAnswer=function(e,t){c.questionFinished||(c.selectedAnswer=e,null!=t&&t.stopPropagation(),c.processedMatchedPair?(c.selectedMatch=-1,c.processedMatchedPair=!1):c.paringMatch())},c.selectMatch=function(e,t){c.questionFinished||(c.selectedMatch=e,null!=t&&t.stopPropagation(),c.processedMatchedPair?(c.selectedAnswer=-1,c.processedMatchedPair=!1):c.paringMatch())},c.processedMatchedPair=!1,c.paringMatch=function(){if(c.selectedAnswer!=-1&&c.selectedMatch!=-1){for(var e in c.matchedPairArray)c.matchedPairArray.hasOwnProperty(e)&&c.matchedPairArray[e]==c.selectedMatch&&(c.matchedPairArray[e]=0);c.matchedPairArray[c.selectedAnswer]=c.selectedMatch,c.answers[c.selectedAnswer-1].matchId=c.selectedMatch,c.processedMatchedPair=!0,a(c.drawConnect);var t=new o({examId:c.examId,questionId:c.questionId});t.matchedPairArray=c.matchedPairArray,c.updating++,t.$updateAnswers(function(e){c.updating--,c.updateTryTime=0},function(e){c.updating--,c.statusMessage="Chưa cập nhật câu trả lời được. Đang gửi lại...",c.updateTryTime<c.maxTryTime&&(c.updateTryTime++,a(c.paringMatch,5e3))})}},c.drawConnect=function(){if(!c.finishPage&&3==c.questionType){var e,t,n,a,i,s,r,o,u,l;for(var d in c.matchedPairArray)c.matchedPairArray.hasOwnProperty(d)&&(e=c.matchedPairArray[d],t=angular.element(document.querySelector("#answer-"+d)),
a=angular.element(document.querySelector("#line1-"+d)),i=angular.element(document.querySelector("#line2-"+d)),s=angular.element(document.querySelector("#line3-"+d)),0!=e?(n=angular.element(document.querySelector("#match-"+e)),r=t.position().left+t.outerWidth(),o=t.position().top+t.outerHeight()/2,u=n.position().left,l=n.position().top+n.outerHeight()/2,a.attr("x1",r),a.attr("y1",o),a.attr("x2",r+10),a.attr("y2",o),i.attr("x1",r+10),i.attr("y1",o),i.attr("x2",u-10),i.attr("y2",l),s.attr("x1",u-10),s.attr("y1",l),s.attr("x2",u),s.attr("y2",l)):(a.attr("x1",0),a.attr("y1",0),a.attr("x2",0),a.attr("y2",0),i.attr("x1",0),i.attr("y1",0),i.attr("x2",0),i.attr("y2",0),s.attr("x1",0),s.attr("y1",0),s.attr("x2",0),s.attr("y2",0)));if(c.showAnswerKey)for(var m=c.answers.length,g=0;g<m;g++){var h=c.answers[g];h.isRight||(t=angular.element(document.querySelector("#answer-"+h.order)),n=angular.element(document.querySelector("#match-"+h.correctId)),a=angular.element(document.querySelector("#line1c-"+h.order)),i=angular.element(document.querySelector("#line2c-"+h.order)),s=angular.element(document.querySelector("#line3c-"+h.order)),r=t.position().left+t.outerWidth(),o=t.position().top+t.outerHeight()/2+5,u=n.position().left,l=n.position().top+n.outerHeight()/2+5,a.attr("x1",r),a.attr("y1",o),a.attr("x2",r+10),a.attr("y2",o),i.attr("x1",r+10),i.attr("y1",o),i.attr("x2",u-10),i.attr("y2",l),s.attr("x1",u-10),s.attr("y1",l),s.attr("x2",u),s.attr("y2",l))}}},c.doingHelp=!1,c.hidingQuestion=!1,c.helpingType=-1,c.doHelp=function(e,t,n){if(!c.loadingQuestion&&!c.closing){if(c.doingHelp)return void(c.statusMessage="Đang xử lý hỗ trợ, vui lòng đợi...");if(t){if(c.localRemainTime<=5&&(0==e||2==e||3==e))return c.statusMessage="Thời gian còn lại quá ít để thực hiện hỗ trợ này",void a(function(){c.statusMessage=""},5e3);c.doingHelp=!0,c.helpingType=e,c.statusMessage="Đang xử lý hỗ trợ...";var i=o.helpQuestion({examId:c.examId,questionId:c.questionId,type:e},function(t){if(c.statusMessage="",t.success){if(angular.isDefined(t.coin)&&(c.coin=1*t.coin),c.questionId!=t.questionId)return;switch(e){case 0:c.disabledReduceSelection=!0,c.remainReduceSelection=t.remainReduceSelection,c.helpReduceSelection(t.reducedAnswers);break;case 1:c.remainTime=t.remainTime,c.startPoint=moment(),c.loadedQuestionList[c.questionOrder].questionFinished=!1,c.questionFinished=!1,c.stopCountDown(),c.calculateCountDown(c.remainTime),c.myCountDown=a(c.runCountDown,1e3),c.remainIncreaseTime=t.remainIncreaseTime;break;case 2:c.questionFinished=!0,c.calculateCountDown(0),c.stopCountDown(),c.disabledQuestionAgain=!0,c.hidingMessage="Đã tạm hoãn câu hỏi hiện tại. Hãy chọn câu hỏi khác để thực hiện tiếp!",c.hidingQuestion=!0,c.hideQuestionContent(),delete c.loadedQuestionList[c.questionOrder],c.remainAnswerLater=t.remainAnswerLater;break;case 3:if(c.questionFinished=!0,c.loadedQuestionList[c.questionOrder].questionFinished=!0,null!=c.questionsStatus){var n=c.identifyPageItem(c.questionOrder);c.questionsStatus[n].done=!0;for(var i=c.pages.viewFrame.length,s=0;s<i;s++)if(c.pages.viewFrame[s].id==c.questionId){c.pages.viewFrame[s].done=!0;break}}c.savedTime=t.savedTime,c.calculateCountDown(0),c.stopCountDown(),c.questionAgainCost>=0&&c.questionAgainCost<=t.coin?c.hidingMessage="Đã tích lũy thời gian. Hãy chọn câu hỏi khác để thực hiện tiếp hoặc sử dụng quyền hỗ trợ trả lời lại!":c.hidingMessage="Đã tích lũy thời gian. Hãy chọn câu hỏi khác để thực hiện tiếp!",c.hidingQuestion=!0,c.hideQuestionContent(),c.remainSaveTime=t.remainSaveTime;break;case 4:c.remainTime=t.remainTime,c.startPoint=moment(),c.loadedQuestionList[c.questionOrder].questionFinished=!1,c.savedTime=t.savedTime,c.questionFinished=!1,c.stopCountDown(),c.calculateCountDown(c.remainTime),c.myCountDown=a(c.runCountDown,1e3);break;case 5:c.remainTime=t.remainTime,c.startPoint=moment(),c.loadedQuestionList[c.questionOrder].questionBeginTime=t.questionBeginTime,c.loadedQuestionList[c.questionOrder].bonusTime=t.bonusTime,c.loadedQuestionList[c.questionOrder].questionFinished=!1,c.questionFinished=!1,c.runQuestionAgain(),c.remainQuestionAgain=t.remainQuestionAgain}c.checkHelps()}else c.statusMessage=t.message,a(function(){c.statusMessage=""},5e3);c.doingHelp=!1,c.helpingType=-1},function(e){c.doingHelp=!1,c.helpingType=-1,c.statusMessage=""});c.myCancelableRequests.length>=500&&c.myCancelableRequests.shift(),c.myCancelableRequests.push(i)}else n>=0&&c.coin<=n&&c.localRemainTime>0&&4!=e&&(c.statusMessage="Không đủ xu để thực hiện",a(function(){c.statusMessage=""},5e3))}},c.helpReduceSelection=function(e){switch(c.questionType){case 0:case 1:if(0==e.length)return;for(var t=c.answers.length,n=t-1;n>=0;n--){var i=c.answers[n];e.indexOf(i.id)!==-1&&c.answers.splice(n,1)}if(0==c.questionType)c.selectedRadio=-1;else for(var s in c.selectedCheckbox)c.selectedCheckbox.hasOwnProperty(s)&&(c.selectedCheckbox[s]=!1);break;case 2:break;case 3:var r;for(var o in e)e.hasOwnProperty(o)&&(r=e[o],c.answers[o-1].matchId=r);c.matchedPairArray=e,a(function(){c.drawConnect()})}},c.hideQuestionContent=function(){c.hidedSectionDescription=c.sectionDescription,c.hidedQuestionDescription=c.questionDescription,c.hidedAnswers=c.answers,c.sectionDescription="",c.questionDescription="",c.answers=[]},c.runQuestionAgain=function(){c.hidingQuestion&&(c.sectionDescription=c.hidedSectionDescription,c.questionDescription=c.hidedQuestionDescription,c.answers=c.hidedAnswers,a(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub],function(){c.refreshAfterMathjax()})},0)),t.scrollTo(0,0),c.showQuestion=!0,c.hidingQuestion=!1,c.loadingQuestion=!1,c.showAnswerKey=!1,c.stopCountDown(),c.myCountDown=a(c.runCountDown,1e3)},e.$on("$locationChangeSuccess",function(e,t,a){if(t!=a){var i=n.search();if(angular.isDefined(i.order)){var s=i.order;c.changeQuestion(s)}else angular.isDefined(i.confirmed)&&1==i.confirmed&&c.finishExam()}}),c.changeQuestion=function(e){if(!(e<1||e>c.numberQuestion||null==c.questionsStatus))if(c.questionOrder=e,angular.isUndefined(c.loadedQuestionList[e])){var t=c.identifyPageItem(e),n=c.questionsStatus[t].id,i=o.loadQuestion({examId:c.examId,questionId:n},function(e){if(e.success){var t=e.questionData.order;c.loadedQuestionList[t]=e.questionData,c.loadQuestion(e.questionData),a(c.preLoadQuestions)}},function(e){});c.myCancelableRequests.length>=500&&c.myCancelableRequests.shift(),c.myCancelableRequests.push(i)}else{var s=c.loadedQuestionList[e];switch(s.status){case 0:c.loadQuestion(s),a(c.preLoadQuestions);break;case 1:var r=new o({examId:c.examId,questionId:s.id});r.encryptKey1=s.encryptKey1,r.iv=s.iv,r.$decryptQuestion(function(t){t.success&&(c.loadedQuestionList[e].status=0,c.loadedQuestionList[e].examFinished=t.data.examFinished,c.loadedQuestionList[e].questionFinished=t.data.questionFinished,c.loadedQuestionList[e].remainTime=t.data.remainTime,c.decryptQuestion(e,t.data.encryptKey,t.data.iv),c.loadQuestion(c.loadedQuestionList[e]),a(c.preLoadQuestions))},function(e){})}}},c.medalLevel=0,c.score="",c.examResult=null,c.finishExam=function(){if(c.questionOrder=c.numberQuestion+1,c.currentOrder=c.finishOrder,c.hidingQuestion=!1,c.examFinished&&null!=c.examResult)return c.loadingQuestion=!1,c.loadingIcon=!1,void(c.finishPage=!0);c.loadingQuestion=!0;var e=new o({examId:c.examId});e.$finishExam(function(e){e.success&&(c.hidingQuestion=!1,c.loadingQuestion=!1,c.loadingIcon=!1,c.finishPage=!0,c.questionFinished=!0,c.examFinished=!0,c.calculateCountDown(0),c.stopCountDown(),c.countDownMode=3,c.checkHelps(),t.scrollTo(0,0),c.examResult=e.examResult,c.prepareResultChart(e.examResult))},function(e){})},c.correctChart=null,c.consumedTimeChart=null,c.scoreChart=null,c.initResultChart=function(){c.correctChart={labels:["Đúng","Sai"],colors:["#00E676","#DCDCDC"],data:[]},c.consumedTimeChart={labels:["Thời gian sử dụng","Còn lại"],colors:["#00ADF9","#DCDCDC"],data:[]},c.scoreChart={labels:["Mức đạt","Mức chưa đạt"],colors:["#803690","#DCDCDC"],data:[]}},c.socialshare_description="",c.socialshare_quote="",c.socialshare_caption=(new Date).toJSON().slice(0,10),c.socialshare_media="",c.prepareResultChart=function(e){c.score=(1*e.score).toString(),c.correctChart.data=[e.numberCorrect,e.totalQuestion-e.numberCorrect],c.consumedTimeChart.data=[e.consumedTime,Math.max(0,e.totalTime-e.consumedTime)],c.scoreChart.data=[e.score,Math.max(0,e.totalScore-e.score)];var t=e.numberCorrect/e.totalQuestion,n=e.consumedTime/e.totalTime,a=e.score/e.totalScore;c.medalLevel=0,c.medalText="",c.medalImg="medal0.jpg",1==t&&1==a?(c.medalLevel=5,c.medalText="HC vàng",c.medalImg="medal5.jpg"):t>=.8&&a>=.8?(c.medalLevel=4,c.medalText="HC bạc",c.medalImg="medal4.jpg"):t>=.6&&a>=.6&&n<=.9?(c.medalLevel=3,c.medalText="HC đồng",c.medalImg="medal3.jpg"):t>=.3&&a>=.3?(c.medalLevel=2,c.medalText="HC sắt",c.medalImg="medal2.jpg"):t>0&&a>0&&(c.medalLevel=1,c.medalText="HC nhựa",c.medalImg="medal1.jpg"),c.socialshare_media="https://toithi.com/images/medal/"+c.medalImg,c.socialshare_quote="Link đề: https://toithi.com/exam/"+c.examId+"/information",c.socialshare_description="Chúc mừng bạn đã hoàn thành bài thi với "+c.medalText+". Điểm đạt được: "+c.score+". Số câu đúng: "+e.numberCorrect+". Thời gian thực hiện: "+Math.round(e.consumedTime/60)+" phút. "},c.loadingIcon=!1,c.displayLoadingIcon=function(){c.loadingIcon=!0,e.$digest()},c.goToQuestion=function(e){if(e==c.finishOrder||!(e<1||e>c.numberQuestion||e==c.currentOrder)){if(null==c.questionsStatus)return c.statusMessage="Đang chuẩn bị câu hỏi mới",void a(function(){c.statusMessage=""},3e3);c.statusMessage="";var t,i;if(e==c.finishOrder){if(c.finishPage)return;if(c.examFinished)c.loadingQuestion=!0,c.loadingOrder="HT",t=n.path(),t=t.substr(0,t.lastIndexOf("/")+1)+"finish",i={confirmed:1},"edit"==c.backPage&&(i.trying=1),n.path(t).search(i);else{var r=s.open({animation:!0,templateUrl:"confirmFinishModal.html",controller:"confirmFinishCtrl",controllerAs:"confirmFinishVm",keyboard:!0,size:null});r.result.then(function(e){if(1==e)if(c.loadingQuestion=!0,c.loadingOrder="HT",c.questionFinished){var t=n.path();t=t.substr(0,t.lastIndexOf("/")+1)+"finish";var a={confirmed:1};"edit"==c.backPage&&(a.trying=1),n.path(t).search(a)}else c.closeQuestion()})}}else{c.loadingQuestion=!0,c.loadingOrder=e,c.closeQuestion();var o=c.identifyPageItem(e);if(angular.isUndefined(c.questionsStatus[o]))return;var u=c.questionsStatus[o].id;if(null==u)return;t=n.path(),t=t.substr(0,t.lastIndexOf("/")+1)+u,i={order:e},"edit"==c.backPage&&(i.trying=1),n.path(t).search(i)}}},c.goNext=function(){c.questionOrder<c.numberQuestion?c.goToQuestion(c.questionOrder+1):c.goToQuestion(c.finishOrder)},c.goPrevious=function(){c.questionOrder>1&&c.goToQuestion(c.questionOrder-1)},c.exit=function(){c.hidingMessage="Đang dừng đề thi...",c.hidingQuestion=!0,c.closeQuestion(),c.questionFinished=!0,c.closing=!0,a(function(){c.cancelAllRequests(),"edit"==c.backPage?t.location.href="/u/exam/"+c.examId+"/edit":t.location.href="/u/exam/"+c.examId+"/dashboard/show"},1e3)},c.goToPageManager=function(){c.cancelAllRequests(),"edit"==c.backPage?t.location.href="/u/exam/"+c.examId+"/edit":t.location.href="/u/exam/"+c.examId+"/dashboard/show"},c.myCancelableRequests=[],c.cancelAllRequests=function(){for(var e=c.myCancelableRequests.length,t=0;t<e;t++)c.myCancelableRequests[t].$cancelRequest()},c.shortcutKey=function(){s.open({animation:!0,templateUrl:"shortcutKeyModal.html",controller:"shortcutKeyCtrl",controllerAs:"shortcutKeyVm",keyboard:!0,size:"lg"})},c.pressingCtrlAlt=!1,e.$on("keydown",function(t,n){if(e.$apply(function(){c.pressingCtrlAlt=n.ctrlKey&&n.altKey}),c.questionFinished&&!c.examFinished&&n.ctrlKey&&n.altKey&&"l"==n.key)return void e.$apply(function(){c.doHelp(5,c.isHelpQuestionAgain,c.questionAgainCost)});if(("ArrowRight"==n.key||"Right"==n.key)&&n.ctrlKey&&n.altKey)return void e.$apply(function(){c.goNext()});if(("ArrowLeft"==n.key||"Left"==n.key)&&n.ctrlKey&&n.altKey)return void e.$apply(function(){c.goPrevious()});if(!c.questionFinished&&!c.examFinished){if(n.ctrlKey&&n.altKey){var a=-1,i=!1,s=0;switch(n.key){case"g":a=0,i=c.isHelpReduceSelection,s=c.reduceSelectionCost;break;case"t":a=1,i=c.isHelpIncreaseTime,s=c.increaseTimeCost;break;case"s":a=2,i=c.isHelpAnswerLater,s=c.answerLaterCost;break;case"i":a=3,i=c.isHelpSaveTime,s=c.saveTimeCost;break;case"x":a=4,i=c.isHelpTime,s=0}return void(a!=-1&&e.$apply(function(){c.doHelp(a,i,s)}))}var r=null,o=null,u=!1;n.key>="1"&&n.key<="9"?(r=parseInt(n.key),u=!0):r=parseInt(n.key,36)-9;for(var l=c.answers.length,d=0;d<l;d++)if(c.answers[d].order==r){o=c.answers[d].id;break}null!=o&&e.$apply(function(){switch(c.questionType){case 0:c.selectedRadio=o;break;case 1:c.selectedCheckbox[o]=!c.selectedCheckbox[o];break;case 2:break;case 3:u?c.selectMatch(o,null):c.selectAnswer(r,null)}})}}),e.$on("keyup",function(t,n){e.$apply(function(){c.pressingCtrlAlt=!1})})}]),mainApp.controller("confirmExportCtrl",["$scope","$uibModalInstance","userData",function(e,t,n){var a=this;a.coin=n.coin,a.exportFee=n.exportFee,a.agree=function(e){t.close(e)}}]),mainApp.controller("deleteAllUserExamCtrl",["$scope","$uibModalInstance","StatisticService","exam",function(e,t,n,a){var i=this;i.examId=a.examId,i.password=null,i.message="",i.cancel=function(){t.close(!1)},i.changePassword=function(){i.message=""},i.deleting=!1,i["delete"]=function(){null==i.password||i.password.length<8||(i.deleting=!0,n.deleteAllUserExam({examId:i.examId},{password:i.password},function(e){i.deleting=!1,e.success?t.close(!0):i.message=e.message},function(e){i.deleting=!1}))}}]),mainApp.controller("deleteUserExamCtrl",["$scope","$uibModalInstance","StatisticService","userExam",function(e,t,n,a){var i=this;i.examId=a.examId,i.user=a.user,i.message="",i.cancel=function(){t.close(!1)},i.deleting=!1,i["delete"]=function(){i.deleting=!0,n.deleteUserExam({examId:i.examId,userId:i.user.id},{},function(e){i.deleting=!1,e.success?t.close(!0):i.message=e.message},function(e){i.deleting=!1})}}]),mainApp.controller("modifyMarkCtrl",["$scope","$uibModalInstance","StatisticService","question",function(e,t,n,a){var i=this;i.question=a,i.newMark=0,i.message="",i.cancel=function(){t.close({updated:!1})},i.validMark=!1,i.update=function(e){i.validMark=e},i.modifying=!1,i.finish=function(){if(i.validMark){i.modifying=!0,i.newMark=Math.round(1e3*i.newMark)/1e3;var e={userId:i.question.userId,questionId:i.question.questionId,currentMark:1*i.question.currentMark,newMark:i.newMark};n.updateMark({examId:i.question.examId},e,function(e){i.modifying=!1,e.success?t.close({updated:!0,newMark:i.newMark}):i.message=e.message},function(e){i.modifying=!1})}}}]),mainApp.controller("refreshUserExamCtrl",["$scope","$uibModalInstance","StatisticService","userExam",function(e,t,n,a){var i=this;i.examId=a.examId,i.user=a.user,i.message="",i.cancel=function(){t.close({refreshed:!1})},i.refreshing=!1,i.refresh=function(){i.refreshing=!0,n.refreshUserExam({examId:i.examId,userId:i.user.id},{},function(e){i.refreshing=!1,e.success?t.close({refreshed:!0}):i.message=e.message},function(e){i.refreshing=!1})}}]),mainApp.controller("resultCtrl",["$scope","$timeout","$window","$location","$sce","$uibModal","Fullscreen","StatisticService",function(e,t,n,a,i,s,r,o){var c=this;c.display="general",c.displayQuestion=0,c.numFinishedUsers=null,c.init=function(e){if(c.creatorId=e.creatorId,c.examId=e.examId,c.coin=e.coin,c.exportFee=e.exportFee,c.exportPaid=!1,c.exportDate=null,c.timezone=e.timezone,null!=e.statistic&&(c.exportLink=e.statistic.export_link,c.shortedExportLink=c.exportLink.length>0?Math.random().toString(36).substring(7)+"/"+c.exportLink.split("/").pop():"",null!=e.statistic.export_paid_date)){var n=moment.tz(e.statistic.export_paid_date,c.timezone);c.exportDate=n.format("DD/MM/YYYY");var i=moment({hour:0}).tz(c.timezone),s=i.diff(n,"days");c.exportPaid=0==s&&e.statistic.export_paid}var r=a.hash();"general"!=r&&"question"!=r&&"time"!=r&&"scoreboard"!=r&&"export"!=r||c.changeDisplayPage(r),c.initResultChart(),c.loadStatisticData(e),t(c.loadExamContent),t(c.loadUserData)},c.correctChart=null,c.colors=["#45b7cd","#ff6384","#ff8e72"],c.initResultChart=function(){c.correctChart={labels:["Đúng","Sai"],colors:["#82C00B","#d40000"],data:[]},c.scoreRangeLabel=[],c.scoreRangeData=[],c.datasetOverride=[{label:"Số người",borderWidth:1,type:"bar"},{label:"Miền",borderWidth:3,hoverBackgroundColor:"rgba(255,99,132,0.4)",hoverBorderColor:"rgba(255,99,132,1)",type:"line"}]},c.loadStatisticData=function(e){null==e.statistic?t(c.analysisExam):(c.displayStatisticData(e.statistic),t(c.analysisExam()))},c.updatedAt=null,c.displayStatisticData=function(e){if(c.numFinishedUsers=e.num_finished_users,0==e.num_finished_users)c.correctChart.data=[],c.scoreRangeLabel=[],c.scoreRangeData=[],c.numCorrectPerQuestion=[],c.numDoPerQuestion=[],c.numSelectionPerAnswer=[],c.userTimerPerQuestion=[];else{c.correctChart.data=[e.correct_percent,100-e.correct_percent],c.scoreRangeLabel=angular.fromJson(e.score_range_label);var t=angular.fromJson(e.score_range_data);c.scoreRangeData=[t,t],c.numCorrectPerQuestion=angular.fromJson(e.num_correct_per_question),c.numDoPerQuestion=angular.fromJson(e.num_do_per_question),c.numSelectionPerAnswer=angular.fromJson(e.num_selection_per_answer),c.userTimerPerQuestion=angular.fromJson(e.consumed_time_per_question)}c.updatedAt=e.updated_at},c.analyzingExam=!1,c.analysisExam=function(){1!=c.analyzingExam&&(c.analyzingExam=!0,o.analysis({examId:c.examId},function(e){e.success&&c.displayStatisticData(e.statistic),c.analyzingExam=!1},function(e){c.analyzingExam=!1}))},c.loadExamContentService=null,c.loadingExamContent=!1,c.examData=null,c.loadExamContent=function(){1!=c.loadingExamContent&&(c.loadingExamContent=!0,c.loadExamContentService=o.loadExamContent({examId:c.examId},function(e){e.success&&(c.examData=e.content,c.timerPerQuestion=e.timePerQuestion),c.loadingExamContent=!1},function(e){c.loadingExamContent=!1}))},c.loadUsersDataService=null,c.usersData=[],c.currentUsersDataPage=0,c.nextPageUrl=null,c.loadingUsersData=!1,c.loadUserData=function(){1==c.loadingUsersData||null==c.nextPageUrl&&0!=c.currentUsersDataPage||(c.loadingUsersData=!0,c.loadUsersDataService=o.loadUsersData({examId:c.examId,page:c.currentUsersDataPage+1},function(e){e.success&&c.currentUsersDataPage+1==e.results.current_page&&(e.results.data.length>0&&(c.usersData=c.usersData.concat(e.results.data)),c.currentUsersDataPage++,c.nextPageUrl=e.results.next_page_url),c.loadingUsersData=!1},function(e){c.loadingUsersData=!1}))},c.doAnalysisExamAgain=function(){c.analyzingExam||c.loadingUsersData||c.loadingExamContent||(c.analysisExam(),c.viewedTimeQuestions=[],c.viewedStatisticQuestions=[],c.examData=null,c.loadExamContent(),c.viewedDetailScoreboards=[],c.viewedScoreboards=[],c.currentUser=null,c.usersData=[],c.currentUsersDataPage=0,c.nextPageUrl=null,c.loadUserData())},c.viewedStatisticQuestions=[],c.displayMoreQuestion=function(){if(!(c.viewedStatisticQuestions.length>=c.examData.items.length))for(var e=Math.min(c.viewedStatisticQuestions.length+40,c.examData.items.length),t=c.viewedStatisticQuestions.length;t<e;t++)c.viewedStatisticQuestions.push(c.examData.items[t])},c.viewedTimeQuestions=[],c.displayMoreQuestionTime=function(){if(!(c.viewedTimeQuestions.length>=c.examData.items.length))for(var e=Math.min(c.viewedTimeQuestions.length+20,c.examData.items.length),t=c.viewedTimeQuestions.length;t<e;t++)c.viewedTimeQuestions.push(c.examData.items[t])},c.viewedScoreboards=[],c.displayMoreScoreboard=function(){if(c.viewedScoreboards.length+40>=c.usersData.length&&c.loadUserData(),!(c.viewedScoreboards.length>=c.usersData.length)){for(var e=Math.min(c.viewedScoreboards.length+20,c.usersData.length),t=-1,n=c.viewedScoreboards.length;n<e;n++)c.usersData[n].id!=c.creatorId?c.viewedScoreboards.push(c.usersData[n]):t=n;t!=-1&&c.usersData.splice(t,1)}},c.viewedDetailScoreboards=[],c.displayMoreScoreboardDetail=function(){if(!(c.viewedDetailScoreboards.length>=c.examData.items.length))for(var e=Math.min(c.viewedDetailScoreboards.length+20,c.examData.items.length),t=c.viewedDetailScoreboards.length;t<e;t++)c.viewedDetailScoreboards.push(c.examData.items[t])},c.getCorrectPercentOnQuestion=function(e){return null!=c.numDoPerQuestion&&null!=c.numCorrectPerQuestion&&angular.isDefined(c.numDoPerQuestion[e])&&angular.isDefined(c.numCorrectPerQuestion[e])&&0!=c.numDoPerQuestion[e]?(1*(c.numCorrectPerQuestion[e]/c.numDoPerQuestion[e]*100).toFixed(2)).toString():0},c.getNumberCorrectOnQuestion=function(e){return null!=c.numCorrectPerQuestion&&angular.isDefined(c.numCorrectPerQuestion[e])?c.numCorrectPerQuestion[e]:0},c.getNumberIncorrectOnQuestion=function(e){return null!=c.numDoPerQuestion&&angular.isDefined(c.numDoPerQuestion[e])?null!=c.numCorrectPerQuestion&&angular.isDefined(c.numCorrectPerQuestion[e])?c.numDoPerQuestion[e]-c.numCorrectPerQuestion[e]:c.numDoPerQuestion[e]:0},c.displayAnswerDescription=function(e,t){var n="",a=e.is_right?"checked":"",s=e.is_right?'style="color:#14c508; font-weight: 500;"':"";switch(t){case 0:n='<div class="form-check" '+s+'><label class="form-check-label"><input type="radio" class="form-check-input" name="'+e.id+'" '+a+" disabled> "+e.description+"</label></div>";break;case 1:n='<div class="form-check"'+s+'><label class="form-check-label"><input type="checkbox" class="form-check-input" name="'+e.id+'" '+a+" disabled> "+e.description+"</label></div>";break;case 2:n="<div>"+e.description+"</div>";break;case 3:n='<div class="row"><div class="col-5"><div>'+e.description+'</div></div><div class="col-2"><hr></div><div class="col-5"><div>'+e.match+"</div></div></div>";break;default:n=e.description}return i.trustAsHtml(n)},c.getSelectionPercentAnswer=function(e,t){return null!=c.numSelectionPerAnswer&&null!=c.numDoPerQuestion&&angular.isDefined(c.numSelectionPerAnswer[e])&&angular.isDefined(c.numDoPerQuestion[t])?(1*(c.numSelectionPerAnswer[e]/c.numDoPerQuestion[t]*100).toFixed(2)).toString():0},c.getNumberSelectionAnswer=function(e){return null!=c.numSelectionPerAnswer&&angular.isDefined(c.numSelectionPerAnswer[e])?c.numSelectionPerAnswer[e]:0},c.getTimePercentOnQuestion=function(e){return null!=c.timerPerQuestion&&null!=c.userTimerPerQuestion&&null!=c.numDoPerQuestion&&angular.isDefined(c.userTimerPerQuestion[e])&&angular.isDefined(c.timerPerQuestion[e])&&c.timerPerQuestion[e]>0&&angular.isDefined(c.numDoPerQuestion[e])&&c.numDoPerQuestion[e]>0?c.userTimerPerQuestion[e]/(c.numDoPerQuestion[e]*c.timerPerQuestion[e])*100:0},c.getTimeOnQuestion=function(e){return null!=c.numDoPerQuestion&&null!=c.userTimerPerQuestion&&angular.isDefined(c.userTimerPerQuestion[e])&&angular.isDefined(c.numDoPerQuestion[e])&&c.numDoPerQuestion[e]>0?Math.round(c.userTimerPerQuestion[e]/c.numDoPerQuestion[e])+" giây":"-"},c.scrollPosCache={},c.changeDisplayPage=function(e){c.scrollPosCache[c.display]=[n.pageXOffset,n.pageYOffset],c.display=e,a.hash(e),t(function(){c.updateWindowScroll(e)})},c.getUserMarkOnQuestion=function(e){return(1*c.currentUser.questionsMark[e]).toString()},c.displayUserAnswerDescription=function(e,t){var n="",a=e.is_right?"checked":"",s=e.is_right?'style="color:#14c508; font-weight: 500;"':"";switch(t){case 0:n='<div class="form-check" '+s+'><label class="form-check-label"><input type="radio" class="form-check-input" name="'+e.id+'" '+a+" disabled> "+e.description+"</label></div>";break;case 1:n='<div class="form-check"'+s+'><label class="form-check-label"><input type="checkbox" class="form-check-input" name="'+e.id+'" '+a+" disabled> "+e.description+"</label></div>";break;case 2:n="<div>"+e.description+"</div>";break;case 3:n='<div class="row"><div class="col-9"><div>'+e.description+'</div></div><div class="col-3"><hr></div></div>';break;default:n=e.description}return i.trustAsHtml(n)},c.currentUser=null,c.loadUserDetailService=null,c.loadingUserDetail=!1,c.displayUserDetail=function(e){c.currentUser=e,c.scoreboardView="scoreboard-detail",c.currentUser.loadDetail?t(function(){c.updateWindowScroll("scoreboard")}):(c.loadingUserDetail=!0,c.loadUserDetailService=o.loadUserDetail({examId:c.examId,userId:e.id},function(e){c.loadingUserDetail=!1,e.success&&(c.currentUser.loadDetail=!0,c.currentUser.questionsMark=e.user.questionsMark,c.currentUser.answers=e.user.answers,n.scrollTo(0,0),t(function(){c.updateWindowScroll("scoreboard")}))},function(e){c.loadingUserDetail=!1}))},c.deleteUserExam=function(e,t){var n=s.open({animation:!0,templateUrl:"deleteUserExamModal.html",controller:"deleteUserExamCtrl",controllerAs:"deleteUserExamVm",keyboard:!0,resolve:{userExam:function(){return{examId:c.examId,user:t}}}});n.result.then(function(t){t&&(c.usersData.splice(e,1),c.viewedScoreboards.splice(e,1))})},c.refreshUserExam=function(e,t){if(null!=t.pivot.begin_time){var n=s.open({animation:!0,templateUrl:"refreshUserExamModal.html",controller:"refreshUserExamCtrl",controllerAs:"refreshUserExamVm",keyboard:!0,resolve:{userExam:function(){return{examId:c.examId,userIndex:e,user:t}}}});n.result.then(function(t){t.refreshed&&(c.usersData[e].loadDetail=!1,c.usersData[e].pivot.score=0,c.usersData[e].pivot.begin_time=null,c.usersData[e].pivot.consumed_time=0,c.usersData[e].pivot.number_correct=0,c.usersData[e].pivot.finished=!1,delete c.usersData[e].questionsMark,delete c.usersData[e].answers,c.viewedScoreboards[e].loadDetail=!1,c.viewedScoreboards[e].pivot.score=0,c.viewedScoreboards[e].pivot.begin_time=null,c.viewedScoreboards[e].pivot.consumed_time=0,c.viewedScoreboards[e].pivot.number_correct=0,c.viewedScoreboards[e].pivot.finished=!1,delete c.viewedScoreboards[e].questionsMark,delete c.viewedScoreboards[e].answers)})}},c.terminateUserExam=function(e,t){if(!t.pivot.finished){var n=s.open({animation:!0,templateUrl:"terminateUserExamModal.html",controller:"terminateUserExamCtrl",controllerAs:"terminateUserExamVm",keyboard:!0,resolve:{userExam:function(){return{examId:c.examId,user:t}}}});n.result.then(function(t){t.terminated&&(c.usersData[e].loadDetail=!1,c.usersData[e].pivot.score=t.data.score,c.usersData[e].pivot.begin_time=t.data.beginTime,c.usersData[e].pivot.consumed_time=t.data.consumedTime,c.usersData[e].pivot.number_correct=t.data.numberCorrect,c.usersData[e].pivot.finished=!0,delete c.usersData[e].questionsMark,delete c.usersData[e].answers,c.viewedScoreboards[e].loadDetail=!1,c.viewedScoreboards[e].pivot.score=t.data.score,c.viewedScoreboards[e].pivot.begin_time=t.data.beginTime,c.viewedScoreboards[e].pivot.consumed_time=t.data.consumedTime,c.viewedScoreboards[e].pivot.number_correct=t.data.numberCorrect,c.viewedScoreboards[e].pivot.finished=!0,delete c.viewedScoreboards[e].questionsMark,delete c.viewedScoreboards[e].answers)})}},c.deletingAllUserExam=!1,c.deleteAllUserExam=function(){c.deletingAllUserExam=!0;var e=s.open({animation:!0,templateUrl:"deleteAllUserExamModal.html",controller:"deleteAllUserExamCtrl",controllerAs:"deleteAllUserExamVm",keyboard:!0,resolve:{exam:function(){return{examId:c.examId}}}});e.result.then(function(e){e&&(c.usersData=[],c.viewedScoreboards=[]),c.deletingAllUserExam=!1})},c.scoreboardView="scoreboard-list",c.displayScoreboard=function(e){c.scoreboardView=e,t(function(){c.updateWindowScroll("scoreboard")})},c.displayUserAnswerSelection=function(e,t){var n="-";switch(e.questionType){case 0:c.currentUser.answers[e.questionId][t].pivot.is_selected&&(n='<i class="fa fa-circle" aria-hidden="true"></i>');break;case 1:c.currentUser.answers[e.questionId][t].pivot.is_selected&&(n='<i class="fa fa-square" aria-hidden="true"></i>');break;case 2:null!=c.currentUser.answers[e.questionId][t].pivot.essay&&(n=c.currentUser.answers[e.questionId][t].pivot.essay);break;case 3:0!=c.currentUser.answers[e.questionId][t].pivot.match_id&&(n=c.currentUser.answers[e.questionId][t].match);break;default:n="-"}return i.trustAsHtml(n)},c.checkUserAnswer=function(e,t){var n="";switch(e.questionType){case 0:case 1:c.currentUser.answers[e.questionId][t].pivot.is_selected&&(n=c.currentUser.answers[e.questionId][t].correct?'<span class="text-success"><i class="fa fa-check" aria-hidden="true"></i></span>':'<span class="text-danger"><i class="fa fa-close" aria-hidden="true"></i></span>');break;case 2:null!=c.currentUser.answers[e.questionId][t].pivot.essay&&(n=c.currentUser.answers[e.questionId][t].correct?'<span class="text-success"><i class="fa fa-check" aria-hidden="true"></i></span>':'<span class="text-danger"><i class="fa fa-close" aria-hidden="true"></i></span>');break;case 3:0!=c.currentUser.answers[e.questionId][t].pivot.match_id&&(n=c.currentUser.answers[e.questionId][t].correct?'<span class="text-success"><i class="fa fa-check" aria-hidden="true"></i></span>':'<span class="text-danger"><i class="fa fa-close" aria-hidden="true"></i></span>');break;default:n=""}return i.trustAsHtml(n)},c.isFullScreen=!1,c.goFullScreen=function(){r.isEnabled()?(r.cancel(),c.isFullScreen=!1):(r.all(),c.isFullScreen=!0)},c.updateWindowScroll=function(e){switch(e){case"question":c.fixTableHeaderWhenScrollOut("question-table","fixed-question-table");break;case"time":c.fixTableHeaderWhenScrollOut("time-table","fixed-time-table");break;case"scoreboard":"scoreboard-list"==c.scoreboardView?c.fixTableHeaderWhenScrollOut("scoreboard-table","fixed-scoreboard-table"):c.fixTableHeaderWhenScrollOut("detail-scoreboard-table","fixed-detail-scoreboard-table")}var t=c.scrollPosCache[e]||[0,0];n.scrollTo(t[0],t[1])},c.fixTableHeaderWhenScrollOut=function(e,a){var i=document.querySelector("#"+e);if(null!=i){var s=angular.element(i),r=s.offset().top,o=angular.element(s[0].querySelector("thead")),u=angular.element(document.querySelector("#"+a)),l=u[0].querySelector("thead");null==l&&u.append(o.clone()),c.myWindow.off("scroll.fixHeader"),c.myWindow.on("scroll.fixHeader",function(){var e=n.pageYOffset+55;e>=r?(u.show(),t(function(){angular.forEach(o.find("tr > th"),function(e,t){var n=angular.element(e).outerWidth(),a=angular.element(e).css("padding");angular.element(u.find("tr > th")[t]).outerWidth(n).css("padding",a)})})):u.hide()})}},c.myWindow=angular.element(n),c.myWindow.on("resize",function(){c.myWindow.trigger("scroll"),e.$digest()}),e.$on("$locationChangeSuccess",function(e,t,n){t.split("#")[0]!=n.split("#")[0]&&(null!=c.loadExamContentService&&c.loadExamContentService.$cancelRequest(),null!=c.exportStatisticsService&&c.exportStatisticsService.$cancelRequest(),null!=c.loadUsersDataService&&c.loadUsersDataService.$cancelRequest(),null!=c.loadUserDetailService&&c.loadUserDetailService.$cancelRequest())}),c.modifyUserMark=function(e,t){if(c.currentUser.pivot.finished){var n=c.currentUser.questionsMark[t],a=s.open({animation:!0,templateUrl:"modifyMarkModal.html",controller:"modifyMarkCtrl",controllerAs:"modifyMarkVm",keyboard:!0,size:"sm",resolve:{question:function(){return{order:e,currentMark:n,examId:c.examId,userId:c.currentUser.id,questionId:t}}}});a.result.then(function(e){e.updated&&(c.currentUser.pivot.score=Math.max(0,c.currentUser.pivot.score-n+e.newMark),c.currentUser.questionsMark[t]=e.newMark)})}},c.exportLink="",c.shortedExportLink="",c.exportPaid=!1,c.exportMessage="",c.exportOptions={general:!0,question:!0,answer:!0,time:!0,scoreboard:!0,progress_bar:!1},c.exportFee=2,c.exporting=!1,c.exportStatisticsService=null,c.exportExcel=function(){if(!c.exporting&&!c.analyzingExam)if(c.coin<c.exportFee)c.exportMessage="Bạn không đủ xu để thực hiện";else if(c.exportPaid)c.doExport();else{var e=s.open({animation:!0,templateUrl:"confirmExportModal.html",controller:"confirmExportCtrl",controllerAs:"confirmExportVm",keyboard:!0,resolve:{userData:function(){return{coin:c.coin,exportFee:c.exportFee}}}});e.result.then(function(e){e&&c.doExport()})}},c.doExport=function(){c.exporting=!0,c.exportStatisticsService=o.exportStatistics({examId:c.examId},c.exportOptions,function(e){if(e.success){c.exportPaid=!0,c.coin=e.newCoin,c.exportLink=e.exportLink,c.shortedExportLink=e.exportLink.length>0?Math.random().toString(36).substring(7)+"/"+e.exportLink.split("/").pop():"";var t=moment({hour:0}).tz(c.timezone);
c.exportDate=t.format("DD/MM/YYYY")}else c.exportMessage=e.message;c.exporting=!1},function(e){c.exportMessage="Lỗi kết xuất",c.exporting=!1})}}]),mainApp.controller("terminateUserExamCtrl",["$scope","$uibModalInstance","StatisticService","userExam",function(e,t,n,a){var i=this;i.examId=a.examId,i.user=a.user,i.message="",i.cancel=function(){t.close({terminated:!1})},i.terminating=!1,i.terminate=function(){i.terminating=!0,n.terminateUserExam({examId:i.examId,userId:i.user.id},{},function(e){i.terminating=!1,e.success?t.close({terminated:!0,data:e.data}):i.message=e.message},function(e){i.terminating=!1})}}]),angular.element(document).ready(function(){angular.bootstrap(document,["mainApp"])});